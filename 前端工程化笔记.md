# å‰ç«¯å·¥ç¨‹åŒ–ç¬”è®°



## Monorepo

##### ä¸€äº›èµ„æ–™

[monorepo.tools](https://monorepo.tools)



##### Multi-Repo çš„ç¼ºç‚¹

- è·¨ä»“åº“å¼€å‘ï¼šå¤šä»“ç»´æŠ¤æˆæœ¬é«˜
- å¼€å‘è°ƒè¯•ï¼šnpmåŒ…ï¼ˆä¿®æ”¹ -> å‘å¸ƒ -> å®‰è£… æˆæœ¬é«˜ï¼‰ï¼Œè°ƒè¯•éº»çƒ¦ ( npm link )ï¼Œ
- ç‰ˆæœ¬ç®¡ç†ï¼šä¾èµ–ç‰ˆæœ¬åŒæ­¥å‡çº§ç®¡ç†éº»çƒ¦
- é¡¹ç›®åŸºå»ºï¼šè„šæ‰‹æ¶å‡çº§ï¼Œæ–°è€é¡¹ç›®è§„èŒƒå¾ˆéš¾ä¿è¯ç»Ÿä¸€

##### Monorepo é¡¹ç›®ç›®å½•ç»“æ„

```
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ module1/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ module2/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ shared/
â”‚       â”œâ”€â”€ src/
â”‚       â”œâ”€â”€ tests/
â”‚       â”œâ”€â”€ package.json
â”‚       â””â”€â”€ ...
â”œâ”€â”€ libs/
â”‚   â”œâ”€â”€ lib1/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â”œâ”€â”€ lib2/
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ tests/
â”‚   â”‚   â”œâ”€â”€ package.json
â”‚   â”‚   â””â”€â”€ ...
â”‚   â””â”€â”€ ...
â”œâ”€â”€ docs/
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json
â””â”€â”€ ...
```

> ğŸ’¡ å…¶ä¸­ lib é€‚ç”¨äºå‘åŒ…çš„ï¼Œå³ utils lib

> ğŸ’¡ å…³äº monorepo çš„é¡¹ç›®ç›®å½•ç»“æ„å¯ä»¥çœ‹ä¸‹ [Github - babel](https://github.com/babel/babel) çš„ç›®å½•ç»“æ„ã€‚
>
> > éšç€å‰ç«¯å·¥ç¨‹çš„æ—¥ç›Šå¤æ‚ï¼Œè¶Šæ¥è¶Šå¤šçš„é¡¹ç›®å¼€å§‹ä½¿ç”¨ monorepoã€‚ä¹‹å‰å¯¹äºå¤šä¸ªé¡¹ç›®çš„ç®¡ç†ï¼Œæˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯ä½¿ç”¨å¤šä¸ª git ä»“åº“ï¼Œä½† monorepo çš„å®—æ—¨å°±æ˜¯ç”¨ä¸€ä¸ª git ä»“åº“æ¥ç®¡ç†å¤šä¸ªå­é¡¹ç›®ï¼Œæ‰€æœ‰çš„å­é¡¹ç›®éƒ½å­˜æ”¾åœ¨æ ¹ç›®å½•çš„ packages ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆä¸€ä¸ªå­é¡¹ç›®å°±ä»£è¡¨ä¸€ä¸ª packageã€‚å¦‚æœä½ ä¹‹å‰æ²¡æ¥è§¦è¿‡ monorepo çš„æ¦‚å¿µï¼Œå»ºè®®ä»”ç»†çœ‹çœ‹è¿™ç¯‡æ–‡ç«  [What Is a Monorepo?](https://www.perforce.com/blog/vcs/what-monorepo)ï¼Œä»¥åŠå¼€æºçš„ monorepo ç®¡ç†å·¥å…· [lerna](https://github.com/lerna/lerna)ï¼Œé¡¹ç›®ç›®å½•ç»“æ„å¯ä»¥å‚è€ƒä¸€ä¸‹ [babel](https://github.com/babel/babel) ä»“åº“ã€‚
> >
> > æ‘˜è‡ªï¼š[å…³äºç°ä»£åŒ…ç®¡ç†å™¨çš„æ·±åº¦æ€è€ƒâ€”â€”ä¸ºä»€ä¹ˆç°åœ¨æˆ‘æ›´æ¨è pnpm è€Œä¸æ˜¯ npm/yarn?](https://juejin.cn/post/6932046455733485575)

##### Monorepo é¡¹ç›®é—´ä»£ç å¦‚ä½•å…±äº«ï¼Ÿ

ä¸¾ä¸ªä¾‹å­ï¼š

å‡è®¾ lib çš„åŒ…åä¸º `@my-scope/lib` ï¼Œæ— éœ€å‘åŒ…è‡³ npmã€‚

åœ¨ä¸€çº§ç›®å½•çš„ package.json æ·»åŠ åŒ…å `@my-scope/lib: "workspace:*"` ã€‚

åœ¨ä¸¤ä¸ª projects ä¸­çš„ä»£ç ä¸­å¼•å…¥ï¼š

```js
import { method } from '@my-scope/lib';
```

##### ä½¿ç”¨ pnpm çš„ Monorepo å®æˆ˜

###### è®¾ç½®å­é¡¹ç›®ç›®å½•æ•°ç»„

åˆ›å»º Monorepo é¡¹ç›®åï¼Œåœ¨ `package.json` æ–‡ä»¶ä¸­æ·»åŠ ä¸€ä¸ª `workspaces` å­—æ®µï¼Œå¹¶è®¾ç½®ä¸ºä¸€ä¸ªåŒ…å«å­é¡¹ç›®ç›®å½•çš„æ•°ç»„ï¼›æ¯”å¦‚ï¼š

```json
"workspaces": [
  "packages/*"
]
```

> ğŸ’¡ è¿™é‡Œå¼€å§‹ä»¥ä¸ºä½œè€…æé”™äº†ï¼Œæ¯•ç«Ÿ vue3 æ–‡æ¡£ä¸­åœ¨ `pnpm-workspace.yaml` ä¸­æœ‰å¦‚ä¸‹å®šä¹‰ï¼š
>
> ```yaml
> packages:
>   - 'packages/*'
> ```
>
> ä»¥ä¸ºä½œè€…æé”™äº†ã€‚ä½†çœ‹äº†ä¸‹ [npm v9 - package.json # workspaces](https://docs.npmjs.com/cli/v9/configuring-npm/package-json#workspaces) çš„å†…å®¹ï¼Œå‘ç°ç¡®å®æœ‰è¿™ä¸ªè®¾ç½®ã€‚
>
> > ###### workspaces
> >
> > The optional `workspaces` field is an array of file patterns that describes locations within the local file system that the install client should look up to find each [workspace](https://docs.npmjs.com/cli/v9/using-npm/workspaces) that needs to be symlinked to the top level `node_modules` folder.
> >
> > It can describe either the direct paths of the folders to be used as workspaces or it can define globs that will resolve to these same folders.
> >
> > In the following example, all folders located inside the folder `./packages` will be treated as workspaces as long as they have valid `package.json` files inside them:
> >
> > ```json
> > {
> >     "name": "workspace-example",
> >     "workspaces": [
> >       "./packages/*"
> >     ]
> > }
> > ```
> >
> > See [`workspaces`](https://docs.npmjs.com/cli/v9/using-npm/workspaces) for more examples.
>
> åŒæ—¶é—®äº†ä¸‹ gpt ï¼šâ€œåœ¨ `package.json` ä¸­è®¾ç½® `workspaces` å’Œ åœ¨ `pnpm-workspace.yaml` ä¸­è®¾ç½® `packages` æ˜¯å¦å­˜åœ¨åŒºåˆ«ï¼Ÿâ€
>
> <img src="https://s2.loli.net/2023/05/29/sU1pQTHG5qWSzDh.png" alt="image-20230529181659686" style="zoom:50%;" />

æ–°å»ºä¸¤ä¸ªé¡¹ç›®ï¼ˆæ¯”å¦‚è¯´æ˜¯ vue é¡¹ç›®ï¼‰ï¼Œåœ¨æ¯ä¸ªå­é¡¹ç›®çš„ç›®å½•ä¸‹ï¼Œéƒ½æœ‰ä¸€ä¸ªç‹¬ç«‹ `package.json` æ–‡ä»¶

åœ¨ Monorepo é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹è¿è¡Œ `pnpm install` å‘½ä»¤ï¼Œå°†ä¼šä¸ºæ‰€æœ‰å·¥ä½œç©ºé—´è‡ªåŠ¨å®‰è£…ä¾èµ–

###### å®‰è£…å…¬å…±ä¾èµ–åŒ…

ä½¿ç”¨ `-w` é€‰é¡¹

```sh
pnpm install react -w
pnpm install rollup -wD # å®‰è£…å¼€å‘ä¾èµ–
```

> ğŸ’¡æ ¹æ® [pnpm doc - `pnpm add <pkg>`](https://pnpm.io/zh/cli/add) çš„è¯´æ³•ï¼Œ`-w` æ˜¯ `--ignore-workspace-root-check`
>
> > ##### `--ignore-workspace-root-check`
> >
> > é™¤éä½¿ç”¨ `--ignore-workspace-root-check` æˆ– `-w` æ¥æ ‡è®°ï¼Œå¦åˆ™åœ¨ root workspace åŒ…æ·»åŠ ä¾èµ–é¡¹æ—¶ä¼šå¤±è´¥ã€‚ä¾‹å¦‚ï¼Œ `pnpm add debug -w`
>
> ğŸ’¡ æ ¹æ®æ–‡æ¡£æ‰€è¯´ï¼Œä¾èµ–å®‰è£…æ—¶é»˜è®¤æ˜¯æ— æ³•ä»¥ â€œMonorepo å…¨å±€â€ å±‚çº§å®‰è£…çš„

###### ç»™æŸä¸ªå­é¡¹ç›®å•ç‹¬å®‰è£…æŒ‡å®šä¾èµ–

ä½¿ç”¨ `--filter` é€‰é¡¹ï¼Œå¯è§ [[#pnpm è¿‡æ»¤ `--filter`]]

```sh
pnpm add axios --filter @package1
```

###### æ¨¡å—ä¹‹é—´çš„ç›¸äº’ä¾èµ–

```sh
pnpm install @package2 -r --filter @package1
```

åœ¨è®¾ç½®ä¾èµ–ç‰ˆæœ¬çš„æ—¶å€™æ¨èç”¨ `workspace:*` ï¼Œè¿™æ ·å°±å¯ä»¥ä¿æŒä¾èµ–çš„ç‰ˆæœ¬æ˜¯å·¥ä½œç©ºé—´é‡Œæœ€æ–°ç‰ˆæœ¬ï¼Œä¸éœ€è¦æ¯æ¬¡æ‰‹åŠ¨æ›´æ–°ä¾èµ–ç‰ˆæœ¬ã€‚

##### pnpm Monorepo ä¼˜ç¼ºç‚¹

###### ä¼˜ç‚¹

- å¤©ç„¶æ”¯æŒ Monorepoï¼ˆåœ¨æ ¹ç›®å½•ç»™æ‰€æœ‰ç©ºé—´å®‰è£…ä¾èµ–ã€åœ¨æ ¹ç›®å½•å•ç‹¬ç»™å­åŒ…å®‰è£…ä¾èµ–ï¼‰

###### ç¼ºç‚¹

- éœ€è¦æ‰‹åŠ¨æå‡å…¬å…±ä¾èµ–

- éœ€è¦æ‰‹åŠ¨æŒ‡å®šä»»åŠ¡ ( dev, build ) æ‰§è¡Œï¼Œä»»åŠ¡ä¸æ”¯æŒå¹¶è¡Œæ‰§è¡Œï¼Œå½±å“æ„å»ºé€Ÿåº¦

- ä¸æ”¯æŒè‡ªåŠ¨ç‰ˆæœ¬æ§åˆ¶ï¼Œéœ€è¦ä¾èµ–ç¬¬ä¸‰æ–¹å·¥å…·ï¼Œå®˜æ–¹æ¨èä¸¤ä¸ªå·¥å…· [changesets](https://github.com/changesets/changesets)ã€[Rush](https://rushjs.io)

- æ²¡æœ‰é€šç”¨çš„è„šæ‰‹æ¶æ¨¡æ¿

- ä¸æ”¯æŒç¼“å­˜

- ä¸æ”¯æŒä¾èµ–åˆ†æ

> ğŸ‘€ è¿™é‡Œåé¢è¿˜ä»‹ç»äº† Lerna å’Œ Turborepo çš„ä½¿ç”¨æ–¹æ³•å’Œä¼˜ç¼ºç‚¹ï¼Œç”±äºä»‹ç»çš„æœ‰ç‚¹æ··ä¹±ï¼Œä¸”ä¸ä½“ç³»ï¼›è¿™é‡Œä¸åšæ‘˜æŠ„ï¼Œæœ‰æ—¶é—´çš„è¯è¿˜æ˜¯ä¸“é—¨å»äº†è§£ä¸€ä¸‹è¿™ä¸¤ä¸ªå·¥å…·ã€‚

æ‘˜è‡ªï¼š[åˆè¯†Monorepo](https://juejin.cn/post/7237145375311839289)



## å¾®å‰ç«¯

// TODO

[ç†è§£å¾®å‰ç«¯](https://mdnice.com/writing/4cf8361de47d43d887982a755445edd1) ï¼šå·²ç»çœ‹å®Œï¼Œæ„Ÿè§‰å¾ˆä¸é”™ï¼Œä¹Ÿæ¶‰åŠäº†å’Œ component islands pattern çš„æ¯”è¾ƒ

[mirco-frontends å®˜ç½‘](https://micro-frontends.org)

[martin fowler - Micro Frontends](https://martinfowler.com/articles/micro-frontends.html)



## pnpm



##### Mac homebrew pnpm æ›´æ–°é—®é¢˜

ä½¿ç”¨ Mac ä¸Šçš„ homebrew æ›´æ–° pnpm ï¼Œç›®å‰å·²ç»é‡åˆ°ä¸¤æ¬¡ï¼Œè™½ç„¶ `brew upgrade pnpm` å·²ç»å°† pnpm å®‰è£…åˆ°äº†æœ€æ–°ç‰ˆï¼ˆ brew æç¤º pnpm å·²ç»å®‰è£…äº†æœ€æ–°çš„ç‰ˆæœ¬ï¼‰ï¼Œä½†æ˜¯ `pnpm -v` æ˜¾ç¤ºè¿˜æ˜¯åœç•™åœ¨ä¸Šä¸€ä¸ªå¤§ç‰ˆæœ¬ä¸­ã€‚

###### è§£å†³æ–¹æ³•

```sh
brew link --overwrite pnpm
```



#### `pnpm env <cmd>`

ç®¡ç† Node.js ç¯å¢ƒã€‚ğŸ’¡ ç±»ä¼¼äº nvm å’Œ n ç­‰åŒ…ç®¡ç†å·¥å…·

##### å‘½ä»¤è¡Œ

å®‰è£…å¹¶ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„ Node.jsã€‚

###### å®‰è£… LTS ç‰ˆæœ¬çš„ Node.js

```bash
pnpm env use --global lts
pnpm env use --global argon
```

###### å®‰è£… v16 çš„Node.js

```bash
pnpm env use --global 16
```

###### å®‰è£… Node.js çš„é¢„å‘è¡Œç‰ˆæœ¬

```bash
pnpm env use --global nightly
pnpm env use --global rc
pnpm env use --global 16.0.0-rc.0
pnpm env use --global rc/14
```

###### å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Node.js

```bash
pnpm env use --global latest
```

##### é…ç½®é¡¹

- `--global` , `-g`ï¼šæ­¤æ›´æ”¹å°†å…¨å±€ç”Ÿæ•ˆã€‚

æ‘˜è‡ªï¼š[pnpm doc - `pnpm env <cmd>`](https://pnpm.io/zh/cli/env)



#### Workspace

pnpm has <font color=dodgerBlue>built-in support for monorepositories</font>ï¼ˆğŸ‘€ å³ monorepo ï¼‰ï¼ŒYou can <font color=red>create a workspace to unite multiple projects inside a single repository</font>.

<font color=red>A workspace **must** have a [`pnpm-workspace.yaml`](https://pnpm.io/pnpm-workspace_yaml) file in its root</font>. A workspace also <font color=LightSeaGreen>**may** have an `.npmrc` in its root</font>.

##### Workspace protocol ( `workspace:` )

<font color=dodgerBlue>**By default**</font>, <font color=red>pnpm will **link packages from the workspace**</font> <font color=LightSeaGreen>if the available packages match the declared ranges</font>. For instance, <font color=red>`foo@1.0.0` is linked into `bar`Â **if `bar` has `"foo": "^1.0.0"` in its dependencies**</font> and <font color=fuchsia>`foo@1.0.0` is in the workspace</font>. However, if `bar` has `"foo": "2.0.0"` in dependencies and <font color=dodgerBlue>**`foo@2.0.0` is not in the workspace**</font>, `foo@2.0.0` will be installed from the registryï¼ˆğŸ‘€ æ³¨æ„ä¸ä¸‹é¢ workspace çš„è¡Œä¸ºå¯¹æ¯”ï¼‰. This behavior introduces some uncertaintyï¼ˆğŸŒ è¯¥è¡Œä¸ºå°†ä¼šå¼•å…¥ä¸ç¡®å®šæ€§ï¼‰.

Luckily, <font color=red>**pnpm supports the `workspace:` protocol**</font>. <font color=dodgerBlue>When this protocol is used</font>, <font color=fuchsia>pnpm will **refuse to resolve to anything other than a local workspace package**</font>. So, <font color=dodgerBlue>**if you set `"foo": "workspace:2.0.0"`**</font> , <font color=fuchsia>**this time installation will fail** because `"foo@2.0.0"` isn't present in the workspace</font>.

This protocol is especially useful when the [link-workspace-packages](https://pnpm.io/npmrc#link-workspace-packages) option is set to `false` . <font color=dodgerBlue>In that case</font>, <font color=red>pnpm will only link packages from the workspace **if the `workspace:` protocol is used**</font>.

###### Referencing workspace packages through aliases

<font color=dodgerBlue>Let's say you have a package in the workspace named `foo`</font> . <font color=dodgerBlue>**Usually**</font>, <font color=red>you would reference it as `"foo": "workspace:*"`</font> .

If you want to use a different alias, the following syntax will work too: `"bar": "workspace:foo@*"` .

<font color=fuchsia>Before publish, **aliases are converted to regular aliased dependencies**</font>. The <font color=LightSeaGreen>above example will become: `"bar": "npm:foo@1.0.0"`</font> .

###### Referencing workspace packages through their relative path

In a workspace with 2 packages:

```text
+ packages
    + foo
    + bar
```

`bar` may have `foo` in its dependencies declared as `"foo": "workspace:../foo"` . Before publishing, these specs are converted to regular version specs supported by all package managers.

###### Publishing workspace packages

When a workspace package is packed into an archive (whether it's through `pnpm pack` or one of the publish commands like `pnpm publish` ), <font color=dodgerBlue>we **dynamically replace** any `workspace:` dependency by</font>:

- The corresponding version in the target workspace (if you use `workspace:*` , `workspace:~` , or `workspace:^` )
- The associated semver range (for any other range type)

So for example, if we have `foo` , `bar` , `qar` , `zoo` in the workspace and they all are at version `1.5.0` , the following:

```json
{
    "dependencies": {
        "foo": "workspace:*",
        "bar": "workspace:~",
        "qar": "workspace:^",
        "zoo": "workspace:^1.5.0"
    }
}
```

<font color=dodgerBlue>Will be transformed into:</font>

```json
{
    "dependencies": {
        "foo": "1.5.0",
        "bar": "~1.5.0",
        "qar": "^1.5.0",
        "zoo": "^1.5.0"
    }
}
```

This feature allows you to depend on your local workspace packages while <font color=fuchsia>still being able to publish the resulting packages to the remote registry without needing intermediary publish steps</font> - <font color=red>your consumers will be able to use your published workspaces as any other package</font>, still benefitting from the guarantees semver offers.

æ‘˜è‡ªï¼š[pnpm doc - Workspace](https://pnpm.io/workspaces#workspace-protocol-workspace)



#### pnpm è¿‡æ»¤ `--filter`

// TODO

[pnpm doc - Filtering](https://pnpm.io/zh/filtering)



#### å¹»å½±ä¾èµ–

[å¹»å½±ä¾èµ–ã€æ¸¡ä¸€æ•™è‚²ã€‘](https://www.bilibili.com/video/BV1UN4y1k7Ce)



## yarn

#### PnP

é€šè¿‡â€œæ²‰æµ¸å¼ç¿»è¯‘â€ GPT-4 ç¿»è¯‘æµè§ˆäº†ä¸€ä¸‹ https://classic.yarnpkg.com/en/docs/pnp/ çš„å†…å®¹ã€‚ä¸è¿‡ï¼Œæ„Ÿè§‰è‡ªå·±å¯¹äº pnpm çš„ç±»ä¼¼æœºåˆ¶å¹¶ä¸äº†è§£ï¼Œæ‰€ä»¥ PnP çœ‹èµ·æ¥ä¹Ÿæ˜¯æœ‰äº›å›°éš¾ï¼Œæœ‰ç©ºå¯ä»¥å†çœ‹ä¸€éï¼Œå¹¶åšä¸€ä¸‹ç¬”è®°...

å¦å¤–ï¼Œè¿˜æœ‰ [Yarn çš„ Plug'n'Play ç‰¹æ€§](https://loveky.github.io/2019/02/11/yarn-pnp/) ï¼Œçœ‹å®Œäº†æ„Ÿè§‰å¾ˆä¸é”™ï¼Œå®˜æ–¹æ–‡æ¡£çš„ä»‹ç»åç†è®ºï¼Œè¿™ç¯‡åå®è·µã€‚



## Babel

##### ä¸€äº›èµ„æ–™

- [Babel å®˜ç½‘](https://babel.dev)
- [babel-handbook](https://github.com/jamiebuilds/babel-handbook)

- [ç¥è¯´è¦æœ‰å…‰ - Babel æ’ä»¶é€šå…³ç§˜ç± ](https://juejin.cn/book/6946117847848321055/section) è¿™ä¹Ÿæ˜¯è¿™é‡Œ Babel ç¬”è®°çš„ä¸»è¦æ‘˜æŠ„



### ã€ŠBabel æ’ä»¶é€šå…³ç§˜ç±ã€‹ç¬”è®°



#### Babel ä»‹ç»

babel æ˜¯ JS çš„è½¬è¯‘å™¨ (  JavaScript Transpiler ) ğŸ‘€ è¯¦è§ [[#ç¼–è¯‘å™¨å’Œè½¬è¯‘å™¨]]

##### å‘½åæ¼”åŒ–

babel æœ€å¼€å§‹å« 6to5ï¼Œé¡¾åæ€ä¹‰æ˜¯ es6 è½¬ es5ï¼Œä½†æ˜¯åæ¥éšç€ es æ ‡å‡†çš„æ¼”è¿›ï¼Œæœ‰äº† es7ã€es8 ç­‰ï¼Œ 6to5 çš„åå­—å·²ç»ä¸åˆé€‚äº†ï¼Œæ‰€ä»¥æ”¹åä¸ºäº† babelã€‚

##### Babel çš„ä¸‰ç§ç”¨é€”

###### è½¬è¯‘ ES Nextã€TypeScriptã€Flow ç­‰åˆ°ç›®æ ‡ç¯å¢ƒæ”¯æŒçš„ js

è¿™ä¸ªæ˜¯<font color=red>æœ€å¸¸ç”¨çš„åŠŸèƒ½</font>ï¼Œç”¨æ¥æŠŠä»£ç ä¸­çš„ ES Next çš„æ–°çš„è¯­æ³•ã€TypeScript å’Œ Flow çš„è¯­æ³•è½¬æˆåŸºäºç›®æ ‡ç¯å¢ƒæ”¯æŒçš„è¯­æ³•çš„å®ç°ã€‚å¹¶ä¸”è¿˜å¯ä»¥æŠŠç›®æ ‡ç¯å¢ƒä¸æ”¯æŒçš„ api è¿›è¡Œ polyfillã€‚

> ğŸ’¡ è¿˜æœ‰ jsx çš„ç¼–è¯‘

<font color=red>babel7 æä¾›äº† `@babel/preset-env` çš„åŒ…</font>ï¼Œå¯ä»¥<font color=red>æŒ‡å®šç›®æ ‡ env æ¥æŒ‰éœ€è½¬æ¢ï¼Œè½¬æ¢æ›´åŠ çš„ç²¾å‡†ï¼Œäº§ç‰©æ›´å°</font>ã€‚

###### ä¸€äº›ç‰¹å®šç”¨é€”çš„ä»£ç è½¬æ¢

babel æ˜¯ä¸€ä¸ªè½¬è¯‘å™¨ï¼Œæš´éœ²äº†å¾ˆå¤š apiï¼Œç”¨è¿™äº› api å¯ä»¥å®Œæˆ<font color=red>ä»£ç åˆ° AST çš„è§£æã€è½¬æ¢ã€ä»¥åŠç›®æ ‡ä»£ç çš„ç”Ÿæˆ</font>ã€‚

<font color=dodgerBlue>å¼€å‘è€…å¯ä»¥ç”¨å®ƒæ¥å®Œæˆä¸€äº›ç‰¹å®šç”¨é€”çš„è½¬æ¢</font>ï¼Œæ¯”å¦‚<font color=red>å‡½æ•°æ’æ¡©</font>ï¼ˆ<font color=red>å‡½æ•°ä¸­è‡ªåŠ¨æ’å…¥ä¸€äº›ä»£ç </font>ï¼Œä¾‹å¦‚<font color=red>åŸ‹ç‚¹ä»£ç </font>ï¼‰ã€<font color=red>è‡ªåŠ¨å›½é™…åŒ–</font>ç­‰ã€‚<font color=LightSeaGreen>æµè¡Œçš„å°ç¨‹åºè½¬è¯‘å·¥å…· taroï¼Œå°±æ˜¯åŸºäº babel çš„ api æ¥å®ç°çš„</font>ã€‚

###### ä»£ç çš„é™æ€åˆ†æ

<font color=red>å¯¹ä»£ç è¿›è¡Œ parse ä¹‹åï¼Œä¼šç”Ÿæˆ ASTï¼Œé€šè¿‡ AST èƒ½å¤Ÿç†è§£ä»£ç ç»“æ„</font>ï¼Œé™¤äº†è½¬æ¢ AST å†æ‰“å°æˆç›®æ ‡ä»£ç ä¹‹å¤–ï¼Œä¹ŸåŒæ ·<font color=red>å¯ä»¥**ç”¨äºåˆ†æä»£ç çš„ä¿¡æ¯ï¼Œè¿›è¡Œä¸€äº›é™æ€æ£€æŸ¥**</font>ã€‚

- <font color=red>linter å·¥å…·</font>å°±æ˜¯åˆ†æ AST çš„ç»“æ„ï¼Œå¯¹ä»£ç è§„èŒƒè¿›è¡Œæ£€æŸ¥ã€‚
- <font color=LightSeaGreen>api æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆå·¥å…·</font>ï¼Œå¯ä»¥æå–æºç ä¸­çš„æ³¨é‡Šï¼Œç„¶åç”Ÿæˆæ–‡æ¡£ã€‚
- <font color=red>type checker</font> ä¼šæ ¹æ®ä» AST ä¸­æå–çš„æˆ–è€…æ¨å¯¼çš„ç±»å‹ä¿¡æ¯ï¼Œå¯¹ AST è¿›è¡Œç±»å‹æ˜¯å¦ä¸€è‡´çš„æ£€æŸ¥ï¼Œä»è€Œå‡å°‘è¿è¡Œæ—¶å› ç±»å‹å¯¼è‡´çš„é”™è¯¯ã€‚ğŸ‘€ æ¯”å¦‚ tsc
- <font color=red>å‹ç¼©æ··æ·†å·¥å…·</font>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åˆ†æä»£ç ç»“æ„ï¼Œè¿›è¡Œåˆ é™¤æ­»ä»£ç ã€å˜é‡åæ··æ·†ã€å¸¸é‡æŠ˜å ç­‰å„ç§ç¼–è¯‘ä¼˜åŒ–ï¼Œç”Ÿæˆä½“ç§¯æ›´å°ã€æ€§èƒ½æ›´ä¼˜çš„ä»£ç ã€‚
- JS è§£é‡Šå™¨ï¼Œé™¤äº†å¯¹ AST è¿›è¡Œå„ç§ä¿¡æ¯çš„æå–å’Œæ£€æŸ¥ä»¥å¤–ï¼Œæˆ‘ä»¬<font color=red>è¿˜å¯ä»¥ç›´æ¥è§£é‡Šæ‰§è¡Œ AST</font>ã€‚



#### Babel çš„ç¼–è¯‘æµç¨‹

##### ç¼–è¯‘å™¨å’Œè½¬è¯‘å™¨

ç¼–è¯‘çš„å®šä¹‰å°±æ˜¯ä»ä¸€ç§ç¼–ç¨‹è¯­è¨€è½¬æˆå¦ä¸€ç§ç¼–ç¨‹è¯­è¨€ã€‚ä¸»è¦æŒ‡çš„æ˜¯é«˜çº§è¯­è¨€åˆ°ä½çº§è¯­è¨€ã€‚

<font color=LightSeaGreen>ä¸€èˆ¬ç¼–è¯‘å™¨ Compiler æ˜¯æŒ‡é«˜çº§è¯­è¨€åˆ°ä½çº§è¯­è¨€çš„è½¬æ¢å·¥å…·</font>ã€‚è€Œ<font color=fuchsia>ä» **é«˜çº§è¯­è¨€** åˆ° **é«˜çº§è¯­è¨€** çš„ **è½¬æ¢å·¥å…·**ï¼Œè¢«å«åš <font size=4>**è½¬æ¢ç¼–è¯‘å™¨**</font>ï¼Œç®€ç§° **è½¬è¯‘å™¨** ( Transpiler )</font>ã€‚Babel å°±æ˜¯ä¸€ä¸ª JavaScript Transpilerã€‚

##### Babel çš„ç¼–è¯‘æµç¨‹

<font color=fuchsia>Babel æ˜¯ **source to source çš„è½¬æ¢**</font>ï¼Œæ•´ä½“ç¼–è¯‘æµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š

- **parse**ï¼šé€šè¿‡ <font color=red>parser æŠŠæºç è½¬æˆæŠ½è±¡è¯­æ³•æ ‘ ( AST )</font>
- **transform**ï¼š<font color=red>éå† ASTï¼Œè°ƒç”¨å„ç§ transform æ’ä»¶å¯¹ AST è¿›è¡Œå¢åˆ æ”¹</font>
- **generate**ï¼šæŠŠ<font color=red>è½¬æ¢åçš„ AST æ‰“å°</font>ï¼ˆğŸ‘€ ç”Ÿï¼Ÿï¼‰<font color=red>æˆç›®æ ‡ä»£ç </font>ï¼Œå¹¶ <font color=fuchsia size=4>**ç”Ÿæˆ sourcemap**</font>

![img](https://s2.loli.net/2023/01/03/79luiCsc6EPqxfA.png)

##### ä¸ºä»€ä¹ˆ babel çš„ç¼–è¯‘æµç¨‹ä¼šåˆ† parseã€transformã€generate è¿™ 3 æ­¥

æºç æ˜¯ä¸€ä¸²æŒ‰ç…§è¯­æ³•æ ¼å¼æ¥ç»„ç»‡çš„å­—ç¬¦ä¸²ï¼Œ<font color=LightSeaGreen>äººèƒ½å¤Ÿè®¤è¯†ï¼Œä½†æ˜¯è®¡ç®—æœºå¹¶ä¸è®¤è¯†</font>ï¼›<font color=red>æƒ³è®©è®¡ç®—æœºè®¤è¯†å°±è¦è½¬æˆä¸€ç§æ•°æ®ç»“æ„ï¼Œé€šè¿‡ä¸åŒçš„å¯¹è±¡æ¥ä¿å­˜ä¸åŒçš„æ•°æ®ï¼Œå¹¶ä¸”æŒ‰ç…§ä¾èµ–å…³ç³»ç»„ç»‡èµ·æ¥</font>ï¼›è¿™ç§æ•°æ®ç»“æ„å°±æ˜¯æŠ½è±¡è¯­æ³•æ ‘ ( abstract syntax tree )ã€‚

ä¹‹æ‰€ä»¥å«â€œæŠ½è±¡â€è¯­æ³•æ ‘æ˜¯å› ä¸º<font color=red>æ•°æ®ç»“æ„ä¸­çœç•¥æ‰äº†ä¸€äº›æ— å…·ä½“æ„ä¹‰çš„åˆ†éš”ç¬¦æ¯”å¦‚ `;` `{` `}`ç­‰</font> 

> ğŸ’¡ å‚è€ƒ [ç¼–ç¨‹è¯­è¨€çš„å‘å±•è¶‹åŠ¿ï¼šä»æ²¡æœ‰åˆ†å·ï¼Œåˆ°DSL](https://mp.weixin.qq.com/s/_SOlzlLG6ua8kXxnPltX0g) ä¸­æ‰€è¯´ï¼š
>
> > åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆ†å·æ˜¯ç»™æœºå™¨çœ‹çš„ï¼Œè€Œä¸æ˜¯ç»™äººçœ‹çš„ã€‚**å†™åˆ†å·ï¼Œæœ¬è´¨æ˜¯æˆ‘ä»¬äººç±»åœ¨è¿å°±ç¼–è¯‘å™¨**ï¼Œæ¯•ç«Ÿï¼Œæœºå™¨æ˜¯å¾ˆå‚»çš„ã€‚
>
> ç±»ä¼¼çš„ï¼Œ`{}` æ‹¬å·ä¹Ÿæ˜¯ã€‚

æœ‰äº† ASTï¼Œè®¡ç®—æœºå°±èƒ½ç†è§£æºç å­—ç¬¦ä¸²çš„æ„æ€ï¼Œè€Œç†è§£æ˜¯èƒ½å¤Ÿè½¬æ¢çš„å‰æï¼Œæ‰€ä»¥ç¼–è¯‘çš„ç¬¬ä¸€æ­¥éœ€è¦æŠŠæºç  parse æˆ ASTã€‚

è½¬æˆ AST ä¹‹åå°±å¯ä»¥é€šè¿‡ä¿®æ”¹ AST çš„æ–¹å¼æ¥ä¿®æ”¹ä»£ç ï¼Œ<font color=red>è¿™ä¸€æ­¥ä¼šéå† AST å¹¶è¿›è¡Œå„ç§å¢åˆ æ”¹</font>ï¼Œ<font color=LightSeaGreen>è¿™ä¸€æ­¥ä¹Ÿæ˜¯ babel æœ€æ ¸å¿ƒçš„éƒ¨åˆ†</font>ã€‚

ç»è¿‡è½¬æ¢ä»¥åçš„ AST å°±æ˜¯ç¬¦åˆè¦æ±‚çš„ä»£ç ï¼Œå°±å¯ä»¥å†è½¬å›å­—ç¬¦ä¸²ï¼Œ<font color=red>è½¬å›å­—ç¬¦ä¸²çš„è¿‡ç¨‹ä¸­æŠŠä¹‹å‰åˆ æ‰çš„ä¸€äº›åˆ†éš”ç¬¦å†åŠ å›æ¥</font>ã€‚

<font color=dodgerBlue>**ç®€å•æ€»ç»“**</font>ï¼š**ä¸ºäº†è®©è®¡ç®—æœºç†è§£ä»£ç éœ€è¦å…ˆå¯¹æºç å­—ç¬¦ä¸²è¿›è¡Œ parseï¼Œç”Ÿæˆ ASTï¼ŒæŠŠå¯¹ä»£ç çš„ä¿®æ”¹è½¬ä¸ºå¯¹ AST çš„å¢åˆ æ”¹ï¼Œè½¬æ¢å®Œ AST ä¹‹åå†æ‰“å°æˆç›®æ ‡ä»£ç å­—ç¬¦ä¸²ã€‚**

##### parseã€transformã€generate ä¸‰æ­¥åšäº†ä»€ä¹ˆ

###### parse

parse é˜¶æ®µçš„ç›®çš„æ˜¯æŠŠæºç å­—ç¬¦ä¸²è½¬æ¢æˆæœºå™¨èƒ½å¤Ÿç†è§£çš„ ASTï¼Œè¿™ä¸ªè¿‡ç¨‹<font color=fuchsia>åˆ†ä¸º **è¯æ³•åˆ†æ**ã€**è¯­æ³•åˆ†æ**</font>ã€‚

æ¯”å¦‚ `let name = 'guang';` è¿™æ ·ä¸€æ®µæºç ï¼Œæˆ‘ä»¬è¦<font color=red>å…ˆæŠŠå®ƒåˆ†æˆä¸€ä¸ªä¸ªä¸èƒ½ç»†åˆ†çš„å•è¯</font> ( token )ï¼Œä¹Ÿå°±æ˜¯ `let` , `name` , `=` , `'guang'` ï¼Œ<font color=fuchsia>è¿™ä¸ªè¿‡ç¨‹æ˜¯ **è¯æ³•åˆ†æ**</font>ï¼ŒæŒ‰ç…§å•è¯çš„æ„æˆè§„åˆ™æ¥æ‹†åˆ†å­—ç¬¦ä¸²æˆå•è¯ã€‚

ä¹‹åè¦<font color=fuchsia>æŠŠ token è¿›è¡Œé€’å½’çš„ç»„è£…ï¼Œç”Ÿæˆ AST</font>ï¼Œ<font color=fuchsia>è¿™ä¸ªè¿‡ç¨‹æ˜¯ **è¯­æ³•åˆ†æ**</font>ï¼›æŒ‰ç…§ä¸åŒçš„è¯­æ³•ç»“æ„ï¼Œæ¥æŠŠä¸€ç»„å•è¯ç»„åˆæˆå¯¹è±¡ï¼Œæ¯”å¦‚<font color=red>å£°æ˜è¯­å¥ã€èµ‹å€¼è¡¨è¾¾å¼ç­‰éƒ½æœ‰å¯¹åº”çš„ AST èŠ‚ç‚¹</font>ã€‚

<img src="https://s2.loli.net/2023/01/03/2r3SovJbGRWmuAx.png" alt="img" style="zoom:35%;" />

###### transform

transform é˜¶æ®µæ˜¯å¯¹ parse ç”Ÿæˆçš„ AST çš„å¤„ç†ï¼Œä¼š<font color=red>è¿›è¡Œ AST çš„éå†</font>ï¼Œ<font color=red>éå†çš„è¿‡ç¨‹ä¸­å¤„ç†åˆ°ä¸åŒçš„ AST èŠ‚ç‚¹ä¼š</font> <font color=fuchsia>è°ƒç”¨æ³¨å†Œçš„ **ç›¸åº”çš„ visitor å‡½æ•°**</font>ï¼Œ<font color=red>visitor å‡½æ•°é‡Œå¯ä»¥å¯¹ AST èŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹ï¼Œè¿”å›æ–°çš„ AST</font>ï¼ˆå¯ä»¥æŒ‡å®šæ˜¯å¦ç»§ç»­éå†æ–°ç”Ÿæˆçš„ ASTï¼‰ã€‚è¿™æ ·éå†å®Œä¸€é AST ä¹‹åå°±å®Œæˆäº†å¯¹ä»£ç çš„ä¿®æ”¹ã€‚

<img src="https://s2.loli.net/2023/01/03/FkptO2ITlQL1vnA.png" alt="img" style="zoom:40%;" />

###### generate

generate é˜¶æ®µä¼šæŠŠ AST æ‰“å°æˆç›®æ ‡ä»£ç å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆ sourcemapã€‚<font color=fuchsia>ä¸åŒçš„ AST å¯¹åº”çš„ä¸åŒç»“æ„çš„å­—ç¬¦ä¸²</font>ï¼Œæ¯”å¦‚ <font color=red>`IfStatement` å°±å¯ä»¥æ‰“å°æˆ `if (test) {}` æ ¼å¼çš„ä»£ç </font>ã€‚è¿™æ ·ä» AST æ ¹èŠ‚ç‚¹è¿›è¡Œé€’å½’çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°±å¯ä»¥ç”Ÿæˆç›®æ ‡ä»£ç çš„å­—ç¬¦ä¸²ã€‚

<img src="https://s2.loli.net/2023/01/03/F2IV9cSkPGs4NfC.png" alt="img" style="zoom:35%;" />

sourcemap è®°å½•äº†æºç åˆ°ç›®æ ‡ä»£ç çš„è½¬æ¢å…³ç³»ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç›®æ ‡ä»£ç ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯¹åº”çš„æºç ä½ç½®ï¼Œç”¨äºè°ƒè¯•çš„æ—¶å€™æŠŠç¼–è¯‘åçš„ä»£ç æ˜ å°„å›æºç ï¼Œæˆ–è€…çº¿ä¸ŠæŠ¥é”™çš„æ—¶å€™æŠŠæŠ¥é”™ä½ç½®æ˜ å°„åˆ°æºç ã€‚



#### Babel çš„ AST

AST æ˜¯å¯¹æºç çš„æŠ½è±¡ï¼Œ<font color=red>å­—é¢é‡ã€æ ‡è¯†ç¬¦ã€è¡¨è¾¾å¼ã€è¯­å¥ã€æ¨¡å—è¯­æ³•ã€class è¯­æ³•éƒ½æœ‰å„è‡ªçš„ AST</font>ã€‚

##### Literal å­—é¢é‡

`let name = 'guang'` ä¸­ï¼Œ`'guang'` å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡ StringLiteralï¼Œç›¸åº”çš„è¿˜æœ‰æ•°å­—å­—é¢é‡ NumericLiteral ï¼Œå¸ƒå°”å­—é¢é‡ BooleanLiteral ï¼Œå­—ç¬¦ä¸²å­—é¢é‡ StringLiteralï¼Œæ­£åˆ™è¡¨è¾¾å¼å­—é¢é‡ RegExpLiteral ç­‰ã€‚

ä¸‹é¢è¿™äº›å­—é¢é‡éƒ½æœ‰å¯¹åº”çš„ Literal èŠ‚ç‚¹ï¼š

<img src="https://s2.loli.net/2023/01/23/GBczVNK6COvZX4l.png" alt="" style="zoom: 33%;" />

ä»£ç ä¸­çš„å­—é¢é‡å¾ˆå¤šï¼Œbabel å°±æ˜¯é€šè¿‡ xxLiteral æ¥æŠ½è±¡è¿™éƒ¨åˆ†å†…å®¹çš„ã€‚

##### Identifier

Identifer æ˜¯æ ‡è¯†ç¬¦çš„æ„æ€ï¼Œå˜é‡åã€å±æ€§åã€å‚æ•°åç­‰å„ç§å£°æ˜å’Œå¼•ç”¨çš„åå­—ï¼Œéƒ½æ˜¯ Identiferã€‚



### å…¶ä»–è¡¥å……

##### babel-plugin-import

åœ¨çœ‹ [ä¸è¦å†å†™æ»¡å±importå¯¼å…¥å•¦ï¼ğŸ”¥](https://juejin.cn/post/7344571285848768524) çœ‹åˆ°äº† [babel-plugin-import](https://github.com/umijs/babel-plugin-import) æœ‰ç‚¹å¥½å¥‡ï¼Œä¾¿å‡†å¤‡äº†è§£ä¸€ä¸‹ï¼š

<img src="https://s2.loli.net/2024/03/24/1xdvFNBIOMZmfQA.png" alt="image-20240324000541259" style="zoom:50%;" />

â€œå‡å°‘æœ€ç»ˆæ‰“åŒ…çš„ä½“ç§¯â€ æ„Ÿè§‰å’Œ Tree Shaking å¾ˆåƒã€‚ä¸è¿‡ Tree Shaking åªæ”¯æŒ ESMï¼Œè€Œ `babel-plugin-import` ä¸æ˜¯ï¼Œè¿™å°±æé«˜äº†é€‚ç”¨èŒƒå›´ã€‚

<img src="https://s2.loli.net/2024/03/24/O7THxzYfIDL2lJR.png" alt="image-20240324000743392" style="zoom:50%;" />



## PostCSS

> ğŸ’¡ PostCSS å…·æœ‰ä¸°å¯Œçš„æ’ä»¶ç”Ÿæ€ï¼Œè¯¦è§ [[#æ’ä»¶æœ‰å“ªäº›ï¼Ÿ]]

#### å³°åå‰ç«¯çš„ã€Š13 åˆ†é’ŸæŒæ¡ PostCSSã€‹ç¬”è®°

PostCSS æ˜¯ä¸“é—¨ç”¨äºå¤„ç† CSS çš„å·¥å…·ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„æ’ä»¶æ¥ä¿®æ”¹æœ€ç»ˆæ ·å¼ï¼šå¯ä»¥è®©å¼€å‘è€…ä½¿ç”¨æœ€æ–°çš„ CSS ç‰¹æ€§ï¼ˆå“ªæ€•ææ¡ˆå¤„äº stage 0ï¼Œé…ç½®ç¤ºä¾‹è§ä¸‹é¢ä»£ç ï¼‰æé«˜å¼€å‘æ•ˆç‡ï¼ˆé€šè¿‡ä½¿ç”¨ [PostCSS-Preset-env](https://github.com/csstools/postcss-preset-env) ã€‚ä¸è¿‡åŸåº“å·²ç» archivedï¼Œå¹¶å…¥äº† [postcss-plugins](https://github.com/csstools/postcss-plugins) ã€‚å¦å¤–ï¼Œæ‰€æœ‰ staged çš„ CSS ç‰¹æ€§ï¼Œè§ [postcss-preset-env - feature](https://preset-env.cssdb.org/features/) ï¼‰ï¼›ä¹Ÿå¯ä»¥è½¬è¯‘ CSSï¼Œå…¼å®¹å¤§å¤šæ•°æµè§ˆå™¨ï¼ˆç±»ä¼¼äº Babel ï¼‰ï¼›PostCSS é€šè¿‡æ’ä»¶ï¼Œæ”¯æŒ Sass ä¹‹ç±» CSS é¢„å¤„ç†å·¥å…·ã€‚

ä½¿ç”¨ [autoprefixer](https://github.com/postcss/autoprefixer) å¯ä»¥æŸ¥çœ‹å“ªäº› CSS å±æ€§ã€å€¼ ã€é€‰æ‹©å™¨ã€`@rules` æ˜¯éœ€è¦åŠ ä¸Šæµè§ˆå™¨å‰ç¼€çš„ï¼Œä½¿ç”¨ `npx autoprefixer --info` å³å¯è¾“å‡ºå†…å®¹ï¼Œè¾“å‡ºå†…å®¹ç•¥ã€‚

ä½¿ç”¨ PostCSS å‘½ä»¤è¡Œå·¥å…· [PostCSS CLI](https://github.com/postcss/postcss-cli) å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼è¿è¡Œ PostCSSï¼š

```sh
npx postcss input.css -o output.css -u yourPostCssPlugin
```

é€šç”¨çš„è¯­æ³•è§ [PostCSS CLI - README](https://github.com/postcss/postcss-cli) ã€‚ä¸è¿‡è¿™æ ·è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥é€šè¿‡ é…ç½®æ–‡ä»¶ï¼ˆé…ç½® `postcss.config.js` æ–‡ä»¶ï¼‰ çš„æ–¹æ³•ï¼Œè®¾ç½® `yourPostCssPlugin` ï¼›ä½¿å¾—å³ä½¿åœ¨ä¸ä½¿ç”¨ webpack ä¹‹ç±»å·¥å…·çš„æƒ…å†µä¸‹ï¼Œè‡³å°‘ä¸éœ€è¦è¾“å…¥ `-u yourPostCssPlugin` ã€‚ä½¿ç”¨ npm scripts ç”šè‡³å¯ä»¥çœå»å‰é¢ï¼ˆå›ºå®šï¼‰çš„ä»£ç 

```js
// postcss.config.js
const postcssPresetEnv = require('postcss-preset-env')

module.exports = {
  plugins: [
    require('stylelint'),
    require('autoprefixer'),
    postcssPresetEnv({
      stage: 0 // å¯ä»¥ä½¿ç”¨ææ¡ˆåœ¨ stage 0 çš„æ–°ç‰¹æ€§
    }),
    require('postcss-pxtorem')
  ]
}
```

CSS ä¹Ÿæœ‰è‡ªå·±çš„ lint å·¥å…·  [stylelint](https://github.com/stylelint/stylelint) ä»¥åŠ å®ƒåŸºæœ¬çš„è§„åˆ™ [stylelint-config-standard](https://github.com/stylelint/stylelint-config-standard) ï¼›ä½¿ç”¨ stylelint åˆ›å»º `.stylelintrc.json` é…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨ `postcss.config.js` é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œï¼ˆæ³¨å†Œè§ä¸Šé¢ï¼‰ï¼š

```json
// .stylelintrc.json
{
  "extends": "stylelint-config-standard"
}
```

åœ¨å¼€å‘æ—¶éœ€è¦å°† px è½¬æ¢ä¸º remï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ’ä»¶ [postcss-pxtorem](https://github.com/cuth/postcss-pxtorem) ï¼ˆç±»ä¼¼çš„æœ‰ [px2rem](https://github.com/songsiqi/px2rem) ï¼‰ï¼Œä¸è¿‡å‰è€… Star æ›´å¤š

å­¦ä¹ è‡ªï¼š[13 åˆ†é’ŸæŒæ¡ PostCSS](https://bilibili.com/video/BV1Pd4y1S7Mp)

ç›¸å…³çš„ï¼Œåœ¨ [[Vue3 + TS å­¦ä¹ ç¬”è®°#PostCSS å·¥å…·]] ä¸­ä¹Ÿæœ‰ PostCSS çš„ç¬”è®°

### Tecvanã€Šé›¶åŸºç¡€ç†è§£ PostCSS çš„ä¸»æµç¨‹ã€‹ç¬”è®°

å®˜ç½‘è¯´ï¼šâ€œPostCSSï¼Œä¸€ä¸ªä½¿ç”¨ JavaScript æ¥å¤„ç† CSS çš„æ¡†æ¶â€ ( A tool for transforming CSS with JavaScript )ã€‚è¿™å¥è¯é«˜åº¦æ¦‚æ‹¬äº† PostCSS çš„ä½œç”¨ï¼Œä½†æ˜¯å¤ªæŠ½è±¡äº†ã€‚æŒ‰æˆ‘ç†è§£ï¼ŒPostCSS ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š

1. **parse**ï¼š<font color=red>æŠŠ CSS æ–‡ä»¶çš„å­—ç¬¦ä¸²è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ ( Abstract Syntax Tree ) çš„æ¡†æ¶</font>ï¼Œ<font color=fuchsia>è§£æè¿‡ç¨‹ä¸­ä¼šæ£€æŸ¥ CSS è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œä¸æ­£ç¡®ä¼šç»™å‡ºé”™è¯¯æç¤º</font>ã€‚
2. **runPlugin**ï¼š<font color=fuchsia>**æ‰§è¡Œæ’ä»¶å‡½æ•°**</font>ã€‚<font color=fuchsia>**PostCSS æœ¬èº«ä¸å¤„ç†ä»»ä½•å…·ä½“ä»»åŠ¡**ï¼Œå®ƒæä¾›äº†ä»¥ç‰¹å®šå±æ€§æˆ–è€…è§„åˆ™å‘½åçš„äº‹ä»¶</font>ã€‚æœ‰ç‰¹å®šåŠŸèƒ½çš„æ’ä»¶ï¼ˆå¦‚ autoprefixerã€CSS Modules ï¼‰ä¼šæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚PostCSS ä¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œé‡æ–°æ‰«æ ASTï¼Œæ‰§è¡Œæ³¨å†Œçš„ç›‘å¬å™¨å‡½æ•°ã€‚
3. **generate**ï¼š<font color=fuchsia>æ’ä»¶å¯¹ AST å¤„ç†åï¼ŒPostCSS æŠŠå¤„ç†è¿‡çš„ AST å¯¹è±¡è½¬æˆ CSS string</font>ã€‚

![å›¾ç‰‡](https://s2.loli.net/2022/08/11/RDNvjWZ72KdySeh.png)

<font color=red>**ã€Œå¦‚æœæ²¡æœ‰æ’ä»¶ã€**ï¼Œé‚£ä¹ˆåˆå§‹ä¼ å…¥çš„ CSS string å’Œ generate ç”Ÿæˆçš„ CSS string æ˜¯ä¸€æ ·çš„</font>ã€‚ç”±æ­¤å¯è§ï¼Œ<font color=fuchsia>PostCSS æœ¬èº«å¹¶ä¸å¤„ç†ä»»ä½•å…·ä½“çš„ä»»åŠ¡ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¸ºå…¶é™„åŠ å„ç§æ’ä»¶ä¹‹åï¼Œå®ƒæ‰å…·æœ‰å®ç”¨æ€§</font>ã€‚

ä¸‹é¢åˆ†åˆ«è¯¦ç»†åˆ†æä¸‰ä¸ªé˜¶æ®µåšçš„äº‹ã€‚

#### ç¬¬ä¸€é˜¶æ®µï¼šparse

<font color=dodgerBlue>CSS è§„åˆ™é›† ( rule-set ) ç”±é€‰æ‹©å™¨å’Œå£°æ˜å—ç»„æˆ</font>ï¼š

![å›¾ç‰‡](https://s2.loli.net/2022/08/12/Z9Dtvd1efCRGJhP.png)

- **é€‰æ‹©å™¨** æŒ‡å‘æ‚¨éœ€è¦è®¾ç½®æ ·å¼çš„ HTML å…ƒç´ 
- <font color=red>**å£°æ˜å—** åŒ…å«ä¸€æ¡æˆ–å¤šæ¡ç”¨åˆ†å·åˆ†éš”çš„å£°æ˜</font>
- æ¯æ¡ **å£°æ˜** éƒ½åŒ…å«ä¸€ä¸ª CSS å±æ€§åç§°å’Œä¸€ä¸ªå€¼ï¼Œä»¥å†’å·åˆ†éš”
- å¤šæ¡ **CSS å£°æ˜** ç”¨åˆ†å·åˆ†éš”ï¼Œå£°æ˜å—ç”¨èŠ±æ‹¬å·æ‹¬èµ·æ¥

##### äº”ç±»å¯¹è±¡

<font color=fuchsia>AST ç”¨ **äº”ç±»å¯¹è±¡** æè¿° CSS è¯­æ³•</font>ã€‚<font color=dodgerBlue>è¿™é‡Œä¸¾ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œå†æ‰“å°å‡ºå¯¹åº”çš„ AST ç»“æœï¼Œ**å¯¹ç…§äº†è§£ AST äº”ç±»å¯¹è±¡å’Œ CSS è¯­æ³•çš„å¯¹åº”å…³ç³»**</font>ã€‚

`app.css` æ–‡ä»¶ä¸­å†™å¦‚ä¸‹å†…å®¹ï¼š

```css
@import url('./app-02.css');

.container {
  color: red;
}
```

##### Declaration å¯¹è±¡

<font color=fuchsia>Declaration å¯¹è±¡ç”¨æ¥ **æè¿° CSS ä¸­çš„æ¯ä¸€æ¡å£°æ˜è¯­å¥**</font>

- **type**ï¼š<font color=red>æ ‡è®°å½“å‰å¯¹è±¡çš„ç±»å‹</font>
- **parent**ï¼š<font color=red>è®°å½•çˆ¶å¯¹è±¡çš„å®ä¾‹</font>
- **prop**ï¼šè®°å½•å£°æ˜ä¸­çš„å±æ€§å
- **value**ï¼šè®°å½•å£°æ˜ä¸­çš„å€¼
- **raws**ï¼š<font color=red>å­—æ®µè®°å½•å£°æ˜å‰çš„å­—ç¬¦ä¸²ã€å£°æ˜å±æ€§å’Œå€¼ä¹‹é—´çš„ç¬¦å·çš„å­—ç¬¦ä¸²</font>
- å…¶ä½™å­—æ®µï¼ˆæ¯”å¦‚ `source` åŠå…¶å­å­—æ®µã€`Symbol(prop)` ï¼‰è§£é‡Šè§ä»£ç ä¸­çš„æ³¨é‡Š

ä¸Šè¾¹ CSS æ–‡ä»¶ä¸­çš„ `color: red;` ä¼šè¢«æè¿°æˆå¦‚ä¸‹å¯¹è±¡ï¼š

```json
{
  parent: Rule,    // å¤–å±‚çš„é€‰æ‹©å™¨è¢«è½¬è¯‘æˆ Rule å¯¹è±¡ï¼Œæ˜¯å½“å‰å£°æ˜å¯¹è±¡çš„ parent
  prop: "color",   // prop å­—æ®µè®°å½•å£°æ˜çš„å±æ€§
  raws: {          // raws å­—æ®µè®°å½•å£°æ˜å‰ã€åçš„å­—ç¬¦ä¸²ï¼Œå£°æ˜å±æ€§å’Œå€¼ä¹‹é—´çš„å­—ç¬¦ä¸²ï¼Œä»¥åŠå‰è¾¹è¯­å¥æ˜¯å¦åˆ†å·ç»“æŸã€‚
    before: '\n ', // raws.before å­—æ®µè®°å½•å£°æ˜å‰çš„å­—ç¬¦ä¸²
    between: ': ', // raws.between å­—æ®µè®°å½•å£°æ˜å±æ€§å’Œå€¼ä¹‹é—´çš„å­—ç¬¦ä¸²
  },
  source: { // source å­—æ®µè®°å½•å£°æ˜è¯­å¥çš„å¼€å§‹ã€ç»“æŸä½ç½®ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: { offset: 45, column: 3, line: 4 },
    end: { offset: 55, column: 13, line: 4 },
    input: Input {
      css: '@import url('./app-02.css');\n\n.container {\n  color: red;\n}',
      file: '/Users/admin/temp/postcss/app.css',
      hasBOM: false,
      Symbol(fromOffsetCache): [0, 29, 30, 43, 57]
    }
  },
  Symbol('isClean'): false,  // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true, // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype å±æ€§
  type: 'decl',      // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ decl
  value: "red"       // value å­—æ®µè®°å½•å£°æ˜çš„å€¼
}
```

##### Rule å¯¹è±¡

<font color=fuchsia>Rule å¯¹è±¡æ˜¯ **æè¿°é€‰æ‹©å™¨** çš„</font>

- **type**ï¼šè®°å½•å¯¹è±¡çš„ç±»å‹
- **parent**ï¼šè®°å½•çˆ¶å¯¹è±¡çš„å®ä¾‹
- **nodes**ï¼š<font color=red>è®°å½•å­å¯¹è±¡çš„å®ä¾‹</font>
- **selector**ï¼š<font color=red>è®°å½•é€‰æ‹©å™¨çš„å­—ç¬¦ä¸²</font>
- **raws**ï¼š<font color=red>è®°å½•é€‰æ‹©å™¨å‰çš„å­—ç¬¦ä¸²ã€é€‰æ‹©å™¨å’Œå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²ã€æœ€åä¸€ä¸ªå£°æ˜å’Œç»“æŸå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²</font>
- å…¶ä½™å­—æ®µè§£é‡Šè§ä»£ç ä¸­çš„æ³¨é‡Š

ä¸Šè¾¹ `app.css` æ–‡ä»¶ä¸­ `.container` ç»è¿‡ postcss è½¬è¯‘åçš„å¯¹è±¡æ˜¯ï¼ˆæ¯ä¸ªå­—æ®µçš„å«ä¹‰å’ŒåŠŸèƒ½å·²ç»ä»¥æ³¨é‡Šçš„å½¢å¼è¿›è¡Œäº†è§£é‡Šï¼‰ï¼š

```json
{
  nodes: [Declaration],  // nodes è®°å½•åŒ…å«å…³ç³»ï¼ŒRule å¯¹è±¡åŒ…å« Declaration å¯¹è±¡
  parent: Root,          // æ ¹å¯¹è±¡æ˜¯ Root å¯¹è±¡ï¼Œæ˜¯å½“å‰å£°æ˜å¯¹è±¡çš„ parent
  raws: {                // raws å­—æ®µè®°å½•å¦‚ä¸‹
    before: '\n\n',      // raws.before å­—æ®µè®°å½•é€‰æ‹©å™¨å‰çš„å­—ç¬¦ä¸²
    between: ' ',        // raws.between å­—æ®µè®°å½•é€‰æ‹©å™¨å’Œå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²
    semicolon: true,     // raws.semicolon å­—æ®µè®°å½•å‰ç½®å£°æ˜è¯­å¥æ˜¯æ­£å¸¸åˆ†å·ç»“æŸ
    after: '\n'          // raws.after å­—æ®µè®°å½•æœ€åä¸€ä¸ªå£°æ˜å’Œç»“æŸå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²
  },
  selector:'.container', // selector è®°å½• selector
  source: {              // source å­—æ®µè®°å½•é€‰æ‹©å™¨è¯­å¥çš„å¼€å§‹ã€ç»“æŸä½ç½®ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: { offset: 30, column: 1, line: 3 },
    input: Input {
      css: '@import url('./app-02.css');\n\n.container {\n  color: red;\n}',
      file: '/Users/admin/temp/postcss/app.css',
      hasBOM: false,
      Symbol(fromOffsetCache): [0, 29, 30, 43, 57]
    },
    end: { offset: 57, column: 1, line: 5 }
  },
  Symbol('isClean'): false, // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true,       // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype
  type: 'rule'              // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ rule
}
```

##### AtRule å¯¹è±¡

<font color=fuchsia>CSS ä¸­é™¤äº†é€‰æ‹©å™¨ï¼Œè¿˜æœ‰ä¸€ç±»è¯­æ³•æ˜¯ `@` å¼€å¤´çš„</font>ï¼Œä¾‹å¦‚ `@import`ã€`@keyframes`ã€`@font-face`ï¼ŒPostCSS æŠŠè¿™ç±»è¯­æ³•è§£ææˆ AtRule å¯¹è±¡ã€‚ğŸ‘€ æ³¨ï¼šå®ƒæœ¬èº«çš„åå­—ä¹Ÿå« `@rules`

- **type**ï¼šè®°å½•å½“å‰å¯¹è±¡çš„ç±»å‹
- **parent**ï¼šè®°å½•å½“å‰å¯¹è±¡çš„çˆ¶å¯¹è±¡
- **name**ï¼šè®°å½• <font color=red>`@` ç´§è·Ÿç€çš„å•è¯</font>
- **params**ï¼šè®°å½• name å¯¹åº”çš„å€¼

ä¾‹å¦‚ `@import url("./app-02.css");` å°†è¢«è§£ææˆå¦‚ä¸‹å¯¹è±¡ï¼š

```json
{
  name: "import",                // name è®°å½• @ ç´§è·Ÿç€çš„å•è¯
  params: "url('./app-02.css')", // params è®°å½• name å¯¹åº”çš„å€¼
  parent: Root,                  // parent è®°å½•çˆ¶å¯¹è±¡
  raws: {                        // raws å­—æ®µè®°å½•å¦‚ä¸‹
    before: '',                  // raws.before è®°å½• @è¯­å¥å‰çš„ç©ºå­—ç¬¦ä¸²
    between: '',                 // raws.between è®°å½• name å’Œ { ä¹‹é—´çš„ç©ºå­—ç¬¦ä¸²
    afterName: '',               // raws.afterName è®°å½• name å’Œ @ è¯­å¥ä¹‹é—´çš„ç©ºå­—ç¬¦ä¸²
    after: '',                   // raws.after è®°å½•å¤§æ‹¬å·å’Œä¸Šä¸€ä¸ª rule ä¹‹é—´çš„ç©ºå­—ç¬¦ä¸²
    semicolon: false             // raws.semicolon ä¸Šä¸€ä¸ªè§„åˆ™æ˜¯å¦æ˜¯åˆ†å·ç»“æŸ
  },
  source: {                      // source å­—æ®µè®°å½•@è¯­å¥çš„å¼€å§‹ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: { offset: 0, column: 1, line: 1 },
    end: { offset: 27, column: 28, line: 1 },
    input: Input {
      css: '@import url('./app-02.css');\n\n.container {\n  color: red;\n}',
      file: '/Users/admin/temp/postcss/app.css',
      hasBOM: false,
      Symbol(fromOffsetCache): [0, 29, 30, 43, 57]
    }
  },
  Symbol('isClean'): false,  // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true,        // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype
  type: 'atrule'          // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ atrule
}
```

##### Comment å¯¹è±¡

<font color=fuchsia>CSS æ–‡ä»¶ä¸­çš„æ³¨é‡Šè¢«è§£ææˆ Comment å¯¹è±¡</font>ã€‚text å­—æ®µè®°å½•æ³¨é‡Šå†…å®¹ã€‚`/* ä½ å¥½ */  `è¢«è§£ææˆï¼š

```json
{
  parent: Root,    // parent è®°å½•çˆ¶å¯¹è±¡
  raws: {          // raws å­—æ®µè®°å½•å¦‚ä¸‹
    before: '',    // raws.before è®°å½•æ³¨é‡Šè¯­å¥å‰çš„ç©ºå­—ç¬¦ä¸²
    left: ' ',     // raws.left è®°å½•æ³¨é‡Šè¯­å¥å·¦ä¾§çš„ç©ºå­—ç¬¦ä¸²
    right: ' '     // raws.right è®°å½•æ³¨é‡Šè¯­å¥å³ä¾§çš„ç©ºå­—ç¬¦ä¸²
  },
  source: {        // source å­—æ®µè®°å½•æ³¨é‡Šè¯­å¥çš„å¼€å§‹ã€ç»“æŸä½ç½®ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: {â€¦}, 
    input: Input, 
    end: {â€¦}
  },
  Symbol('isClean'): false, // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true,       // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype
  text: 'ä½ å¥½',              // text è®°å½•æ³¨é‡Šå†…å®¹
  type: 'comment'           // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ comment
}
```

##### å›¾è§£äº”ç±»å¯¹è±¡ä¹‹é—´çš„ç»§æ‰¿å…³ç³»

ä»ä¸Šä¸€æ®µå¯ä»¥çŸ¥é“ï¼Œ<font color=LightSeaGreen>CSS è¢«è§£ææˆ Declarationã€Ruleã€Rootã€AtRuleã€Comment å¯¹è±¡</font>ã€‚<font color=fuchsia>**è¿™äº›å¯¹è±¡æœ‰å¾ˆå¤š å…¬å…±æ–¹æ³•ï¼ŒPostCSS ç”¨äº†é¢å‘å¯¹è±¡çš„ç»§æ‰¿æ€æƒ³ï¼ŒæŠŠå…¬å…±æ–¹æ³•å’Œå…¬å…±å±æ€§æå–åˆ°äº†çˆ¶ç±»ä¸­**</font>ã€‚

<font color=fuchsia>**Rootã€Ruleã€AtRule** éƒ½æ˜¯å¯ä»¥æœ‰å­èŠ‚ç‚¹çš„</font>ï¼Œéƒ½æœ‰ nodes å±æ€§ï¼Œ<font color=fuchsia>**ä»–ä»¬ä¸‰ä¸ªç»§æ‰¿è‡ª Container ç±»**</font>ï¼Œå¯¹ nodes çš„æ“ä½œæ–¹æ³•éƒ½å†™åœ¨ Container ç±»ä¸­ã€‚

<font color=fuchsia>**Containerã€Declarationã€Comment** **ç»§æ‰¿è‡ª Node ç±»**</font>ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æœ‰ `Symbol('isClean')` ã€`Symbol('my')`ã€rawsã€sourceã€type å±æ€§ï¼Œéƒ½æœ‰ `toString()`ã€`error()` ç­‰æ–¹æ³•ï¼Œè¿™äº›å±æ€§å’Œæ–¹æ³•éƒ½å®šä¹‰åœ¨ Node ç±»ä¸­ã€‚

**Containerã€Node** æ˜¯ç”¨æ¥æå–å…¬å…±å±æ€§å’Œæ–¹æ³•ï¼Œä¸ä¼šç”Ÿæˆä»–ä»¬çš„å®ä¾‹ã€‚

<font color=dodgerBlue>äº”ä¸ªç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</font>

![Image](https://s2.loli.net/2022/08/12/c6po81SKtVYMnXv.png)

å›¾ä¸­æ²¡æœ‰ç©·ä¸¾ç±»çš„æ–¹æ³•ï¼Œå…¨éƒ¨çš„æ–¹æ³• å¯ä»¥çœ‹ç›´æ¥çœ‹æºç æ–‡ä»¶: https://github.com/postcss/postcss/tree/main/lib

#### ç¬¬äºŒé˜¶æ®µï¼šrunPlugin

<font color=LightSeaGreen>PostCSS æœ¬èº«å¹¶ä¸å¤„ç†ä»»ä½•å…·ä½“çš„ä»»åŠ¡ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¸ºå…¶é™„åŠ å„ç§æ’ä»¶ä¹‹åï¼Œå®ƒæ‰å…·æœ‰å®ç”¨æ€§</font>ã€‚

<font color=fuchsia>PostCSS åœ¨æŠŠ CSS string è§£ææˆ AST å¯¹è±¡åï¼Œä¼šæ‰«æä¸€è¾¹ AST å¯¹è±¡</font>ï¼Œ<font color=fuchsia>**æ¯ä¸€ç§ AST çš„å¯¹è±¡éƒ½å¯ä»¥æœ‰å¯¹åº”çš„ç›‘å¬å™¨**</font>ã€‚<font color=red>åœ¨éå†åˆ°æŸç±»å‹çš„å¯¹è±¡æ—¶ï¼Œå¦‚æœæœ‰å¯¹è±¡çš„ç›‘å¬å™¨ï¼Œå°±ä¼šæ‰§è¡Œå…¶ç›‘å¬å™¨</font>ã€‚

##### ç¬¬ä¸€ç±»ç›‘å¬å™¨

PostCSS æä¾›çš„**ã€Œä»¥ç‰¹å®šå±æ€§æˆ–è€…è§„åˆ™å‘½åã€**çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œå¦‚ä¸‹ï¼š

> CHILDREN ä»£è¡¨å­èŠ‚ç‚¹çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

```js
// root
['Root', CHILDREN, 'RootExit']

// AtRule
['AtRule', 'AtRule-import', CHILDREN, 'AtRuleExit', 'AtRuleExit-import']

// Rule
['Rule', CHILDREN, 'RuleExit']

// Declaration
['Declaration', 'Declaration-color', 'DeclarationExit', 'DeclarationExit-color']

// Comment
['Comment', 'CommentExit']
```

PostCSS ä»¥ <font color=fuchsia size=4>**æ·±åº¦ä¼˜å…ˆ** çš„æ–¹å¼éå† AST æ ‘</font>ã€‚

- <mark style="background: lightpink">**éå†åˆ° Root æ ¹å¯¹è±¡**ï¼Œ**ç¬¬ä¸€æ­¥** ä¼šæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ Root äº‹ä»¶ç›‘å¬å™¨ï¼Œ**ç¬¬äºŒæ­¥** æ£€æŸ¥ Root æ˜¯å¦æœ‰å­å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éå†å­å¯¹è±¡ï¼Œæ‰§è¡Œå­å¯¹è±¡å¯¹åº”çš„äº‹ä»¶ç›‘å¬å™¨ï¼›å¦‚æœæ²¡æœ‰å­å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿›å…¥ç¬¬ä¸‰æ­¥ï¼›**ç¬¬ä¸‰æ­¥** ä¼šæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ RootExit äº‹ä»¶ç›‘å¬å™¨</mark> ï¼ˆğŸ‘€ æ³¨ï¼šè¿™å°±æ˜¯ DFS çš„æ­¥éª¤ï¼‰ã€‚

  <font color=red>æ’ä»¶æ³¨å†Œçš„ Rootã€RootExit äº‹ä»¶çš„ç›‘å¬å™¨ **åªèƒ½æ˜¯å‡½æ•°**</font>ã€‚å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å½“å‰è®¿é—®çš„ AST çš„ Root å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ postcss çš„ Result å¯¹è±¡å’Œä¸€äº›å…¶ä»–å±æ€§ï¼Œé€šè¿‡ Result å¯¹è±¡å¯ä»¥è·å– css stringã€opts ç­‰ä¿¡æ¯ã€‚

  ```js
  {
    Root: (rootNode, helps) => {},
    RootExit: (rootNode, helps) => {}
  }
  ```

- **éå†åˆ° Rule å¯¹è±¡**ï¼Œåˆ™<mark style="background: lightpink">å’Œè®¿é—® Root æ ¹å¯¹è±¡æ˜¯ä¸€æ ·çš„é€»è¾‘</mark>ï¼Œå…ˆæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ Rule äº‹ä»¶ç›‘å¬å™¨ï¼Œå†éå†å­å¯¹è±¡ï¼Œæœ€åæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ RuleExit äº‹ä»¶ç›‘å¬å™¨ã€‚<font color=red>æ’ä»¶æ³¨å†Œçš„ Ruleã€RuleExit äº‹ä»¶çš„ç›‘å¬å™¨ **åªèƒ½æ˜¯å‡½æ•°**</font>ã€‚

  ```js
  {
    Rule: (ruleNode, helps) => {},
    RuleExit: (ruleNode, helps) => {}
  }
  ```

- **éå†åˆ° AtRule å¯¹è±¡**ã€‚<font color=red>æ’ä»¶æ³¨å†Œçš„ AtRule çš„äº‹ä»¶ç›‘å¬å™¨ **å¯ä»¥æ˜¯å‡½æ•°**ï¼Œ**ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡**</font>ã€‚å¯¹è±¡ç±»å‹çš„ç›‘å¬å™¨ï¼Œå¯¹è±¡å±æ€§çš„ key æ˜¯ AtRule å¯¹è±¡çš„ name å€¼ï¼Œvalue æ˜¯å‡½æ•°ã€‚<mark style="background: lightpink">AtRuleExit æ˜¯ä¸€æ ·çš„é€»è¾‘</mark>ã€‚<font color=fuchsia>äº‹ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š`['AtRule', 'AtRule-import', CHILDREN, 'AtRuleExit', 'AtRuleExit-import']` </font>ã€‚CHILDREN ä»£è¡¨å­èŠ‚ç‚¹çš„äº‹ä»¶ã€‚

  ```js
   // å‡½æ•°
  { 
    AtRule: (atRuleNode, helps) => {}
  }
  
  // å¯¹è±¡
  {
    AtRule: {
      import: (atRuleNode, helps) => {},
      keyframes: (atRuleNode, helps) => {}
    }
  }
  ```

- **éå†åˆ° Declaration å¯¹è±¡**ã€‚<font color=red>æ’ä»¶æ³¨å†Œçš„ Declaration çš„äº‹ä»¶ç›‘å¬å™¨ **å¯ä»¥æ˜¯å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡**</font>ï¼Œå¯¹è±¡å±æ€§çš„ key æ˜¯ Declaration å¯¹è±¡çš„ prop å€¼ï¼Œvalue æ˜¯å‡½æ•°ã€‚<mark style="background: lightpink">DeclarationExitExit æ˜¯ä¸€æ ·çš„é€»è¾‘</mark>ã€‚<font color=fuchsia>äº‹ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š`['Declaration', 'Declaration-color', 'DeclarationExit', 'DeclarationExit-color']`</font> ã€‚**Declaration æ²¡æœ‰å­å¯¹è±¡ï¼Œåªéœ€è¦æ‰§è¡Œå½“å‰å¯¹è±¡çš„äº‹ä»¶ï¼Œä¸éœ€è¦æ·±åº¦æ‰§è¡Œå­å¯¹è±¡çš„äº‹ä»¶**ã€‚

  ```js
  // å‡½æ•°
  {
    Declaration: (declarationNode, helps) => {}
  }
  
  // å¯¹è±¡
  {
    Declaration: {
      color: (declarationNode, helps) => {},
      border: (declarationNode, helps) => {}
    }
  }
  ```

- **éå†åˆ° Comment å¯¹è±¡**ã€‚ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ Comment äº‹ä»¶ç›‘å¬å™¨ï¼Œå†æ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ CommentExit äº‹ä»¶ç›‘å¬å™¨ã€‚

##### ç¬¬äºŒç±»ç›‘å¬å™¨

<font color=dodgerBlue>é™¤ä»¥ç‰¹å®šå±æ€§æˆ–è€…è§„åˆ™å‘½åçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œ**PostCSS è¿˜æœ‰ä»¥ä¸‹å››ä¸ª**</font>ï¼ˆğŸ‘€ æ³¨ï¼šä¸‰ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ’ä»¶åç§°ï¼‰ï¼š

```js
{
  postcssPlugin: string,
  prepare: (result) => {},
  Once: (root, helps) => {},
  OnceExit: (root, helps) => {},
}
```

PostCSS æ’ä»¶äº‹ä»¶çš„æ•´ä½“æ‰§è¡Œæ˜¯ï¼š`[prepare, Once, ...ä¸€ç±»äº‹ä»¶, OnceExit]`ï¼Œ<font color=red>**postcssPlugin æ˜¯æ’ä»¶åç§°**</font>ï¼Œä¸æ˜¯äº‹ä»¶ç›‘å¬å™¨ã€‚

- **postcssPlugin**ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œ<font color=red>æ’ä»¶çš„åå­—ï¼Œåœ¨æ’ä»¶æ‰§è¡ŒæŠ¥é”™ï¼Œæç¤ºç”¨æˆ·æ˜¯å“ªä¸ªæ’ä»¶æŠ¥é”™äº†</font>ã€‚

- **prepare**ï¼šå‡½æ•°ç±»å‹ï¼Œ<font color=red>prepare æ˜¯æœ€å…ˆæ‰§è¡Œçš„ï¼Œåœ¨æ‰€æœ‰äº‹ä»¶æ‰§è¡Œå‰æ‰§è¡Œçš„</font>ï¼Œæ’ä»¶å¤šä¸ªç›‘å¬å™¨é—´å…±äº«æ•°æ®æ—¶ä½¿ç”¨ã€‚prepare çš„å…¥å‚æ˜¯ Result å¯¹è±¡ï¼Œè¿”å›å€¼æ˜¯ç›‘å¬å™¨å¯¹è±¡ï¼Œé€šè¿‡ Result å¯¹è±¡å¯ä»¥è·å– css stringã€opts ç­‰ä¿¡æ¯ã€‚

  ```js
  {
    postcssPlugin: "PLUGIN NAME",
    prepare(result) {
      const variables = {};
      return {
        Declaration(node) {
          if (node.variable) {
            variables[node.prop] = node.value;
          }
        },
        OnceExit() {
          console.log(variables);
        },
      };
    },
  };
  ```

- **Once**ï¼šå‡½æ•°ç±»å‹ï¼Œ<font color=red>åœ¨ prepare åï¼Œä¸€ç±»äº‹ä»¶å‰æ‰§è¡Œ</font>ï¼ŒOnce <font color=red>åªä¼šæ‰§è¡Œä¸€æ¬¡</font>ã€‚

  ```js
  {
     Once: (root, helps) => {}
  }
  ```

- **OnceExit**ï¼šå‡½æ•°ç±»å‹ï¼Œ<font color=red>åœ¨ä¸€ç±»äº‹ä»¶åæ‰§è¡Œ</font>ï¼ŒOnceExit <font color=red>åªä¼šæ‰§è¡Œä¸€æ¬¡</font>ã€‚

###### æ’ä»¶æœ‰å“ªäº›ï¼Ÿ

[postcss Github - docs - PostCSS plugins](https://github.com/postcss/postcss/blob/main/docs/plugins.md) åˆ—å‡ºäº†å¤§é‡çš„ postcss pluginï¼Œå°±ç›¸å½“äº awesome postcss

> ğŸ’¡ è¿˜æœ‰ [PostCSS.parts](https://www.postcss.parts/) æ˜¯ä¸€ä¸ª postcss æ’ä»¶æœç´¢å·¥å…·
>
> > A searchable catalog of PostCSS plugins

> ğŸ’¡ è¿™é‡Œåšä¸€äº› postcss æ’ä»¶çš„ä»‹ç»
>
> - [purgecss](https://github.com/FullHuman/purgecss) ï¼šRemove unused CSS
>
> - [cssnano](https://github.com/cssnano/cssnano) ï¼šA modular minifier, built on top of the PostCSS ecosystem. ( css ä»£ç å‹ç¼©å·¥å…·)
>
> - [postcss-modules](https://github.com/madyankin/postcss-modules) : PostCSS plugin to use CSS Modules everywhereï¼ˆç»™ css class ç±»åä¸ŠåŠ ä¸Š hashï¼Œä½¿å…¶å…·æœ‰ä¸è¢«åŒå class å¹²æ‰°ï¼‰
>
> - [css-has-pseudo](https://github.com/csstools/postcss-plugins/tree/main/plugins/css-has-pseudo#readme) ï¼š`:has()` ä¼ªç±»çš„ postcss polyfillã€‚ä¸‹å›¾æ˜¯ `:has()` çš„å…¼å®¹æ€§ï¼Œå¯è§ï¼šåœ¨ Chrome 105 å’Œ Safari 15.4 æ‰æ”¯æŒï¼Œå…¼å®¹æ€§å¾ˆä¸€èˆ¬
>
>   <img src="https://s2.loli.net/2024/01/05/MF4fxCWVZ9vqr37.png" alt="image-20240105095547701" style="zoom:50%;" />

#### ç¬¬ä¸‰é˜¶æ®µï¼šgenerate

generate çš„è¿‡ç¨‹<font color=fuchsia>ä¾æ—§æ˜¯ä»¥æ·±åº¦ä¼˜å…ˆçš„æ–¹å¼éå† AST å¯¹è±¡ï¼Œ**é’ˆå¯¹ä¸åŒçš„å®ä¾‹å¯¹è±¡è¿›è¡Œå­—ç¬¦ä¸²çš„æ‹¼æ¥**</font>ã€‚ç®—æ³•å¯¹åº”æºç ä¸­ä½ç½®æ˜¯ï¼š`postcss/lib/stringifier.js` ä¸­çš„ `stringify ` æ–¹æ³•ï¼Œä»£ç é‡ä¸å¤§ï¼Œå¯è‡ªè¡ŒæŸ¥çœ‹ã€‚

æ‘˜è‡ªï¼š[é›¶åŸºç¡€ç†è§£ PostCSS çš„ä¸»æµç¨‹](https://mp.weixin.qq.com/s/Bkss0lzPT-TI6GyGxMyn3Q)



## Atomic CSS

> ğŸ‘€ ä¸‹é¢æœ‰ Tailwind CSS å’Œ Unocss çš„ç¬”è®°ï¼Œè™½ç„¶ Tailwind ä½¿ç”¨åœºæ™¯å’Œåº”ç”¨èƒ½åŠ›å’Œ Unocss å‡ ä¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼›ä½†æ ¹æ®ä¹ æƒ¯æˆ–è€…ä¸€èˆ¬è€Œè¨€çš„ç”Ÿæ€ï¼Œå°†åœ¨ React ä¸‹ä½¿ç”¨ Tailwindï¼ŒVue ä¸‹ä½¿ç”¨ UnoCSS



### é€šç”¨çŸ¥è¯†

##### å“åº”å¼æ–­ç‚¹ responsive breakpoints

###### å•ä½ä¸å«ä¹‰

| Breakpoint        | Class infix | Dimensions |
| ----------------- | ----------- | ---------- |
| Extra small       | *None*      | <576px     |
| Small             | `sm`        | â‰¥576px     |
| Medium            | `md`        | â‰¥768px     |
| Large             | `lg`        | â‰¥992px     |
| Extra large       | `xl`        | â‰¥1200px    |
| Extra extra large | `xxl`       | â‰¥1400px    |

æ‘˜è‡ªï¼š[BootStrap doc - layout - breakpoints # Available breakpoints](https://getbootstrap.com/docs/5.3/layout/breakpoints/#available-breakpoints)



### Taildwind CSS

#### ç¯å¢ƒé…ç½®

> ğŸ‘€ ç”±äº Next.js è‡ªåŠ¨é›†æˆäº† Tailwind CSS çš„å„ç§é…ç½®ï¼Œå¼€ç®±å³ç”¨ï¼Œç”šè‡³æä¾›äº†æ¨¡ç‰ˆ [with-tailwindcss](https://github.com/vercel/next.js/tree/canary/examples/with-tailwindcss) ( é€šè¿‡è¿è¡Œ `npx create-next-app --tailwind projName` ä½¿ç”¨ )ï¼Œä¸èƒ½è¿›è¡Œä»é›¶åˆ°ä¸€çš„é…ç½®ã€‚æ‰€ä»¥ï¼Œä½¿ç”¨ Vite äº† react-ts æ¨¡ç‰ˆå®ç°ï¼Œå…¶ä»–çš„è„šæ‰‹æ¶æ„Ÿè§‰ä¹Ÿç±»ä¼¼ã€‚

1. è¿è¡Œ `pnpm create vite tailwind-vite-demo --template react-ts` åˆ›å»ºé¡¹ç›®

2. æŒ‰ç…§å®˜æ–¹æ–‡æ¡£ [tailwindcss doc - Get started with Tailwind CSS # Using PostCSS](https://tailwindcss.com/docs/installation/using-postcss) æ‰§è¡Œ

   > âš ï¸ æ³¨æ„ï¼šè¦çœ‹ â€œUsing PostCSSâ€ ï¼ˆæˆ–è€… [Framework Guides](https://tailwindcss.com/docs/installation/framework-guides) ä¸­çš„ [Vite](https://tailwindcss.com/docs/guides/vite) éƒ¨åˆ†ï¼‰ï¼Œè€Œä¸æ˜¯é»˜è®¤çš„ â€œTailwind CLIâ€

   1. è¿è¡Œå¦‚ä¸‹å‘½ä»¤ï¼Œå®‰è£… tailwindcss postcss autoprefixerï¼Œå¹¶åˆå§‹åŒ– tailwind

      ```sh
      npm install -D tailwindcss postcss autoprefixer
      npx tailwindcss init
      ```

   2. æ·»åŠ  `postcss.config.js` é…ç½®

      ```js
      export default {
        plugins: {
          tailwindcss: {},
          autoprefixer: {},
        }
      }
      ```

      > âš ï¸ å¦‚æœè¿™é‡Œæ˜¯ Vite çš„é¡¹ç›®ï¼Œæœ€å¥½ä½¿ç”¨ ES Module çš„ `export default`ï¼ŒCJS çš„ `module.export` å¯èƒ½ä¼šè­¦å‘Šã€‚

   3. æ·»åŠ  `tailwind.config.js` é…ç½®

      ```js
      /** @type {import('tailwindcss').Config} */
      export default {
        content: [
          "./index.html",
          "./src/**/*.{js,ts,jsx,tsx}",
        ],
        theme: {
          extend: {},
        },
        plugins: [],
      }
      ```

   4. æ·»åŠ  tailwind æŒ‡ä»¤ ( Tailwind directives ) åˆ°å…¨å±€ CSS æ–‡ä»¶

      ```css
      // index.css
      @tailwind base;
      @tailwind components;
      @tailwind utilities;
      ```

   5. é…ç½®å®Œæˆï¼Œå¯ä»¥é€šè¿‡ `pnpm dev` è¿è¡Œé¡¹ç›®ï¼Œå¹¶ä½¿ç”¨ tailwind äº†



### UnoCSS

#### ç¯å¢ƒé…ç½®

1. è¿è¡Œ `npm create vue@latest` åˆ›å»ºé¡¹ç›®

2. å‚è€ƒ [UnoCSS doc - integrations - Vite Plugin](https://unocss.dev/integrations/vite) æŒ‰ç…§æ­¥éª¤æ“ä½œ

   1. å®‰è£… UnoCSS

      ```sh
      pnpm add -D unocss
      ```

   2. åœ¨ `vite.config.ts` ä¸­é…ç½® UnoCSS

      ```ts
      // vite.config.ts
      import UnoCSS from 'unocss/vite'
      import { defineConfig } from 'vite'
      
      export default defineConfig({
        plugins: [
          UnoCSS(),
        ],
      })
      ```

   3. åˆ›å»º `uno.config.ts` å¹¶é…ç½®

      ```ts
      // uno.config.ts
      import { defineConfig } from 'unocss'
      
      export default defineConfig({
        // ...UnoCSS options
      })
      ```

   4. å°† `virtual:uno.css` æ·»åŠ åˆ°ä¸»å…¥å£ ( main entry ) `main.ts` ä¸­

      ```ts
      // main.ts
      import 'virtual:uno.css'
      ```

3. å…¶ä»–é…ç½®

   ```ts
   // uno.config.ts
   import {
     defineConfig,
     presetUno,
     presetIcons,
     presetAttributify,
     presetTypography,
     presetWebFonts,
     presetTagify
   } from 'unocss'
   import presetRemToPx from '@unocss/preset-rem-to-px'
   
   export default defineConfig({
     presets: [
       presetUno(),
       presetRemToPx(),
       presetIcons(),
       presetAttributify(),
       presetTypography(),
       presetWebFonts(),
       presetTagify()
     ],
   })
   ```

   

## npm & package.json



#### npm å‘½ä»¤

##### `npm add`

> ğŸ‘€ `npm add` å‘½ä»¤æ˜¯æˆ‘åœ¨ [Vite Doc - ä½¿ç”¨æ’ä»¶ # æ·»åŠ ä¸€ä¸ªæ’ä»¶](https://cn.vitejs.dev/guide/using-plugins.html#adding-a-plugin) ä¸­çš„ `npm add -D @vitejs/plugin-legacy` å‘ç°çš„

`npm add` æ˜¯ `npm install` çš„åˆ«åã€‚

å¦å¤–ï¼Œåœ¨ npm 8.x ä¸­åŠ å…¥äº†æ–°çš„ç‰¹æ€§ï¼š `npm isntall`ã€`npm instal` åŒæ ·æ˜¯å¯ä»¥æ‰§è¡Œçš„ï¼Œä¸”æ•ˆæœå’Œ `npm install` ä¸€è‡´ï¼ˆæ¢å¥è¯è¯´ï¼šä»¥ä¸Šå‘½ä»¤æ˜¯ `npm install` çš„åˆ«åï¼‰ã€‚æ‰€ä»¥ï¼š`npm install` ä¸€å…±æœ‰ `i, in, ins, inst, insta, instal, isnt, isnta, isntal, isntall` è¿™åä¸ªåˆ«å

æ‘˜è‡ªï¼š[NPMè¿™6ä¸ªæœ‰è¶£å®ç”¨çš„çŸ¥è¯†ç‚¹ï¼Œä½ çŸ¥é“å‡ ä¸ªï¼ŸğŸ¤©](https://juejin.cn/post/7095903278084390948)



##### `npm home` & `npm repo`

`npm home PACKAGE_NAME`  å¯ä»¥ç”¨äºæ‰“å¼€ PACKAGE_NAME å¯¹åº”çš„ä¸»é¡µï¼Œæ¯”å¦‚ `npm home react` å°†ä¼šæ‰“å¼€ `https://react.dev`

`npm repo PACKAGE_NAME`  å¯ä»¥ç”¨äºæ‰“å¼€ PACKAGE_NAME å¯¹åº”çš„ä»“åº“åœ°å€ï¼Œæ¯”å¦‚ `npm repo react` å°†ä¼šæ‰“å¼€ [Github repo - react - packages - react](https://github.com/facebook/react/tree/HEAD/packages/react)

å­¦ä¹ è‡ªï¼š[N ä¸ªå€¼å¾—ä¸€çœ‹çš„å‰ç«¯ä»£ç ç‰‡æ®µ](https://juejin.cn/post/7371312967781777418)



#### npx

##### npm vs npx

###### npm

ç”¨äºå®‰è£…å’Œç®¡ç† Node.js åŒ…ï¼Œé€šè¿‡ `package.json` æ–‡ä»¶ç®¡ç†é¡¹ç›®ä¾èµ–ã€‚

é€šè¿‡ `npm install {your-package}` å‘½ä»¤å®‰è£…åŒ…ï¼Œå¹¶æ£€æŸ¥ `package.json` æ–‡ä»¶ä¸­çš„ä¾èµ–é¡¹ã€‚

###### npx

ç”¨äº<font color=red>ç›´æ¥æ‰§è¡Œ npm åŒ…</font>ï¼Œ<font color=red>**æ— éœ€å…¨å±€å®‰è£…**</font>ï¼Œ<font color=red>ç‰¹åˆ«é€‚ç”¨äºä¸€æ¬¡æ€§ä½¿ç”¨çš„åŒ…</font>ã€‚

é€šè¿‡ `npx {package-name}` å‘½ä»¤ç›´æ¥æ‰§è¡ŒåŒ…ï¼Œå¦‚æœåŒ…æœªå®‰è£…ï¼Œnpx ä¼šè‡ªåŠ¨ä¸‹è½½å¹¶æ‰§è¡Œã€‚ä¾‹å¦‚ï¼Œ`npx create-react-app my-app` å¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªæ–°çš„ React åº”ç”¨ã€‚

###### å½±å“

è¿™ç§å¯¹ npm å’Œ npx çš„æ¸…æ™°åŒºåˆ†æœ‰åŠ©äºå¼€å‘è€…æ›´æœ‰æ•ˆåœ°é€‰æ‹©å’Œä½¿ç”¨å·¥å…·ã€‚<font color=red>ç‰¹åˆ«æ˜¯å¯¹äºé‚£äº›éœ€è¦é¢‘ç¹æµ‹è¯•å’Œéƒ¨ç½²æ–°åŒ…çš„å¼€å‘è€…ï¼Œnpx æä¾›äº†ä¸€ç§æ›´åŠ ä¾¿æ·å’Œé«˜æ•ˆçš„æ–¹å¼</font>ã€‚æ­¤å¤–ï¼Œè¿™ä¹Ÿä¿ƒè¿›äº† Node.js ç”Ÿæ€ç³»ç»Ÿçš„å¥åº·å‘å±•ï¼Œä½¿å¾—åŒ…çš„ç®¡ç†å’Œæ‰§è¡Œæ›´åŠ è§„èŒƒå’Œé«˜æ•ˆã€‚

###### ç»“è®º

æ€»çš„æ¥è¯´ï¼Œnpm å’Œ npx åœ¨ Node.js å¼€å‘ä¸­å„æœ‰å…¶ç‹¬ç‰¹çš„è§’è‰²å’Œä¼˜åŠ¿ã€‚npm ä¸»è¦ç”¨äºåŒ…çš„ç®¡ç†å’Œå®‰è£…ï¼Œè€Œ npx åˆ™æä¾›äº†ä¸€ç§æ›´åŠ çµæ´»å’Œä¾¿æ·çš„åŒ…æ‰§è¡Œæ–¹å¼ã€‚

æ‘˜è‡ªï¼š[ã€æ—©é˜…ã€‘npm vs npx - åŸºæœ¬åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ](https://mp.weixin.qq.com/s/m8mnxTDNVbBV8VOSawHJ2Q) ï¼ŒåŸæ–‡ [npm vs npx â€” What are the Basic Difference?](https://dev.to/shariqahmed525/npm-vs-npx-what-are-the-basic-difference-57dk)



#### `.npmrc` ç›¸å…³

##### `.npmrc` çš„ä¼˜åŠ¿

ç›¸è¾ƒä½¿ç”¨ `npm config set registry registryUrl` çš„æ–¹å¼ï¼Œä¿®æ”¹ npm çš„æºçš„é…ç½®ï¼ŒåŒæ—¶ä¹Ÿä¿®æ”¹äº†  `~/.npmrc` ä¸­çš„é…ç½®ã€‚è€Œä½¿ç”¨ `.npmrc`ï¼ˆä¸ä»…ä»…æ˜¯ `~/.npmrc` ï¼Œè¯¦è§ [[#` .npmrc` ç›¸å…³æ–‡æ¡£æ‘˜æŠ„]] ï¼‰ æ˜¯æ›´å¥½çš„é€‰æ‹©ï¼šå› ä¸ºå®ƒæä¾›äº†æ›´ç»†ç²’åº¦çš„é…ç½®ï¼Œæ¯”å¦‚ æ¯ä¸ªé¡¹ç›®ä¸­local çš„ `.npmrc` ã€‚

ä¼šæœ‰è¿™æ ·ä¸€ä¸ªé—®é¢˜ï¼šå¦‚æœå¸Œæœ›éƒ¨åˆ†ä¾èµ–ä¸‹è½½è‡ªé»˜è®¤çš„æŸä¸ªæºï¼Œè€Œå¦ä¸€éƒ¨åˆ†çš„ä¾èµ–ä¸‹è½½è‡ªå¦ä¸€ä¸ªæºï¼Œä½¿ç”¨ `npm config set registry registryUrl` çš„æ–¹å¼æ˜¾ç„¶æ— æ³•è§£å†³ï¼›è¿™æ—¶å¯ä»¥åœ¨ `~/.npmrc` ä¸­é…ç½®ã€‚

```ini
registry = https://registry.npm.taobao.org/
@juejin:registry = https://siyouyuan.org/
```

ä»¥ä¸Šä¸¤è¡Œä»£ç åˆ†åˆ«åšäº†å¦‚ä¸‹ä¸¤ä»¶äº‹ï¼š

1. `@juejin` å‘½åç©ºé—´çš„é¡¹ç›®ï¼Œç›´æ¥åœ¨ç§æœ‰æºè¯·æ±‚åŒ…
2. å…¶ä»–åŒ…åˆ™ä» `taobao` æºå‘èµ·è¯·æ±‚ã€‚

å­¦ä¹ è‡ªï¼š[NPMè¿™6ä¸ªæœ‰è¶£å®ç”¨çš„çŸ¥è¯†ç‚¹ï¼Œä½ çŸ¥é“å‡ ä¸ªï¼ŸğŸ¤©](https://juejin.cn/post/7095903278084390948)

##### ` .npmrc` ç›¸å…³æ–‡æ¡£æ‘˜æŠ„

###### Files

The four relevant files are

- per-project config file ( `/path/to/my/project/.npmrc` ) ğŸ‘€ local config

  When working locally in a project, a `.npmrc` file <font color=LightSeaGreen>in the root of the project</font> (ie, a sibling of `node_modules` and `package.json`) will set config values specific to this project.

  Note that <font color=LightSeaGreen>this only applies to the root of the project</font> that you're running npm inï¼ˆğŸŒ è¿è¡Œï¼‰. It has no effect when your module is published. For example, you can't publish a module that forces itself to install globally, or in a different location.

  Additionally, this file is not read in global mode, such as when running `npm install -g`.

- per-user config file ( `~/.npmrc` ) ğŸ‘€ user config

  `$HOME/.npmrc` (or the `userconfig` param, if set in the environment or on the command line)

- global config file ( `$PREFIX/etc/npmrc` ) ğŸ‘€ global config

  `$PREFIX/etc/npmrc` (or the `globalconfig` param, if set above): This file is an ini-file formatted list of `key = value` parameters. Environment variables can be replaced as above.

- npm built-in config file ( `/path/to/npm/npmrc` )

  This is an <font color=red>unchangeable "builtin" configuration file</font> that <font color=red>npm keeps consistent across updates</font>. Set fields in here using the `./configure` script that comes with npm. This is primarily for distribution maintainers to override default configs in a standard and consistent manner.

> ğŸ‘€ æ„Ÿè§‰å¯ä»¥å’Œ Git çš„ localã€globalã€system ä¸‰ç§ä½œç”¨åŸŸåšä¸€ä¸‹ç±»æ¯”

All npm config files are an <font color=red>**ini-formatted** list of `key = value` parameters</font>. Environment variables can be replaced using `${VARIABLE_NAME}` . For example:

```ini
prefix = ${HOME}/.npm-packages
```

Each of these files is loaded, and <font color=red>config options are resolved in priority order</font>ï¼ˆğŸŒ æŒ‰ä¼˜å…ˆé¡ºåºæ’åˆ—ï¼‰. For example, a setting in the <font color=LightSeaGreen>userconfig file would override the setting in the globalconfig file</font>.

<font color=dodgerBlue>Array values are specified by adding "[]" after the key name</font>. For example:

```ini
key[] = "first value"
key[] = "second value"
```

###### Comments

Lines in `.npmrc` files are interpreted as comments when they begin with a `;` or `#` character. `.npmrc` files are parsed by [npm/ini](https://github.com/npm/ini), which specifies this comment syntax. For example:

```ini
# last modified: 01 Jan 2016
; Set a new registry for a scoped package
@myscope:registry=https://mycustomregistry.example.org
```

###### Auth related configuration

The settings `_auth`, `_authToken`, `username` and `_password` must all be scopedï¼ˆğŸŒ é™å®šèŒƒå›´çš„ï¼‰ to a specific registry. <font color=red>This ensures that `npm` will never send credentials to the wrong host</font>.

<font color=dodgerBlue>The full list is:</font>

- `_auth` (base64 authentication string)
- `_authToken` (authentication token)
- `username`
- `_password`
- `email`
- `certfile` (path to certificate file)
- `keyfile` (path to key file)

<font color=red>In order to scope these values, they must be prefixed by a URI fragment</font>. If the credential is meant for any request to a registry on a single host, the scope may look like `//registry.npmjs.org/:`. If it must be scoped to a specific path on the host that path may also be provided, such as `//my-custom-registry.org/unique/path:`.

```ini
; bad config
_authToken=MYTOKEN

; good config
@myorg:registry=https://somewhere-else.com/myorg
@another:registry=https://somewhere-else.com/another
//registry.npmjs.org/:_authToken=MYTOKEN
; would apply to both @myorg and @another
; //somewhere-else.com/:_authToken=MYTOKEN
; would apply only to @myorg
//somewhere-else.com/myorg/:_authToken=MYTOKEN1
; would apply only to @another
//somewhere-else.com/another/:_authToken=MYTOKEN2
```

æ‘˜è‡ªï¼š[npm Docs - .npmrc](https://docs.npmjs.com/cli/v9/configuring-npm/npmrc)

##### `.yarnrc` è¡¥å……

###### ç¾¤å‹çš„ç»å†ä¸ç»éªŒ

> åœ¨ M1 ç”µè„‘ä¸Šè·‘ taro2 é¡¹ç›®çš„æ—¶å€™å‡ºç°äº†å®‰è£… node-sass çš„é—®é¢˜ï¼Œä¸»è¦åŸå› æ˜¯æœ¬åœ°ç”µè„‘ç¯å¢ƒå­˜åœ¨ 2 ä¸ª python ç¯å¢ƒï¼ŒPython2 å’Œ Python3, ç¼–è¯‘ node-sass éœ€è¦ä½¿ç”¨ Python2ï¼Œä½†æ˜¯é»˜è®¤ä¼šä½¿ç”¨ Python3ï¼Œå§‹ç»ˆç¼–è¯‘ä¸è¿‡ï¼ŒæŠ˜è…¾äº†å¤§åŠå¤©
> æœ€ååœ¨åŒäº‹çš„æé†’ä¸‹ï¼Œåœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ `.yarnrc` ä¸­æŒ‡å®šä¸‹ python è·¯å¾„å°±å¥½äº†ã€‚
>
> æ¥è‡ªï¼šCodingStartup ç¾¤å‹



#### æŒ‡å®šé¡¹ç›®è¿è¡Œçš„ç³»ç»Ÿç¯å¢ƒ

> ğŸ‘€ ç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒ [npm doc - version 8 - package.json](https://docs.npmjs.com/cli/v8/configuring-npm/package-json)

##### æŒ‡å®š é¡¹ç›®è¿è¡Œçš„ Node ç‰ˆæœ¬

å¦‚ä½•æŒ‡å®šé¡¹ç›®è¿è¡Œçš„ Node ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ `package.json` ä¸­é…ç½® `engines` é€‰é¡¹ï¼›å¦‚ä¸‹ç¤ºä¾‹ï¼š

```json
{
  "engines": {
    "node": ">=0.10.3 <15"
  }
}
```

##### æŒ‡å®š é¡¹ç›®è¿è¡Œçš„ OS å’Œ CPU ç‰ˆæœ¬

```json
{
  "os": [
    "darwin",
    "linux"
  ],
  "cpu": [
    "x64",
    "ia32"
  ]
}
```

æ‘˜è‡ªï¼š[npm doc - version 8 - package.json](https://docs.npmjs.com/cli/v8/configuring-npm/package-json)



##### ä¿®æ”¹ node_modules ä¾èµ–ä»£ç 

æƒ³è¦ä¿®æ”¹ node_modules ä¸­ä¾èµ–éƒ¨åˆ†çš„ä»£ç ï¼ˆæ¯”å¦‚è¯´ï¼šå­˜åœ¨ bugï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ [patch-package](https://github.com/ds300/patch-package) ï¼Œè¿™ä¸ªå¯ä»¥è¯´æ˜¯å½“å‰çš„ æœ€ä½³å®è·µã€‚

> **About**
>
> Fix broken node modules instantly ğŸƒğŸ½â€â™€ï¸ğŸ’¨

å¦å¤–ï¼Œè¿™ä¸ªåŠŸèƒ½è¢« pnpm å†…ç½®äº† [`pnpm patch <pkg>`](https://pnpm.io/zh/cli/patch)



### corepack

##### ç®€è¦ä»‹ç»

As per [Node.js](https://nodejs.org/api/corepack.html) documentation, the corepack <font color=red>identifies the package manager</font> and <font color=red>installs in the background if needed without any user interaction</font>.

æ‘˜è‡ªï¼š[How to Configure a React App with TypeScript, TailwindCSS, Yarn and Storybook](https://blog.bitsrc.io/how-to-configure-a-react-app-with-typescript-tailwindcss-yarn-and-storybook-a271df5d9884)

##### What's Corepack

Corepack <font color=red>makes sure you are using the correct version for package manager</font> when you run corresponding commands. <font color=red>Projects might have `packageManager` field in their `package.json`</font> .

Under projects with configuration as shown on the rightï¼ˆ ğŸ‘€ ç°åœ¨æ˜¯ below äº† ï¼‰, <font color=red>corepack will install `v7.1.5` of `pnpm` (if you don't have it already)</font> and use it to run your commands. <font color=fuchsia>This makes sure everyone working on this project have the same behavior for the dependencies and the lockfile</font>.

```json
// package.json
{
  "packageManager": "pnpm@7.1.5"
}
```

æ‘˜è‡ªï¼š[GitHub - antfu/contribute](https://github.com/antfu/contribute)

#### Node Doc Intro

> ğŸ’¡ Added in: v16.9.0, v14.19.0

##### ç®€ä»‹

*[Corepack](https://github.com/nodejs/corepack)* is an <font color=red>*experimental tool*</font> to <font color=red>help with **managing versions of your package managers**</font>. It <font color=fuchsia>exposes **binary proxies**</font>ï¼ˆğŸ‘€ æœ¬è´¨ä¸Šæ˜¯ åŒ…ç®¡ç†å·¥å…·çš„ äºŒè¿›åˆ¶**ä»£ç†** ï¼‰<font color=fuchsia>for each supported package manager</font>ï¼ˆ ğŸ‘€ ç›®å‰æ˜¯ pnpm å’Œ yarn ï¼‰ that, <font color=dodgerBlue>when called</font>, <font color=red>will identify whatever package manager is configured for the current project</font>, download it if needed, and finally run it.

Despite <font color=red>Corepack **being distributed with default installs of Node.js**</font>, the package managers managed by Corepack are not part of the Node.js distribution and:

- <font color=dodgerBlue>Upon first use</font>, <font color=red>Corepack downloads the latest version from the network</font>.
- Any required updates (related to security vulnerabilities or otherwise) are out of scope of the Node.js project. If necessary end users must figure out how to update on their own.

<font color=dodgerBlue>This feature simplifies two core workflows:</font>

- <font color=LightSeaGreen>It eases new contributor onboarding</font>ï¼ˆåŠ å…¥ï¼‰, since they won't have to follow system-specific installation processes anymore just to have the package manager you want them to.
- It allows you to <font color=LightSeaGreen>ensure that everyone in your team will **use exactly the package manager version** you intend them to</font>, without them having to manually synchronize it each time you need to make an update.

##### Workflows

###### Enabling the feature

<font color=dodgerBlue>Due to its experimental status</font>, Corepack currently needs to be explicitly enabled to have any effect. To do that, <font color=red>run `corepack enable`</font> , which <font color=red>will set up the symlinks in your environment next to the `node` binary</font> (and overwrite the existing symlinks if necessary).

From this point forward, any call to the *supported binaries*ï¼ˆğŸ‘€ å³ supported package manager ï¼‰ will work without further setup. Should you experience a problem, <font color=red>run `corepack disable` to remove the proxies from your system</font> (and consider opening an issue on the [Corepack repository](https://github.com/nodejs/corepack) to let us know).

###### Configuring a package

The <font color=red>Corepack proxies will **find the closest `package.json` file in your current directory hierarchy**</font> to <font color=fuchsia>extract its `"packageManager"` property</font>.

If the value corresponds to a *supported package manager*, Corepack will make sure that all calls to the relevant binaries are run against the requested version, downloading it on demand if needed, and aborting if it cannot be successfully retrieved.

###### Upgrading the global versions

When running outside of an existing project (for example when running `yarn init` ) , <font color=red>Corepack will **by default** use predefined versions roughly corresponding to the latest stable releases from each tool</font>. <font color=fuchsia>Those versions can be overridden by running the `corepack prepare` command</font> along with the package manager version you wish to set:

```bash
corepack prepare yarn@x.y.z --activate
```

Alternately, a tag or range may be used:

```bash
corepack prepare pnpm@latest --activate
corepack prepare yarn@stable --activate
```

æ‘˜è‡ªï¼š[Node doc - Corepack](https://nodejs.org/api/corepack.html)



## Vite

<font color=dodgerBlue>å‰ç«¯å·¥ç¨‹éƒ½æœ‰å“ªäº›ç—›ç‚¹å‘¢ï¼Ÿ</font>

é¦–å…ˆæ˜¯å‰ç«¯çš„ **æ¨¡å—åŒ–éœ€æ±‚**ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œä¸šç•Œçš„æ¨¡å—æ ‡å‡†éå¸¸å¤šï¼ŒåŒ…æ‹¬ ESMã€CommonJSã€AMD å’Œ CMD ç­‰ç­‰ã€‚å‰ç«¯å·¥ç¨‹ä¸€æ–¹é¢éœ€è¦è½å®è¿™äº›æ¨¡å—è§„èŒƒï¼Œä¿è¯æ¨¡å—æ­£å¸¸åŠ è½½ï¼›<font color=lightSeaGreen>å¦ä¸€æ–¹é¢éœ€è¦å…¼å®¹ä¸åŒçš„æ¨¡å—è§„èŒƒï¼Œä»¥é€‚åº”ä¸åŒçš„æ‰§è¡Œç¯å¢ƒ</font>ã€‚

å…¶æ¬¡æ˜¯**å…¼å®¹æµè§ˆå™¨ï¼Œç¼–è¯‘é«˜çº§è¯­æ³•**ã€‚ç”±äºæµè§ˆå™¨çš„å®ç°è§„èŒƒæ‰€é™ï¼Œåªè¦é«˜çº§è¯­è¨€/è¯­æ³•ï¼ˆTypeScriptã€ JSX ç­‰ï¼‰æƒ³è¦åœ¨æµè§ˆå™¨ä¸­æ­£å¸¸è¿è¡Œï¼Œå°±å¿…é¡»è¢«è½¬åŒ–ä¸ºæµè§ˆå™¨å¯ä»¥ç†è§£çš„å½¢å¼ã€‚è¿™éƒ½éœ€è¦å·¥å…·é“¾å±‚é¢çš„æ”¯æŒï¼Œè€Œä¸”è¿™ä¸ªéœ€æ±‚ä¼šä¸€ç›´å­˜åœ¨ã€‚

å†è€…æ˜¯**çº¿ä¸Šä»£ç çš„è´¨é‡**é—®é¢˜ã€‚å’Œå¼€å‘é˜¶æ®µçš„è€ƒè™‘ä¾§é‡ç‚¹ä¸åŒï¼Œç”Ÿäº§ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬<font color=red>ä¸ä»…è¦è€ƒè™‘ä»£ç çš„ å®‰å…¨æ€§ã€å…¼å®¹æ€§é—®é¢˜ï¼Œä¿è¯çº¿ä¸Šä»£ç çš„æ­£å¸¸è¿è¡Œï¼Œä¹Ÿéœ€è¦è€ƒè™‘ä»£ç è¿è¡Œæ—¶çš„æ€§èƒ½é—®é¢˜</font>ã€‚ç”±äºæµè§ˆå™¨çš„ç‰ˆæœ¬ä¼—å¤šï¼Œä»£ç å…¼å®¹æ€§å’Œå®‰å…¨ç­–ç•¥å„ä¸ç›¸åŒï¼Œçº¿ä¸Šä»£ç çš„è´¨é‡é—®é¢˜ä¹Ÿå°†æ˜¯å‰ç«¯å·¥ç¨‹ä¸­é•¿æœŸå­˜åœ¨çš„ä¸€ä¸ªç—›ç‚¹ã€‚

åŒæ—¶ï¼Œå¼€å‘æ•ˆç‡ä¹Ÿä¸å®¹å¿½è§†ã€‚ æˆ‘ä»¬çŸ¥é“ï¼Œ**é¡¹ç›®çš„å†·å¯åŠ¨/äºŒæ¬¡å¯åŠ¨æ—¶é—´**ã€**çƒ­æ›´æ–°æ—¶é—´** éƒ½å¯èƒ½ä¸¥é‡å½±å“å¼€å‘æ•ˆç‡ï¼Œå°¤å…¶æ˜¯å½“é¡¹ç›®è¶Šæ¥è¶Šåºå¤§çš„æ—¶å€™ã€‚å› æ­¤ï¼Œæé«˜é¡¹ç›®çš„å¯åŠ¨é€Ÿåº¦å’Œçƒ­æ›´æ–°é€Ÿåº¦ä¹Ÿæ˜¯å‰ç«¯å·¥ç¨‹çš„é‡è¦éœ€æ±‚ã€‚

é‚£ä¹ˆï¼Œ<font color=dodgerBlue>å‰ç«¯æ„å»ºå·¥å…·æ˜¯å¦‚ä½•è§£å†³ä»¥ä¸Šé—®é¢˜çš„å‘¢ï¼Ÿ</font>

<img src="https://s2.loli.net/2024/02/29/96DxvlrIFdHgkCO.webp" style="zoom:45%;" />

- æ¨¡å—åŒ–æ–¹é¢ï¼Œæä¾›æ¨¡å—åŠ è½½æ–¹æ¡ˆï¼Œå¹¶å…¼å®¹ä¸åŒçš„æ¨¡å—è§„èŒƒã€‚
- è¯­æ³•è½¬è¯‘æ–¹é¢ï¼Œ<font color=lightSeaGreen>é…åˆ `Sass`ã€`TSC`ã€`Babel` ç­‰å‰ç«¯å·¥å…·é“¾ï¼Œå®Œæˆé«˜çº§è¯­æ³•çš„è½¬è¯‘åŠŸèƒ½</font>ï¼ŒåŒæ—¶å¯¹äºé™æ€èµ„æºä¹Ÿèƒ½è¿›è¡Œå¤„ç†ï¼Œä½¿ä¹‹èƒ½ä½œä¸ºä¸€ä¸ªæ¨¡å—æ­£å¸¸åŠ è½½ã€‚
- äº§ç‰©è´¨é‡æ–¹é¢ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé…åˆ `Terser` ç­‰å‹ç¼©å·¥å…·è¿›è¡Œä»£ç å‹ç¼©å’Œæ··æ·†ï¼Œé€šè¿‡ `Tree Shaking` åˆ é™¤æœªä½¿ç”¨çš„ä»£ç ï¼Œæä¾›å¯¹äºä½ç‰ˆæœ¬æµè§ˆå™¨çš„è¯­æ³•é™çº§å¤„ç†ç­‰ç­‰ã€‚
- å¼€å‘æ•ˆç‡æ–¹é¢ï¼Œæ„å»ºå·¥å…·æœ¬èº«é€šè¿‡å„ç§æ–¹å¼æ¥è¿›è¡Œæ€§èƒ½ä¼˜åŒ–ï¼ŒåŒ…æ‹¬ ä½¿ç”¨åŸç”Ÿè¯­è¨€ Go/Rustã€<font color=red>no-bundle</font> ç­‰ç­‰æ€è·¯ï¼Œæé«˜é¡¹ç›®çš„å¯åŠ¨æ€§èƒ½å’Œçƒ­æ›´æ–°çš„é€Ÿåº¦ã€‚

##### Vite çš„ä¼˜ç‚¹

ä¸€æ–¹é¢ï¼Œ<font color=fuchsia>Vite åœ¨å¼€å‘é˜¶æ®µåŸºäºæµè§ˆå™¨åŸç”Ÿ ESM çš„æ”¯æŒå®ç°äº† **`no-bundle`** æœåŠ¡</font>ï¼Œå¦ä¸€æ–¹é¢å€ŸåŠ© esbuild è¶…å¿«çš„ç¼–è¯‘é€Ÿåº¦æ¥åšç¬¬ä¸‰æ–¹åº“æ„å»ºå’Œ TS / JSX è¯­æ³•ç¼–è¯‘ï¼Œä»è€Œèƒ½å¤Ÿæœ‰æ•ˆæé«˜å¼€å‘æ•ˆç‡ã€‚

<font color=dodgerBlue>é™¤äº†å¼€å‘æ•ˆç‡ï¼Œåœ¨å…¶ä»–ä¸‰ä¸ªç»´åº¦ä¸Šï¼Œ Vite ä¹Ÿè¡¨ç°ä¸ä¿—</font>ã€‚

- æ¨¡å—åŒ–æ–¹é¢ï¼ŒVite åŸºäºæµè§ˆå™¨åŸç”Ÿ ESM çš„æ”¯æŒå®ç°æ¨¡å—åŠ è½½ï¼Œ<font color=red>å¹¶ä¸”æ— è®ºæ˜¯å¼€å‘ç¯å¢ƒè¿˜æ˜¯ç”Ÿäº§ç¯å¢ƒï¼Œéƒ½å¯ä»¥å°†å…¶ä»–æ ¼å¼çš„äº§ç‰©ï¼ˆå¦‚ CommonJS ï¼‰è½¬æ¢ä¸º ESM</font> ã€‚
- è¯­æ³•è½¬è¯‘æ–¹é¢ï¼ŒVite å†…ç½®äº†å¯¹ TypeScriptã€JSXã€Sass ç­‰é«˜çº§è¯­æ³•çš„æ”¯æŒï¼Œä¹Ÿèƒ½å¤ŸåŠ è½½å„ç§å„æ ·çš„é™æ€èµ„æºï¼Œå¦‚å›¾ç‰‡ã€Worker ç­‰ç­‰ã€‚
- äº§ç‰©è´¨é‡æ–¹é¢ï¼ŒVite åŸºäºæˆç†Ÿçš„æ‰“åŒ…å·¥å…· Rollup å®ç°ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…ï¼ŒåŒæ—¶å¯ä»¥é…åˆ Terserã€Babel ç­‰å·¥å…·é“¾ï¼Œå¯ä»¥æå¤§ç¨‹åº¦ä¿è¯æ„å»ºäº§ç‰©çš„è´¨é‡ã€‚



##### Vite é¢„æ„å»º

<font color=dodgerBlue>ä¾èµ–é¢„æ„å»ºä¸»è¦åšäº†ä¸¤ä»¶äº‹æƒ…ï¼š</font>

- ä¸€æ˜¯å°†å…¶ä»–æ ¼å¼ï¼ˆå¦‚ UMD å’Œ CommonJS ï¼‰çš„äº§ç‰©è½¬æ¢ä¸º ESM æ ¼å¼ï¼Œä½¿å…¶åœ¨æµè§ˆå™¨é€šè¿‡ `<script type="module"><script>` çš„æ–¹å¼æ­£å¸¸åŠ è½½ã€‚

- äºŒæ˜¯æ‰“åŒ…ç¬¬ä¸‰æ–¹åº“çš„ä»£ç ï¼Œå°†å„ä¸ªç¬¬ä¸‰æ–¹åº“åˆ†æ•£çš„æ–‡ä»¶åˆå¹¶åˆ°ä¸€èµ·ï¼Œå‡å°‘ HTTP è¯·æ±‚æ•°é‡ï¼Œé¿å…é¡µé¢åŠ è½½æ€§èƒ½åŠ£åŒ–ã€‚

Vite å°†é¢„æ„å»ºç›¸å…³çš„é…ç½®é¡¹éƒ½é›†ä¸­åœ¨ `optimizeDeps` å±æ€§ä¸Š



#### Vite å®ç°

##### Vite æ¶æ„å›¾

![Vite æ¶æ„å›¾](https://s2.loli.net/2024/03/04/Co6nIzVmHJBqUgR.webp)

##### esbuild ä½œä¸ºæ‰“åŒ…å·¥å…·çš„ç¼ºç‚¹

- <font color=red>ä¸æ”¯æŒé™çº§åˆ° `ES5` çš„ä»£ç </font>ã€‚è¿™æ„å‘³ç€åœ¨ä½ç«¯æµè§ˆå™¨ä»£ç ä¼šè·‘ä¸èµ·æ¥ã€‚

- ä¸æ”¯æŒ `const enum` ç­‰è¯­æ³•ã€‚è¿™æ„å‘³ç€å•ç‹¬ä½¿ç”¨è¿™äº›è¯­æ³•åœ¨ esbuild ä¸­ä¼šç›´æ¥æŠ›é”™ã€‚

  > ğŸ’¡å¯¹äºè¿™é‡Œçš„è¯´æ³•æ„Ÿè§‰æœ‰ç‚¹å¥‡æ€ªï¼Œæ‰€ä»¥é—®äº†ä¸‹ GitHub Copilotï¼š
  >
  > <img src="https://s2.loli.net/2024/03/04/ldfOVyAcg7e8XzY.png" alt="image-20240304141838375" style="zoom:50%;" />
  >
  > <img src="https://s2.loli.net/2024/03/04/cbjEtX9kMqnLFdm.png" alt="image-20240304142003366" style="zoom:50%;" />
  >
  > æ ¹æ®ä¸Šé¢çš„è¯´æ³•ï¼šesbuild æ˜¯æ”¯æŒ ts çš„ï¼Œåªæ˜¯ä¸æ”¯æŒéƒ¨åˆ†è¯­æ³•

- <font color=red>ä¸æä¾›æ“ä½œæ‰“åŒ…äº§ç‰©çš„æ¥å£ï¼Œåƒ Rollup ä¸­çµæ´»å¤„ç†æ‰“åŒ…äº§ç‰©çš„èƒ½åŠ›</font>ï¼ˆå¦‚ `renderChunk` é’©å­ï¼‰åœ¨ esbuild å½“ä¸­å®Œå…¨æ²¡æœ‰ã€‚

- <font color=red>ä¸æ”¯æŒè‡ªå®šä¹‰ Code Splitting ç­–ç•¥</font>ã€‚ä¼ ç»Ÿçš„ Webpack å’Œ Rollup éƒ½æä¾›äº†è‡ªå®šä¹‰æ‹†åŒ…ç­–ç•¥çš„ APIï¼Œè€Œ esbuild å¹¶æœªæä¾›ï¼Œä»è€Œé™çº§äº†æ‹†åŒ…ä¼˜åŒ–çš„çµæ´»æ€§ã€‚



##### esbuild ä¸ºä»€ä¹ˆæ€§èƒ½é«˜

1. **ä½¿ç”¨ Golang å¼€å‘**ï¼Œæ„å»ºé€»è¾‘ä»£ç ç›´æ¥è¢«ç¼–è¯‘ä¸ºåŸç”Ÿæœºå™¨ç ï¼Œè€Œä¸ç”¨åƒ JS ä¸€æ ·å…ˆä»£ç è§£æä¸ºå­—èŠ‚ç ï¼Œç„¶åè½¬æ¢ä¸ºæœºå™¨ç ï¼Œå¤§å¤§èŠ‚çœäº†ç¨‹åºè¿è¡Œæ—¶é—´ã€‚
2. **å¤šæ ¸å¹¶è¡Œ**ã€‚å†…éƒ¨æ‰“åŒ…ç®—æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸ CPU ä¼˜åŠ¿ï¼Œæ‰€æœ‰çš„æ­¥éª¤å°½å¯èƒ½å¹¶è¡Œï¼Œè¿™ä¹Ÿæ˜¯å¾—ç›Šäº Go å½“ä¸­å¤šçº¿ç¨‹å…±äº«å†…å­˜çš„ä¼˜åŠ¿ã€‚
3. **ä»é›¶é€ è½®å­**ï¼š<font color=red>å‡ ä¹æ²¡æœ‰ä½¿ç”¨ä»»ä½•ç¬¬ä¸‰æ–¹åº“ï¼Œæ‰€æœ‰é€»è¾‘è‡ªå·±ç¼–å†™</font>ï¼Œå¤§åˆ° AST è§£æï¼Œå°åˆ°å­—ç¬¦ä¸²çš„æ“ä½œï¼Œä¿è¯æè‡´çš„ä»£ç æ€§èƒ½ã€‚
4. **é«˜æ•ˆçš„å†…å­˜åˆ©ç”¨**ã€‚esbuild ä¸­ä»å¤´åˆ°å°¾å°½å¯èƒ½åœ°å¤ç”¨ä¸€ä»½ AST èŠ‚ç‚¹æ•°æ®ï¼Œè€Œä¸ç”¨åƒ JS æ‰“åŒ…å·¥å…·ä¸­é¢‘ç¹åœ°è§£æå’Œä¼ é€’ AST æ•°æ®ï¼ˆå¦‚ string -> TS -> JS -> string)ï¼Œé€ æˆå†…å­˜çš„å¤§é‡æµªè´¹ã€‚



#### æ‹†åŒ…

##### åè¯è§£é‡Š

- `bundle` æŒ‡çš„æ˜¯æ•´ä½“çš„æ‰“åŒ…äº§ç‰©ï¼ŒåŒ…å« JS å’Œå„ç§é™æ€èµ„æºã€‚
- `chunk` æŒ‡çš„æ˜¯æ‰“åŒ…åçš„ JS æ–‡ä»¶ï¼Œæ˜¯ `bundle` çš„å­é›†ã€‚
- <font color=red>`vendor` æ˜¯æŒ‡ç¬¬ä¸‰æ–¹åŒ…çš„æ‰“åŒ…äº§ç‰©</font>ï¼Œæ˜¯ä¸€ç§ç‰¹æ®Šçš„ chunkã€‚

##### Code Splitting è§£å†³çš„é—®é¢˜

åœ¨ä¼ ç»Ÿçš„å• chunk æ‰“åŒ…æ¨¡å¼ä¸‹ï¼Œå½“é¡¹ç›®ä»£ç è¶Šæ¥è¶Šåºå¤§ï¼Œæœ€åä¼šå¯¼è‡´æµè§ˆå™¨ä¸‹è½½ä¸€ä¸ªå·¨å¤§çš„æ–‡ä»¶ï¼Œä»é¡µé¢åŠ è½½æ€§èƒ½çš„è§’åº¦æ¥è¯´ï¼Œä¸»è¦ä¼šå¯¼è‡´ä¸¤ä¸ªé—®é¢˜ï¼š

1. æ— æ³•åšåˆ° <font color=red>**æŒ‰éœ€åŠ è½½**</font>ï¼Œå³ä½¿æ˜¯å½“å‰é¡µé¢ä¸éœ€è¦çš„ä»£ç ä¹Ÿä¼šè¿›è¡ŒåŠ è½½ã€‚
2. çº¿ä¸Š <font color=fuchsia>**ç¼“å­˜å¤ç”¨ç‡**æä½</font>ï¼Œ<font color=red>æ”¹åŠ¨ä¸€è¡Œä»£ç å³å¯å¯¼è‡´æ•´ä¸ª bundle äº§ç‰©ç¼“å­˜å¤±æ•ˆ</font>ã€‚

å…³äºç¬¬ä¸€ç‚¹ï¼šä¸€èˆ¬è€Œè¨€ï¼Œ<font color=dodgerBlue>**ä¸€ä¸ªå‰ç«¯é¡µé¢ä¸­çš„ JS ä»£ç å¯ä»¥åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†**</font>ï¼š<font color=red>**`Initital Chunk` å’Œ `Async Chunk`**</font> ï¼Œå‰è€…æŒ‡é¡µé¢é¦–å±æ‰€éœ€è¦çš„ JS ä»£ç ï¼Œè€Œåè€…å½“å‰é¡µé¢å¹¶ä¸ä¸€å®šéœ€è¦ï¼Œä¸€ä¸ªå…¸å‹çš„ä¾‹å­å°±æ˜¯ è·¯ç”±ç»„ä»¶ï¼Œä¸å½“å‰è·¯ç”±æ— å…³çš„ç»„ä»¶å¹¶ä¸ç”¨åŠ è½½ã€‚é¡¹ç›®è¢«æ‰“åŒ…æˆå• bundle ä¹‹åï¼Œæ— è®ºæ˜¯ `Initial Chunk` è¿˜æ˜¯ `Async Chunk` ï¼Œéƒ½ä¼šæ‰“åŒ…è¿›åŒä¸€ä¸ªäº§ç‰©ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œæµè§ˆå™¨åŠ è½½äº§ç‰©ä»£ç çš„æ—¶å€™ï¼Œä¼šå°†ä¸¤è€…ä¸€èµ·åŠ è½½ï¼Œå¯¼è‡´è®¸å¤šå†—ä½™çš„åŠ è½½è¿‡ç¨‹ï¼Œä»è€Œå½±å“é¡µé¢æ€§èƒ½ã€‚<font color=red>é€šè¿‡`Code Splitting` æˆ‘ä»¬å¯ä»¥å°†æŒ‰éœ€åŠ è½½çš„ä»£ç æ‹†åˆ†å‡ºå•ç‹¬çš„ chunkï¼Œè¿™æ ·åº”ç”¨åœ¨é¦–å±åŠ è½½æ—¶åªéœ€è¦åŠ è½½ `Initial Chunk` å³å¯</font>ï¼Œé¿å…äº†å†—ä½™çš„åŠ è½½è¿‡ç¨‹ï¼Œä½¿é¡µé¢æ€§èƒ½å¾—åˆ°æå‡ã€‚

å…³äºç¬¬äºŒç‚¹ï¼šçº¿ä¸Šçš„ ç¼“å­˜å‘½ä¸­ç‡ ( ğŸ‘€ cache hint ratio ) æ˜¯ä¸€ä¸ªé‡è¦çš„æ€§èƒ½è¡¡é‡æ ‡å‡†ã€‚å¯¹äºçº¿ä¸Šç«™ç‚¹è€Œè¨€ï¼ŒæœåŠ¡ç«¯ä¸€èˆ¬åœ¨å“åº”èµ„æºæ—¶åŠ ä¸Šä¸€äº› HTTP å“åº”å¤´ï¼Œæœ€å¸¸è§çš„å“åº”å¤´ä¹‹ä¸€å°±æ˜¯ `cache-control` ï¼Œå®ƒå¯ä»¥æŒ‡å®šæµè§ˆå™¨çš„**å¼ºç¼“å­˜**ï¼Œæ¯”å¦‚è®¾ç½®ä¸ºä¸‹é¢è¿™æ ·ï¼š

```http
cache-control: max-age=31536000
```

è¡¨ç¤ºèµ„æºè¿‡æœŸæ—¶é—´ä¸ºä¸€å¹´ï¼Œåœ¨è¿‡æœŸä¹‹å‰ï¼Œè®¿é—®**ç›¸åŒçš„èµ„æº url**ï¼Œæµè§ˆå™¨ç›´æ¥åˆ©ç”¨æœ¬åœ°çš„ç¼“å­˜ï¼Œå¹¶ä¸ç”¨ç»™æœåŠ¡ç«¯å‘è¯·æ±‚ï¼Œè¿™å°±å¤§å¤§é™ä½äº†é¡µé¢åŠ è½½çš„ç½‘ç»œå¼€é”€ã€‚ä¸è¿‡ï¼Œåœ¨å• chunk æ‰“åŒ…æ¨¡å¼ä¸‹é¢ï¼Œä¸€æ—¦æœ‰ä¸€è¡Œä»£ç å˜åŠ¨ï¼Œæ•´ä¸ª chunk çš„ url åœ°å€éƒ½ä¼šå˜åŒ–ã€‚

##### Vite é»˜è®¤æ‹†åŒ…ç­–ç•¥

åœ¨ç”Ÿäº§ç¯å¢ƒä¸‹ Vite å®Œå…¨åˆ©ç”¨ Rollup è¿›è¡Œæ„å»ºï¼Œå› æ­¤æ‹†åŒ…ä¹Ÿæ˜¯åŸºäº Rollup æ¥å®Œæˆçš„ï¼Œä½† Rollup æœ¬èº«æ˜¯ä¸€ä¸ªä¸“æ³¨ JS åº“æ‰“åŒ…çš„å·¥å…·ï¼Œå¯¹åº”ç”¨æ„å»ºçš„èƒ½åŠ›è¿˜å°šä¸ºæ¬ ç¼ºï¼ŒVite æ­£å¥½æ˜¯è¡¥è¶³äº† Rollup åº”ç”¨æ„å»ºçš„èƒ½åŠ›ï¼Œåœ¨æ‹†åŒ…èƒ½åŠ›è¿™ä¸€å—çš„æ‰©å±•å°±æ˜¯å¾ˆå¥½çš„ä½“ç°ã€‚



#### è¯­æ³•é™çº§ä¸ Polyfill

<font color=dodgerBlue>æ—§ç‰ˆæµè§ˆå™¨çš„è¯­æ³•å…¼å®¹é—®é¢˜ä¸»è¦åˆ†ä¸¤ç±»ï¼š**è¯­æ³•é™çº§é—®é¢˜** å’Œ **Polyfill ç¼ºå¤±é—®é¢˜**</font>ã€‚å‰è€…æ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯”å¦‚æŸäº›æµè§ˆå™¨ä¸æ”¯æŒç®­å¤´å‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†å…¶è½¬æ¢ä¸º `function() {}` è¯­æ³•ï¼›è€Œå¯¹åè€…æ¥è¯´ï¼Œ`Polyfill` æœ¬èº«å¯ä»¥ç¿»è¯‘ä¸º â€œå«ç‰‡â€ï¼Œä¹Ÿå°±æ˜¯ä¸ºæµè§ˆå™¨æå‰æ³¨å…¥ä¸€äº› API çš„å®ç°ä»£ç ï¼Œå¦‚ `Object.entries` æ–¹æ³•çš„å®ç°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº§ç‰©å¯ä»¥æ­£å¸¸ä½¿ç”¨è¿™äº› APIï¼Œé˜²æ­¢æŠ¥é”™ã€‚

<font color=fuchsia>è¿™ä¸¤ç±»é—®é¢˜æœ¬è´¨ä¸Šæ˜¯é€šè¿‡å‰ç«¯çš„ **ç¼–è¯‘å·¥å…·é“¾ï¼ˆå¦‚ `Babel` ï¼‰** åŠ **JS çš„åŸºç¡€ Polyfill åº“ï¼ˆå¦‚ `core-js` ï¼‰**æ¥è§£å†³çš„</font>ï¼Œä¸ä¼šè·Ÿå…·ä½“çš„æ„å»ºå·¥å…·æ‰€ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºè¿™äº›æœ¬è´¨çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨å…¶å®ƒçš„æ„å»ºå·¥å…·ï¼ˆå¦‚ Webpack ï¼‰èƒ½ä½¿ç”¨ï¼Œåœ¨ Vite å½“ä¸­ä¹Ÿå®Œå…¨å¯ä»¥ä½¿ç”¨ã€‚

##### åº•å±‚å·¥å…·é“¾

è§£å†³ä¸Šè¿°æåˆ°çš„ä¸¤ç±»è¯­æ³•å…¼å®¹é—®é¢˜ï¼Œ<font color=dodgerBlue>ä¸»è¦éœ€è¦ç”¨åˆ°ä¸¤æ–¹é¢çš„å·¥å…·</font>ï¼Œåˆ†åˆ«åŒ…æ‹¬ï¼š

- **ç¼–è¯‘æ—¶å·¥å…·**ã€‚ä»£è¡¨å·¥å…·æœ‰ `@babel/preset-env` å’Œ `@babel/plugin-transform-runtime` ã€‚
- **è¿è¡Œæ—¶åŸºç¡€åº“**ã€‚ä»£è¡¨åº“åŒ…æ‹¬ `core-js` å’Œ `regenerator-runtime` ã€‚

**ç¼–è¯‘æ—¶å·¥å…·**çš„ä½œç”¨æ˜¯åœ¨ä»£ç ç¼–è¯‘é˜¶æ®µè¿›è¡Œ**è¯­æ³•é™çº§**åŠ**æ·»åŠ  `polyfill` ä»£ç çš„å¼•ç”¨è¯­å¥**ï¼Œå¦‚ï¼š

```ts
import "core-js/modules/es6.set.js"
```

ç”±äºè¿™äº›å·¥å…·åªæ˜¯ç¼–è¯‘é˜¶æ®µç”¨åˆ°ï¼Œè¿è¡Œæ—¶å¹¶ä¸éœ€è¦ï¼Œéœ€è¦å°†å…¶æ”¾å…¥ `package.json` ä¸­çš„ `devDependencies` ä¸­ã€‚

**è¿è¡Œæ—¶åŸºç¡€åº“**æ˜¯æ ¹æ® ECMAScript å®˜æ–¹è¯­è¨€è§„èŒƒæä¾›å„ç§ Polyfill å®ç°ä»£ç ï¼Œä¸»è¦åŒ…æ‹¬ `core-js` å’Œ `regenerator-runtime` ä¸¤ä¸ªåŸºç¡€åº“ï¼Œä¸è¿‡åœ¨ babel ä¸­ä¹Ÿä¼šæœ‰ä¸€äº›ä¸Šå±‚çš„å°è£…ï¼ŒåŒ…æ‹¬ï¼š

- [`@babel/polyfill`](https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-polyfill)
- [`@babel/runtime`](https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-runtime)
- [`@babel/runtime-corejs2`](https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-runtime-corejs2)
- [`@babel/runtime-corejs3`](https://link.juejin.cn/?target=https%3A%2F%2Fbabeljs.io%2Fdocs%2Fen%2Fbabel-runtime-corejs3) 

<font color=lightSeaGreen>çœ‹ä¼¼å„ç§è¿è¡Œæ—¶åº“çœ¼èŠ±ç¼­ä¹±</font>ï¼Œ<font color=red>å…¶å®Â **éƒ½æ˜¯ `core-js` å’Œ `regenerator-runtime` ä¸åŒç‰ˆæœ¬çš„å°è£…** ç½¢äº†</font>ï¼ˆ <font color=red>`@babel/runtime` æ˜¯ä¸ªç‰¹ä¾‹ï¼Œä¸åŒ…å« `core-js` çš„ Polyfill</font> ï¼‰ã€‚è¿™ç±»åº“æ˜¯é¡¹ç›®è¿è¡Œæ—¶å¿…é¡»è¦ä½¿ç”¨åˆ°çš„ï¼Œå› æ­¤ä¸€å®šè¦æ”¾åˆ° `package.json` ä¸­çš„ `dependencies` ä¸­ã€‚

##### å®é™…ä½¿ç”¨

å®‰è£…ä¸€äº›å¿…è¦çš„ä¾èµ–ï¼š

```bash
pnpm i @babel/cli @babel/core @babel/preset-env
```

<font color=dodgerBlue>å„ä¸ªä¾èµ–çš„ä½œç”¨ï¼š</font>

- `@babel/cli` ï¼šä¸º babel å®˜æ–¹çš„è„šæ‰‹æ¶å·¥å…·ï¼Œå¾ˆé€‚åˆæˆ‘ä»¬ç»ƒä¹ ç”¨ã€‚
- `@babel/core` ï¼šbabel æ ¸å¿ƒç¼–è¯‘åº“ã€‚
- `@babel/preset-env` ï¼šbabel çš„é¢„è®¾å·¥å…·é›†ï¼ŒåŸºæœ¬ä¸º babel å¿…è£…çš„åº“ã€‚

åœ¨æµ‹è¯•é¡¹ç›®ä¸­ç¼–å†™ç¤ºä¾‹ä»£ç ï¼š

```js
const func = async () => {
  console.log(12123)
}

Promise.resolve().finally();
```

å¯ä»¥çœ‹åˆ°ï¼Œç¤ºä¾‹ä»£ç ä¸­æ—¢åŒ…å«äº†â€œé«˜çº§è¯­æ³•â€ä¹ŸåŒ…å«ç°ä»£æµè§ˆå™¨çš„ API ï¼Œæ­£å¥½å¯ä»¥é’ˆå¯¹è¯­æ³•é™çº§å’Œ Polyfill æ³¨å…¥ä¸¤ä¸ªåŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚

æ–°å»º `babelrc.json` å³ babel çš„é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```json
{
  "presets": [
    [
      "@babel/preset-env", 
      {
        // æŒ‡å®šå…¼å®¹çš„æµè§ˆå™¨ç‰ˆæœ¬
        "targets": {
          "ie": "11"
        },
        // åŸºç¡€åº“ core-js çš„ç‰ˆæœ¬ï¼Œä¸€èˆ¬æŒ‡å®šä¸ºæœ€æ–°çš„å¤§ç‰ˆæœ¬
        "corejs": 3,
        // Polyfill æ³¨å…¥ç­–ç•¥ï¼Œåæ–‡è¯¦ç»†ä»‹ç»
        "useBuiltIns": "usage",
        // ä¸å°† ES æ¨¡å—è¯­æ³•è½¬æ¢ä¸ºå…¶ä»–æ¨¡å—è¯­æ³•
        "modules": false
      }
    ]
  ]
}
```

å…¶ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„é…ç½®ï¼š`targets` å’Œ `usage`

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `targets` å‚æ•°æŒ‡å®šè¦å…¼å®¹çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œä½ æ—¢å¯ä»¥å¡«å¦‚ä¸Šé…ç½®æ‰€ç¤ºçš„ä¸€ä¸ªå¯¹è±¡ï¼š

```json
{
  "targets": {
    "ie": "11"
  }
}
```

ä¹Ÿå¯ä»¥ç”¨ Browserslist é…ç½®è¯­æ³•ï¼š

```js
{ 
  // ie ä¸ä½äº 11 ç‰ˆæœ¬ï¼Œå…¨çƒè¶…è¿‡ 0.5% ä½¿ç”¨ï¼Œä¸”è¿˜åœ¨ç»´æŠ¤æ›´æ–°çš„æµè§ˆå™¨
  "targets": "ie >= 11, > 0.5%, not dead"
}
```

<font color=lightSeaGreen>Browserslist æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬è®¾ç½®ç›®æ ‡æµè§ˆå™¨çš„å·¥å…·</font>ï¼Œ<font color=fuchsia>ä¸å…‰æ˜¯ Babel ç”¨åˆ°ï¼Œå…¶ä»–çš„ç¼–è¯‘å·¥å…·å¦‚ `postcss-preset-env`ã€`autoprefix` ä¸­éƒ½æœ‰æ‰€åº”ç”¨</font>ã€‚å¯¹äº `Browserslist` çš„é…ç½®å†…å®¹ï¼Œæ—¢å¯ä»¥æ”¾åˆ° Babel è¿™ç§ç‰¹å®šå·¥å…·å½“ä¸­ï¼Œä¹Ÿ<font color=dodgerBlue>å¯ä»¥åœ¨ `package.json` ä¸­é€šè¿‡ `browserslist` å£°æ˜</font>ï¼š

```json
// package.json
{ 
  "browserslist": "ie >= 11"
}
```

<font color=dodgerBlue>æˆ–è€…é€šè¿‡ `.browserslistrc` è¿›è¡Œå£°æ˜</font>ï¼š

```js
// .browserslistrc
ie >= 11
```

åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œ<font color=red>ä¸€èˆ¬æˆ‘ä»¬å¯ä»¥å°†ä½¿ç”¨ä¸‹é¢è¿™äº›**æœ€ä½³å®è·µé›†åˆ**æ¥æè¿°ä¸åŒçš„æµè§ˆå™¨ç±»å‹ï¼Œå‡è½»é…ç½®è´Ÿæ‹…</font>ï¼š

```js
// ç°ä»£æµè§ˆå™¨
last 2 versions and since 2018 and > 0.5%
// å…¼å®¹ä½ç‰ˆæœ¬ PC æµè§ˆå™¨
IE >= 11, > 0.5%, not dead
// å…¼å®¹ä½ç‰ˆæœ¬ç§»åŠ¨ç«¯æµè§ˆå™¨
iOS >= 9, Android >= 4.4, last 2 versions, > 0.2%, not dead
```

å¯¹äºè¿™äº›é…ç½®å¯¹åº”çš„å…·ä½“æµè§ˆå™¨åˆ—è¡¨ï¼Œå¯ä»¥å» [browserslist.dev](https://link.juejin.cn/?target=https%3A%2F%2Fbrowserslist.dev) ç«™ç‚¹æŸ¥çœ‹ï¼š

![image-20240309213234281](https://s2.loli.net/2024/03/09/MvEKRYOmpWCqAtj.png)

å¦å¤–ä¸€ä¸ªé‡è¦çš„é…ç½® `useBuiltIns`ï¼Œå®ƒå†³å®šäº†æ·»åŠ  Polyfill ç­–ç•¥ï¼Œ<font color=lightSeaGreen>é»˜è®¤æ˜¯ `false`</font> ï¼Œå³<font color=lightSeaGreen>ä¸æ·»åŠ ä»»ä½•çš„ Polyfill</font> ï¼›ä¹Ÿå¯ä»¥æ‰‹åŠ¨å°† `useBuiltIns` é…ç½®ä¸º `entry` æˆ–è€… `usage`

###### `useBuiltIns: entry`

`entry` é…ç½®è§„å®šä½ å¿…é¡»åœ¨å…¥å£æ–‡ä»¶ï¼ˆğŸ‘€ ä¸€èˆ¬æ˜¯ `index.js` ï¼‰æ‰‹åŠ¨æ·»åŠ ä¸€è¡Œè¿™æ ·çš„ä»£ç ï¼š

```js
import 'core-js';
```

åœ¨ç»ˆç«¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œ Babel ç¼–è¯‘:

```bash
npx babel src --out-dir dist
```

äº§ç‰©è¾“å‡ºåœ¨ `dist` ç›®å½•ä¸­ï¼Œè§‚å¯Ÿä¸€ä¸‹äº§ç‰©çš„ä»£ç ï¼š

![](https://s2.loli.net/2024/03/09/pZMBib4nqvPNF5L.webp)

<font color=red>Babel å·²ç»**æ ¹æ® â€œç›®æ ‡æµè§ˆå™¨â€ çš„é…ç½®**ä¸ºæˆ‘ä»¬æ·»åŠ äº†å¤§é‡çš„ Polyfill ä»£ç </font>ï¼Œ`index.js` æ–‡ä»¶ç®€å•çš„å‡ è¡Œä»£ç è¢«ç¼–è¯‘æˆè¿‘ 300 è¡Œã€‚å®é™…ä¸Šï¼ŒBabel æ‰€åšçš„äº‹æƒ…å°±æ˜¯å°† `import "core-js"` ä»£ç æ›¿æ¢æˆäº†äº§ç‰©ä¸­çš„è¿™äº›å…·ä½“æ¨¡å—çš„å¯¼å…¥ä»£ç ã€‚

<font color=dodgerBlue>ä½†è¿™ä¸ªé…ç½®æœ‰ä¸€ä¸ªé—®é¢˜</font>ï¼Œ<font color=red>å³æ— æ³•åšåˆ°æŒ‰éœ€å¯¼å…¥</font>ï¼Œä¸Šé¢çš„äº§ç‰©ä»£ç å…¶å®æœ‰å¤§éƒ¨åˆ†çš„ Polyfill çš„ä»£ç æˆ‘ä»¬å¹¶æ²¡æœ‰ç”¨åˆ°ã€‚è¿™æ—¶å€™å¯ä»¥ä½¿ç”¨ `useBuiltIns: usage`

###### `useBuiltIns: usage`

è¯•è¯• <font color=red>`useBuiltIns: usage` æŒ‰éœ€å¯¼å…¥é…ç½®</font>ï¼Œæ”¹åŠ¨é…ç½®åæ‰§è¡Œç¼–è¯‘å‘½ä»¤ `npx babel src --out-dir dist` ï¼›åŒæ ·å¯ä»¥çœ‹åˆ°äº§ç‰©è¾“å‡ºåœ¨äº† `dist/index.js` ä¸­ ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤ºï¼š

![](https://s2.loli.net/2024/03/10/6kd9UFJM7fQXzZh.webp)

> ğŸ’¡ <font color=red>Polyfill ä»£ç Â **ä¸»è¦æ¥è‡ª `core-js` å’Œ `regenerator-runtime`** ï¼Œå› æ­¤å¦‚æœè¦è¿è¡Œèµ·æ¥ï¼Œå¿…é¡»è¦è£…è¿™ä¸¤ä¸ªåº“</font>

å¯ä»¥å‘ç° Polyfill çš„ä»£ç ç²¾ç®€äº†è®¸å¤šï¼ŒçœŸæ­£åœ°å®ç°äº†æŒ‰éœ€ Polyfill å¯¼å…¥ã€‚å› æ­¤ï¼Œ<font color=dodgerBlue>åœ¨å®é™…çš„ä½¿ç”¨å½“ä¸­</font>ï¼Œè¿˜æ˜¯<font color=red>**æ¨èå°½é‡ä½¿ç”¨ `useBuiltIns: "usage"`** ï¼Œè¿›è¡ŒæŒ‰éœ€çš„ Polyfill æ³¨å…¥</font>ã€‚

æ¢³ç†ä¸€ä¸‹ï¼Œä¸Šé¢åˆ©ç”¨ `@babel/preset-env` è¿›è¡Œäº†ç›®æ ‡æµè§ˆå™¨è¯­æ³•çš„é™çº§å’Œ `Polyfill` æ³¨å…¥ï¼ŒåŒæ—¶ç”¨åˆ°äº† `core-js` å’Œ `regenerator-runtime` ä¸¤ä¸ªæ ¸å¿ƒçš„è¿è¡Œæ—¶åº“ã€‚ä½† <font color=dodgerBlue>**`@babel/preset-env`  çš„æ–¹æ¡ˆä¹Ÿå­˜åœ¨ä¸€å®šå±€é™æ€§**</font>ï¼š

1. å¦‚æœä½¿ç”¨æ–°ç‰¹æ€§ï¼Œå¾€å¾€æ˜¯é€šè¿‡åŸºç¡€åº“ï¼ˆå¦‚ `core-js` ï¼‰å¾€å…¨å±€ç¯å¢ƒæ·»åŠ  Polyfillï¼Œå¦‚æœæ˜¯å¼€å‘åº”ç”¨æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå¦‚æœæ˜¯å¼€å‘ç¬¬ä¸‰æ–¹å·¥å…·åº“ï¼Œåˆ™å¾ˆå¯èƒ½ä¼šå¯¹**å…¨å±€ç©ºé—´é€ æˆæ±¡æŸ“**ã€‚

2. å¾ˆå¤šå·¥å…·å‡½æ•°çš„å®ç°ä»£ç ï¼ˆå¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„ `_defineProperty` æ–¹æ³•ï¼‰ï¼Œä¼šåœ¨è®¸å¤šæ–‡ä»¶ä¸­é‡ç°å‡ºç°ï¼Œé€ æˆ**æ–‡ä»¶ä½“ç§¯å†—ä½™**ã€‚

##### æ›´ä¼˜çš„ Polyfill æ³¨å…¥æ–¹æ¡ˆï¼š`transform-runtime`

> ğŸ’¡éœ€è¦æå‰è¯´æ˜çš„æ˜¯ï¼Œ<font color=lightSeaGreen>`transform-runtime` æ–¹æ¡ˆå¯ä»¥ä½œä¸º `@babel/preset-env` ä¸­ `useBuiltIns` é…ç½®çš„æ›¿ä»£å“</font>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œ<font color=dodgerBlue>**ä¸€æ—¦ä½¿ç”¨ `transform-runtime` æ–¹æ¡ˆ**</font>ï¼Œ<font color=red>**åº”è¯¥æŠŠ  `useBuiltIns` å±æ€§è®¾ä¸º `false`**</font> ã€‚

æ¥ä¸‹æ¥å°è¯•ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼Œ<font color=dodgerBlue>é¦–å…ˆå®‰è£…å¿…è¦çš„ä¾èµ–</font>ï¼š

```sh
pnpm i @babel/plugin-transform-runtime -D
pnpm i @babel/runtime-corejs3 -S
```

<font color=dodgerBlue>è§£é‡Šä¸€ä¸‹è¿™ä¸¤ä¸ªä¾èµ–çš„ä½œç”¨</font>ï¼šå‰è€…æ˜¯<font color=lightSeaGreen>ç¼–è¯‘æ—¶</font>å·¥å…·ï¼Œç”¨æ¥è½¬æ¢è¯­æ³•å’Œæ·»åŠ  Polyfill ï¼›åè€…æ˜¯<font color=lightSeaGreen>è¿è¡Œæ—¶</font>åŸºç¡€åº“ï¼Œå°è£…äº†`core-js`ã€`regenerator-runtime` å’Œå„ç§è¯­æ³•è½¬æ¢ç”¨åˆ°çš„ å·¥å…·å‡½æ•°ã€‚

> ğŸ’¡ <font color=dodgerBlue>core-js æœ‰ä¸‰ç§äº§ç‰©</font>ï¼Œ<font color=red>åˆ†åˆ«æ˜¯ **`core-js`ã€<font color=fuchsia>`core-js-pure`</font> å’Œ `core-js-bundle`**</font>ã€‚ç¬¬ä¸€ç§æ˜¯å…¨å±€ Polyfill çš„åšæ³•ï¼Œ`@babel/preset-env` å°±æ˜¯ç”¨çš„è¿™ç§äº§ç‰©ï¼›<font color=lightSeaGreen>ç¬¬äºŒç§ä¸ä¼šæŠŠ Polyfill æ³¨å…¥åˆ°å…¨å±€ç¯å¢ƒï¼Œå¯ä»¥æŒ‰éœ€å¼•å…¥</font>ï¼›ç¬¬ä¸‰ç§æ˜¯æ‰“åŒ…å¥½çš„ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰çš„ Polyfillï¼Œä¸å¤ªå¸¸ç”¨ã€‚`@babel/runtime-corejs3` ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§äº§ç‰©ã€‚

å¯¹ `.babelrc.json` ä½œå¦‚ä¸‹çš„é…ç½®ï¼š

```json
{
  "plugins": [
    // æ·»åŠ  transform-runtime æ’ä»¶
    [
      "@babel/plugin-transform-runtime", 
      {
        "corejs": 3
      }
    ]
  ],
  "presets": [
    [
      "@babel/preset-env",
      {
        "targets": {
          "ie": "11"
        },
        "corejs": 3,
        // å…³é—­ @babel/preset-env é»˜è®¤çš„ Polyfill æ³¨å…¥
        "useBuiltIns": false,
        "modules": false
      }
    ]
  ]
}
```

æ‰§è¡Œç»ˆç«¯å‘½ä»¤ `npx babel src --out-dir dist` ï¼Œå¯¹æ¯”ä¸€ä¸‹ `@babel/preset-env`ä¸‹çš„äº§ç‰©ç»“æœï¼š

![](https://s2.loli.net/2024/03/10/cnqXygZKLJO7Nxm.jpg)

ç»è¿‡å¯¹æ¯”ä¸éš¾å‘ç°ï¼Œ`transform-runtime` ä¸€æ–¹é¢èƒ½å¤Ÿè®©æˆ‘ä»¬åœ¨ä»£ç ä¸­ä½¿ç”¨ éå…¨å±€ç‰ˆæœ¬ çš„ Polyfillï¼Œè¿™æ ·å°±é¿å…å…¨å±€ç©ºé—´çš„æ±¡æŸ“ï¼Œè¿™ä¹Ÿå¾—ç›Šäº `core-js` çš„ pure ç‰ˆæœ¬äº§ç‰©ç‰¹æ€§ï¼›å¦ä¸€æ–¹é¢<font color=dodgerBlue>å¯¹äº `asyncToGeneator` è¿™ç±»çš„å·¥å…·å‡½æ•°</font>ï¼Œå®ƒä¹Ÿ<font color=red>å°†å…¶è½¬æ¢æˆäº†ä¸€æ®µå¼•å…¥è¯­å¥ï¼Œä¸å†å°†å®Œæ•´çš„å®ç°æ”¾åˆ°æ–‡ä»¶ä¸­</font>ï¼ŒèŠ‚çœäº†ç¼–è¯‘åæ–‡ä»¶çš„ä½“ç§¯ã€‚

å¦å¤–ï¼Œ`transform-runtime` æ–¹æ¡ˆå¼•ç”¨çš„åŸºç¡€åº“ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ˜¯ç›´æ¥å¼•å…¥ `core-js` å’Œ `regenerator-runtime`ï¼Œè€Œæ˜¯å¼•å…¥ `@babel/runtime-corejs3` ã€‚



#### Vite SSR å·¥ç¨‹

SSR ä¸­åªèƒ½ç”Ÿæˆé¡µé¢çš„å†…å®¹å’Œç»“æ„ï¼Œå¹¶ä¸èƒ½å®Œæˆäº‹ä»¶ç»‘å®šï¼Œå› æ­¤éœ€è¦åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œ CSR çš„ JS è„šæœ¬ï¼Œå®Œæˆäº‹ä»¶ç»‘å®šï¼Œè®©é¡µé¢æ‹¥æœ‰äº¤äº’çš„èƒ½åŠ›ï¼Œè¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä½œ â€œhydrateâ€ï¼ˆè¯‘ä¸º â€œæ³¨æ°´â€ æˆ– â€œæ¿€æ´»â€ )ã€‚åŒæ—¶ï¼Œåƒè¿™æ ·æœåŠ¡ç«¯æ¸²æŸ“ + å®¢æˆ·ç«¯ hydrate çš„åº”ç”¨ä¹Ÿè¢«ç§°ä¸ºâ€œåŒæ„åº”ç”¨â€ã€‚

##### SSR ç”Ÿå‘½å‘¨æœŸåˆ†æ

SSR ä¼šåœ¨æœåŠ¡ç«¯ï¼ˆä¸»è¦æ˜¯ Node.js ç«¯ï¼‰æå‰æ¸²æŸ“å‡ºå®Œæ•´çš„ HTML å†…å®¹ï¼Œè¿™æ˜¯å¦‚ä½•åšåˆ°çš„ï¼Ÿ

<font color=dodgerBlue>é¦–å…ˆ</font>éœ€è¦<font color=lightSeaGreen>ä¿è¯å‰ç«¯çš„ä»£ç ç»è¿‡ç¼–è¯‘åæ”¾åˆ°æœåŠ¡ç«¯ä¸­èƒ½å¤Ÿæ­£å¸¸æ‰§è¡Œ</font>ï¼Œ<font color=dodgerBlue>å…¶æ¬¡</font><font color=lightSeaGreen>åœ¨æœåŠ¡ç«¯æ¸²æŸ“å‰ç«¯ç»„ä»¶ï¼Œç”Ÿæˆå¹¶ç»„è£…åº”ç”¨çš„ HTML</font>ã€‚è¿™<font color=red>æ¶‰åŠåˆ° SSR åº”ç”¨çš„ä¸¤å¤§ç”Ÿå‘½å‘¨æœŸï¼šâ€œæ„å»ºæ—¶â€ å’Œâ€œè¿è¡Œæ—¶â€</font>ï¼Œä¸å¦¨æ¥ä»”ç»†æ¢³ç†ä¸€ä¸‹ã€‚

<font color=dodgerBlue>å…ˆæ¥çœ‹çœ‹ â€œæ„å»ºæ—¶â€ éœ€è¦åšå“ªäº›äº‹æƒ…</font>ï¼š

1. **è§£å†³æ¨¡å—åŠ è½½é—®é¢˜**ã€‚åœ¨åŸæœ‰çš„æ„å»ºè¿‡ç¨‹ä¹‹å¤–ï¼Œéœ€è¦åŠ å…¥ â€œSSR æ„å»ºâ€ çš„è¿‡ç¨‹ã€‚å…·ä½“æ¥è¯´ï¼Œéœ€è¦å¦å¤–ç”Ÿæˆä¸€ä»½ CommonJS æ ¼å¼çš„äº§ç‰©ï¼Œä½¿ä¹‹èƒ½åœ¨ Node.js æ­£å¸¸åŠ è½½ã€‚å½“ç„¶ï¼Œéšç€ Node.js æœ¬èº«å¯¹ ESM çš„æ”¯æŒè¶Šæ¥è¶Šæˆç†Ÿï¼Œä¹Ÿå¯ä»¥å¤ç”¨å‰ç«¯ ESM æ ¼å¼çš„ä»£ç ï¼ŒVite åœ¨å¼€å‘é˜¶æ®µè¿›è¡Œ SSR æ„å»ºä¹Ÿæ˜¯è¿™æ ·çš„æ€è·¯ã€‚

   <img src="https://s2.loli.net/2024/03/16/sVnledjz8MWyOXN.png" style="zoom:50%;" />

2. **ç§»é™¤æ ·å¼ä»£ç çš„å¼•å…¥**ã€‚ç›´æ¥å¼•å…¥ä¸€è¡Œ css åœ¨æœåŠ¡ç«¯æ˜¯æ— æ³•æ‰§è¡Œçš„ï¼Œå› ä¸º Node.js å¹¶ä¸èƒ½è§£æ CSS çš„å†…å®¹ï¼›ä½†  CSS Modules çš„æƒ…å†µé™¤å¤–ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

   ```ts
   import styles from './index.module.css'
   
   // è¿™é‡Œçš„ styles æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚{ "container": "xxx" }ï¼Œè€Œä¸æ˜¯ CSS ä»£ç 
   console.log(styles)
   ```

3. **ä¾èµ–å¤–éƒ¨åŒ–( external )** ï¼šå¯¹äºæŸäº›ç¬¬ä¸‰æ–¹ä¾èµ–å¹¶ä¸éœ€è¦ä½¿ç”¨æ„å»ºåçš„ç‰ˆæœ¬ï¼Œè€Œæ˜¯ç›´æ¥ä» `node_modules` ä¸­è¯»å–ï¼Œæ¯”å¦‚ `react-dom`ï¼Œè¿™æ ·åœ¨ SSR æ„å»ºçš„è¿‡ç¨‹ä¸­å°†ä¸ä¼šæ„å»ºè¿™äº›ä¾èµ–ï¼Œä»è€Œæå¤§ç¨‹åº¦ä¸ŠåŠ é€Ÿ SSR çš„æ„å»ºã€‚

   > ğŸ‘€ å…³äºä¸Šé¢çš„è¿™å¥è¯æœ‰ç‚¹ä¸æ˜ç™½ï¼Œé—®äº†ä¸‹ GitHub Copilot Chatï¼Œå¾—åˆ°å¦‚ä¸‹å›å¤ï¼š
   >
   > <img src="https://s2.loli.net/2024/03/16/y9K6wx2bstqvDhL.png" alt="Snipaste_2024-03-16_20-27-23" style="zoom:50%;" />

å¯¹äº SSR çš„è¿è¡Œæ—¶ï¼Œä¸€èˆ¬å¯ä»¥æ‹†åˆ†ä¸ºæ¯”è¾ƒå›ºå®šçš„ç”Ÿå‘½å‘¨æœŸé˜¶æ®µï¼Œ<font color=dodgerBlue>ç®€å•æ¥è®²å¯ä»¥æ•´ç†ä¸ºä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒçš„é˜¶æ®µ</font>ï¼š

<img src="https://s2.loli.net/2024/03/16/qPDkQnXSN537Lxr.png" style="zoom:50%;" />

1. **åŠ è½½ SSR å…¥å£æ¨¡å—**ã€‚è¿™ä¸ªé˜¶æ®µï¼Œ<font color=red>éœ€è¦ç¡®å®š SSR æ„å»ºäº§ç‰©çš„å…¥å£</font>ï¼Œå³ç»„ä»¶çš„å…¥å£åœ¨å“ªé‡Œï¼Œå¹¶åŠ è½½å¯¹åº”çš„æ¨¡å—ã€‚
2. **è¿›è¡Œæ•°æ®é¢„å–**ã€‚è¿™æ—¶å€™ <font color=lightSeaGreen>Node ä¾§ä¼šé€šè¿‡æŸ¥è¯¢æ•°æ®åº“æˆ–è€…ç½‘ç»œè¯·æ±‚æ¥è·å–åº”ç”¨æ‰€éœ€çš„æ•°æ®</font>ã€‚
3. **æ¸²æŸ“ç»„ä»¶**ã€‚<font color=red>è¿™ä¸ªé˜¶æ®µä¸º SSR çš„æ ¸å¿ƒ</font>ï¼Œ<font color=lightSeaGreen>ä¸»è¦å°†ç¬¬ 1 æ­¥ä¸­åŠ è½½çš„ç»„ä»¶**æ¸²æŸ“æˆ HTML å­—ç¬¦ä¸²æˆ–è€… Stream æµ**</font>ã€‚
4. **HTML æ‹¼æ¥**ã€‚åœ¨ç»„ä»¶æ¸²æŸ“å®Œæˆä¹‹åï¼Œéœ€è¦æ‹¼æ¥å®Œæ•´çš„ HTML å­—ç¬¦ä¸²ï¼Œå¹¶å°†å…¶ä½œä¸ºå“åº”è¿”å›ç»™æµè§ˆå™¨ã€‚

<font color=dodgerBlue>ä»ä¸Šé¢çš„åˆ†æä¸­å¯ä»¥å‘ç°</font>ï¼Œ<font color=red>SSR å…¶å®æ˜¯ â€œæ„å»ºâ€ å’Œ â€œè¿è¡Œæ—¶â€ äº’ç›¸é…åˆæ‰èƒ½å®ç°çš„</font>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šä»…é æ„å»ºå·¥å…·æ˜¯ä¸å¤Ÿçš„ï¼Œå†™ä¸€ä¸ª Vite æ’ä»¶ä¸¥æ ¼æ„ä¹‰ä¸Šæ— æ³•å®ç° SSR çš„èƒ½åŠ›ï¼Œéœ€è¦å¯¹ Vite çš„æ„å»ºæµç¨‹åšä¸€äº›æ•´ä½“çš„è°ƒæ•´ï¼Œå¹¶ä¸”åŠ å…¥ä¸€äº›æœåŠ¡ç«¯è¿è¡Œæ—¶çš„é€»è¾‘æ‰èƒ½å®ç°ã€‚



#### æ¨¡å—è”é‚¦

##### æ¨¡å—å…±äº«ä¹‹ç—›

å¯¹äºä¸€ä¸ªäº’è”ç½‘äº§å“æ¥è¯´ï¼Œä¸€èˆ¬ä¼šæœ‰ä¸åŒçš„ç»†åˆ†åº”ç”¨æˆ–å­ç«™ï¼›è€Œ<font color=lightSeaGreen>æ¯ä¸ªå­ç«™åˆå½¼æ­¤ç‹¬ç«‹ï¼Œå¯èƒ½ç”±ä¸åŒçš„å¼€å‘å›¢é˜Ÿè¿›è¡Œå•ç‹¬çš„å¼€å‘å’Œç»´æŠ¤</font>ã€‚<font color=dodgerBlue>çœ‹ä¼¼æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ï¼Œä½†å®é™…ä¸Šä¼šç»å¸¸é‡åˆ°ä¸€äº›æ¨¡å—å…±äº«çš„é—®é¢˜</font>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼š<font color=lightSeaGreen>**ä¸åŒåº”ç”¨ä¸­æ€»ä¼šæœ‰ä¸€äº›å…±äº«çš„ä»£ç ï¼Œæ¯”å¦‚å…¬å…±ç»„ä»¶ã€å…¬å…±å·¥å…·å‡½æ•°ã€å…¬å…±ç¬¬ä¸‰æ–¹ä¾èµ–ç­‰ç­‰**</font>ã€‚<font color=dodgerBlue>å¯¹äºè¿™äº›å…±äº«çš„ä»£ç ï¼Œé™¤äº†é€šè¿‡ç®€å•çš„å¤åˆ¶ç²˜è´´ï¼Œè¿˜æœ‰æ²¡æœ‰æ›´å¥½çš„å¤ç”¨æ‰‹æ®µï¼Ÿ</font>

###### å‘å¸ƒ npm åŒ…

å‘å¸ƒ npm åŒ…æ˜¯ä¸€ç§å¸¸è§çš„å¤ç”¨æ¨¡å—çš„åšæ³•ï¼Œå¯ä»¥å°†ä¸€äº›å…¬ç”¨çš„ä»£ç å°è£…ä¸ºä¸€ä¸ª npm åŒ…ï¼Œå‘å¸ƒæ›´æ–°æµç¨‹å¦‚ä¸‹ï¼š

1. å…¬å…±åº“ lib1 æ”¹åŠ¨ï¼Œå‘å¸ƒåˆ° npm
2. æ‰€æœ‰çš„åº”ç”¨å®‰è£…æ–°çš„ä¾èµ–ï¼Œå¹¶è¿›è¡Œè”è°ƒã€‚

<img src="https://s2.loli.net/2024/03/17/oqtH7vkmrn3Mbzg.png" alt="image.png" style="zoom:45%;" />

å°è£… npm åŒ…å¯ä»¥è§£å†³æ¨¡å—å¤ç”¨çš„é—®é¢˜ï¼Œä½†å®ƒ<font color=dodgerBlue>æœ¬èº«åˆå¼•å…¥äº†æ–°çš„é—®é¢˜</font>ï¼š

1. **å¼€å‘æ•ˆç‡é—®é¢˜**ã€‚<font color=red>æ¯æ¬¡æ”¹åŠ¨éƒ½éœ€è¦å‘ç‰ˆï¼Œå¹¶æ‰€æœ‰ç›¸å…³çš„åº”ç”¨å®‰è£…æ–°ä¾èµ–ï¼Œæµç¨‹æ¯”è¾ƒå¤æ‚</font>ã€‚
2. **é¡¹ç›®æ„å»ºé—®é¢˜**ã€‚å¼•å…¥äº†å…¬å…±åº“ä¹‹åï¼Œå…¬å…±åº“çš„ä»£ç éƒ½éœ€è¦æ‰“åŒ…åˆ°é¡¹ç›®æœ€åçš„äº§ç‰©åï¼Œå¯¼è‡´äº§ç‰©ä½“ç§¯åå¤§ï¼Œæ„å»ºé€Ÿåº¦ç›¸å¯¹è¾ƒæ…¢ã€‚

å› æ­¤ï¼Œè¿™ç§æ–¹æ¡ˆå¹¶ä¸èƒ½ä½œä¸ºæœ€ç»ˆæ–¹æ¡ˆï¼Œåªæ˜¯æš‚æ—¶ç”¨æ¥è§£å†³é—®é¢˜çš„æ— å¥ˆä¹‹ä¸¾ã€‚

###### Git Submodules

<font color=lightSeaGreen>é€šè¿‡ `git submodule` å¯ä»¥å°†ä»£ç å°è£…æˆä¸€ä¸ªå…¬å…±çš„ Git ä»“åº“</font>ï¼Œç„¶å<font color=red>**å¤ç”¨åˆ°ä¸åŒçš„åº”ç”¨ä¸­**</font>ï¼›<font color=dodgerBlue>éœ€è¦ç»å†å¦‚ä¸‹çš„æ­¥éª¤</font>ï¼š

1. å…¬å…±åº“ lib1 æ”¹åŠ¨ï¼Œæäº¤åˆ° Git è¿œç¨‹ä»“åº“
2. æ‰€æœ‰çš„åº”ç”¨é€šè¿‡ `git submodule` å‘½ä»¤æ›´æ–°å­ä»“åº“ä»£ç ï¼Œå¹¶è¿›è¡Œè”è°ƒ

ä½ å¯ä»¥çœ‹åˆ°ï¼Œ<font color=red>**æ•´ä½“çš„æµç¨‹å…¶å®è·Ÿå‘ npm åŒ…ç›¸å·®æ— å‡ **ï¼Œä»ç„¶å­˜åœ¨ npm åŒ…æ–¹æ¡ˆæ‰€å­˜åœ¨çš„å„ç§é—®é¢˜</font>ã€‚

> ğŸ’¡ è¡¥å……
>
> <img src="https://s2.loli.net/2024/03/14/zJjUGqr7HvBNiQg.png" alt="image-20240314235428066" style="zoom:48%;" />

###### ä¾èµ–å¤–éƒ¨åŒ–( external ) + CDN å¼•å…¥

æŸäº›ç¬¬ä¸‰æ–¹ä¾èµ–å¹¶ä¸éœ€è¦è®©å…¶å‚ä¸æ„å»ºï¼Œè€Œæ˜¯ä½¿ç”¨æŸä¸€ä»½å…¬ç”¨çš„ä»£ç ã€‚æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œå¯ä»¥åœ¨æ„å»ºå¼•æ“ä¸­å¯¹æŸäº›ä¾èµ–å£°æ˜ `external` ï¼Œç„¶ååœ¨ HTML ä¸­åŠ å…¥ä¾èµ–çš„ CDN åœ°å€ï¼š

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/src/favicon.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
  </head>
  <body>
    <div id="root"></div>
    <!-- ä» CDN ä¸Šå¼•å…¥ç¬¬ä¸‰æ–¹ä¾èµ–çš„ä»£ç  -->
    <script src="https://cdn.jsdelivr.net/npm/react@17.0.2/index.min.js"><script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@17.0.2/index.min.js"><script>
  </body>
</html>
```

å¦‚ä¸Šé¢çš„ä¾‹å­æ‰€ç¤ºï¼Œ<font color=lightSeaGreen>å¯ä»¥å¯¹ `react` å’Œ `react-dom` ä½¿ç”¨ CDN çš„æ–¹å¼å¼•å…¥ï¼Œ**ä¸€èˆ¬ä½¿ç”¨ `UMD` æ ¼å¼äº§ç‰©**</font>ï¼Œè¿™æ ·<font color=red>ä¸åŒçš„é¡¹ç›®é—´å°±å¯ä»¥é€šè¿‡ `window.React` æ¥ä½¿ç”¨åŒä¸€ä»½ä¾èµ–çš„ä»£ç äº†ï¼Œä»è€Œè¾¾åˆ°æ¨¡å—å¤ç”¨çš„æ•ˆæœ</font>ã€‚ä¸è¿‡åœ¨å®é™…çš„ä½¿ç”¨åœºæ™¯ï¼Œ<font color=dodgerBlue>**è¿™ç§æ–¹æ¡ˆçš„å±€é™æ€§ä¹Ÿå¾ˆçªå‡º**</font>ï¼š

1. <font color=red>**å…¼å®¹æ€§é—®é¢˜**</font>ã€‚å¹¶ä¸æ˜¯æ‰€æœ‰çš„ä¾èµ–éƒ½æœ‰ UMD æ ¼å¼çš„äº§ç‰©ï¼Œå› æ­¤è¿™ç§æ–¹æ¡ˆä¸èƒ½è¦†ç›–æ‰€æœ‰çš„ç¬¬ä¸‰æ–¹ npm åŒ…ã€‚
2. <font color=red>**ä¾èµ–é¡ºåºé—®é¢˜**</font>ã€‚æˆ‘ä»¬é€šå¸¸éœ€è¦è€ƒè™‘é—´æ¥ä¾èµ–çš„é—®é¢˜ï¼Œå¦‚å¯¹äº antd ç»„ä»¶åº“ï¼Œå®ƒæœ¬èº«ä¹Ÿä¾èµ–äº† react å’Œ momentï¼Œé‚£ä¹ˆ `react` å’Œ `moment` ä¹Ÿéœ€è¦ `external`ï¼Œå¹¶ä¸”<font color=red>åœ¨ HTML ä¸­å¼•ç”¨è¿™äº›åŒ…ï¼ŒåŒæ—¶ä¹Ÿè¦**ä¸¥æ ¼ä¿è¯**å¼•ç”¨çš„é¡ºåº</font>ï¼Œæ¯”å¦‚è¯´ `moment` å¦‚æœæ”¾åœ¨äº† `antd` åé¢ï¼Œä»£ç å¯èƒ½æ— æ³•è¿è¡Œã€‚è€Œç¬¬ä¸‰æ–¹åŒ…èƒŒåçš„é—´æ¥ä¾èµ–æ•°é‡ä¸€èˆ¬å¾ˆåºå¤§ï¼Œå¦‚æœé€ä¸ªå¤„ç†ï¼Œå¯¹äºå¼€å‘è€…æ¥è¯´ç®€ç›´å°±æ˜¯å™©æ¢¦ã€‚
3. <font color=red>**äº§ç‰©ä½“ç§¯é—®é¢˜**</font>ã€‚ç”±äºä¾èµ–åŒ…è¢«å£°æ˜ `external` ä¹‹åï¼Œ<font color=fuchsia>åº”ç”¨åœ¨å¼•ç”¨å…¶ CDN åœ°å€æ—¶ï¼Œä¼šå…¨é‡å¼•ç”¨ä¾èµ–çš„ä»£ç ï¼Œè¿™ç§æƒ…å†µä¸‹å°±**æ²¡æœ‰åŠæ³•é€šè¿‡ Tree Shaking æ¥å»é™¤æ— ç”¨ä»£ç **</font>ï¼Œä¼šå¯¼è‡´åº”ç”¨çš„æ€§èƒ½æœ‰æ‰€ä¸‹é™ã€‚

###### Monorepo

ä½œä¸ºä¸€ç§æ–°çš„é¡¹ç›®ç®¡ç†æ–¹å¼ï¼ŒMonorepo ä¹Ÿå¯ä»¥å¾ˆå¥½åœ°è§£å†³æ¨¡å—å¤ç”¨çš„é—®é¢˜ã€‚åœ¨ Monorepo æ¶æ„ä¸‹ï¼Œå¤šä¸ªé¡¹ç›®å¯ä»¥æ”¾åœ¨åŒä¸€ä¸ª Git ä»“åº“ä¸­ï¼Œå„ä¸ªäº’ç›¸ä¾èµ–çš„å­é¡¹ç›®é€šè¿‡è½¯é“¾æ¥çš„æ–¹å¼è¿›è¡Œè°ƒè¯•ï¼Œä»£ç å¤ç”¨æ˜¾å¾—éå¸¸æ–¹ä¾¿ï¼Œå¦‚æœæœ‰ä¾èµ–çš„ä»£ç å˜åŠ¨ï¼Œé‚£ä¹ˆç”¨åˆ°è¿™ä¸ªä¾èµ–çš„é¡¹ç›®å½“ä¸­ä¼šç«‹é©¬æ„ŸçŸ¥åˆ°ã€‚

![](https://s2.loli.net/2024/03/15/swOJ6zEQlY3TBCg.png)

ä¸å¾—ä¸æ‰¿è®¤ï¼Œ<font color=lightSeaGreen>**å¯¹äºåº”ç”¨é—´æ¨¡å—å¤ç”¨çš„é—®é¢˜ï¼ŒMonorepo æ˜¯ä¸€ç§éå¸¸ä¼˜ç§€çš„è§£å†³æ–¹æ¡ˆ**</font>ï¼›ä½†ä¸æ­¤åŒæ—¶ï¼Œ<font color=dodgerBlue>å®ƒä¹Ÿç»™å›¢é˜Ÿå¸¦æ¥äº†ä¸€äº›æŒ‘æˆ˜</font>ï¼š

1. **æ‰€æœ‰çš„åº”ç”¨ä»£ç å¿…é¡»æ”¾åˆ°åŒä¸€ä¸ªä»“åº“**ï¼š<font color=lightSeaGreen>**å¦‚æœæ˜¯æ—§æœ‰é¡¹ç›®ï¼Œå¹¶ä¸”æ¯ä¸ªåº”ç”¨ä½¿ç”¨ä¸€ä¸ª Git ä»“åº“çš„æƒ…å†µ**</font>ï¼Œé‚£ä¹ˆ<font color=red>ä½¿ç”¨ Monorepo ä¹‹åé¡¹ç›®æ¶æ„è°ƒæ•´ä¼šæ¯”è¾ƒå¤§</font>ï¼Œä¹Ÿå°±æ˜¯è¯´æ”¹é€ æˆæœ¬ä¼šç›¸å¯¹æ¯”è¾ƒé«˜ã€‚
2. <font color=dodgerBlue>Monorepo æœ¬èº«ä¹Ÿå­˜åœ¨ä¸€äº›å¤©ç„¶çš„å±€é™æ€§</font>ï¼Œå¦‚é¡¹ç›®æ•°é‡å¤šèµ·æ¥ä¹‹åä¾èµ–å®‰è£…æ—¶é—´ä¼šå¾ˆä¹…ã€é¡¹ç›®æ•´ä½“æ„å»ºæ—¶é—´ä¼šå˜é•¿ç­‰ç­‰ï¼Œæˆ‘ä»¬ä¹Ÿéœ€è¦å»è§£å†³è¿™äº›å±€é™æ€§æ‰€å¸¦æ¥çš„çš„å¼€å‘æ•ˆç‡é—®é¢˜ã€‚è€Œè¿™é¡¹å·¥ä½œä¸€èˆ¬éœ€è¦æŠ•å…¥ä¸“ä¸šçš„äººå»è§£å†³ï¼Œ<font color=lightSeaGreen>å¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„äººå‘˜æŠ•å…¥æˆ–è€… **åŸºå»ºçš„ä¿è¯**ï¼ŒMonorepo å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„é€‰æ‹©</font>ã€‚
3. **é¡¹ç›®æ„å»ºé—®é¢˜**ï¼šè·Ÿå‘ npm åŒ…çš„æ–¹æ¡ˆä¸€æ ·ï¼Œæ‰€æœ‰å…¬å…±ä»£ç éƒ½éœ€è¦è¿›å…¥é¡¹ç›®çš„æ„å»ºæµç¨‹ä¸­ï¼Œäº§ç‰©ä½“ç§¯è¿˜æ˜¯åå¤§ã€‚

##### æ¨¡å—è”é‚¦ æ ¸å¿ƒæ¦‚å¿µ

<font color=dodgerBlue>æ¨¡å—è”é‚¦ä¸­ä¸»è¦æœ‰ä¸¤ç§æ¨¡å—</font>ï¼š<font color=red>â€œæœ¬åœ°æ¨¡å—â€ å’Œ â€œè¿œç¨‹æ¨¡å—â€</font> ã€‚

<font color=lightSeaGreen>**æœ¬åœ°æ¨¡å—å³ä¸ºæ™®é€šæ¨¡å—ï¼Œæ˜¯å½“å‰æ„å»ºæµç¨‹ä¸­çš„ä¸€éƒ¨åˆ†**</font>ï¼›è€Œ<font color=red>è¿œç¨‹æ¨¡å—ä¸å±äºå½“å‰æ„å»ºæµç¨‹</font>ï¼Œ<font color=fuchsia>åœ¨æœ¬åœ°æ¨¡å—çš„è¿è¡Œæ—¶è¿›è¡Œå¯¼å…¥ï¼ŒåŒæ—¶æœ¬åœ°æ¨¡å—å’Œè¿œç¨‹æ¨¡å—å¯ä»¥å…±äº«æŸäº›ä¾èµ–çš„ä»£ç </font>ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://s2.loli.net/2024/03/17/2niUrJQap6PZztk.png" style="zoom:50%;" />

<font color=dodgerBlue>å€¼å¾—å¼ºè°ƒçš„æ˜¯ï¼šåœ¨æ¨¡å—è”é‚¦ä¸­</font>ï¼Œ<font color=red>æ¯ä¸ªæ¨¡å—æ—¢å¯ä»¥æ˜¯â€œæœ¬åœ°æ¨¡å—â€ï¼Œå¯¼å…¥å…¶å®ƒçš„ â€œè¿œç¨‹æ¨¡å—â€ï¼Œåˆå¯ä»¥ä½œä¸ºâ€œè¿œç¨‹æ¨¡å—â€ï¼Œè¢«å…¶ä»–çš„æ¨¡å—å¯¼å…¥</font>ã€‚å¦‚ä¸‹é¢è¿™ä¸ªä¾‹å­æ‰€ç¤º:

<img src="https://s2.loli.net/2024/03/17/7d4jIXNBFA98fnv.png" style="zoom:55%;" />

å¦‚å›¾ï¼Œ<font color=lightSeaGreen>å…¶ä¸­ A æ¨¡å—æ—¢å¯ä»¥ä½œä¸ºæœ¬åœ°æ¨¡å—å¯¼å…¥ Bï¼Œåˆå¯ä»¥ä½œä¸ºè¿œç¨‹æ¨¡å—è¢« C å¯¼å…¥</font>ã€‚

ä»¥ä¸Šå°±æ˜¯æ¨¡å—è”é‚¦çš„ä¸»è¦è®¾è®¡åŸç†ï¼Œ<font color=dodgerBlue>åˆ†æä¸€ä¸‹è¿™ç§è®¾è®¡ç©¶ç«Ÿæœ‰å“ªäº›ä¼˜åŠ¿</font>ï¼š

1. <font color=red>**å®ç°ä»»æ„ç²’åº¦çš„æ¨¡å—å…±äº«**</font>ã€‚è¿™é‡Œæ‰€æŒ‡çš„<font color=red>æ¨¡å—ç²’åº¦å¯å¤§å¯å°ï¼ŒåŒ…æ‹¬ç¬¬ä¸‰æ–¹ npm ä¾èµ–ã€ä¸šåŠ¡ç»„ä»¶ã€å·¥å…·å‡½æ•°ï¼Œç”šè‡³å¯ä»¥æ˜¯æ•´ä¸ªå‰ç«¯åº”ç”¨</font>ï¼è€Œæ•´ä¸ªå‰ç«¯åº”ç”¨èƒ½å¤Ÿå…±äº«äº§ç‰©ï¼Œä»£è¡¨ç€å„ä¸ªåº”ç”¨å•ç‹¬å¼€å‘ã€æµ‹è¯•ã€éƒ¨ç½²ï¼Œè¿™ä¹Ÿæ˜¯ä¸€ç§å¾®å‰ç«¯çš„å®ç°ã€‚

2. **ä¼˜åŒ–æ„å»ºäº§ç‰©ä½“ç§¯**ã€‚<font color=red>è¿œç¨‹æ¨¡å—å¯ä»¥ä»æœ¬åœ°æ¨¡å—è¿è¡Œæ—¶è¢«æ‹‰å–ï¼Œè€Œä¸ç”¨å‚ä¸æœ¬åœ°æ¨¡å—çš„æ„å»ºï¼Œå¯ä»¥åŠ é€Ÿæ„å»ºè¿‡ç¨‹ï¼ŒåŒæ—¶ä¹Ÿèƒ½å‡å°æ„å»ºäº§ç‰©</font>ã€‚

   > ğŸ’¡ è¡¥å……ï¼š
   >
   > Webpack Module Federation (MF) is a feature of webpack that allows for the dynamic loading of multiple versions of a module from multiple independent build systems.
   >
   > This allows for the creation of microfrontend-style applications, where <font color=<font color=red>>multiple systems can share code and be dynamically updated **without having to rebuild the entire application**</font>.
   >
   > It also enables distributed teams and applications with different release cycles to share code without needing to wait for all systems to agree to and deploy a single shared version of a module.

3. <font color=red>**è¿è¡Œæ—¶æŒ‰éœ€åŠ è½½**</font>ã€‚<font color=lightSeaGreen>**è¿œç¨‹æ¨¡å—å¯¼å…¥çš„ç²’åº¦å¯ä»¥å¾ˆå°**</font>ï¼Œå¦‚æœä½ åªæƒ³ä½¿ç”¨ app1 æ¨¡å—çš„ `add` å‡½æ•°ï¼Œåªéœ€è¦åœ¨ app1 çš„æ„å»ºé…ç½®ä¸­å¯¼å‡ºè¿™ä¸ªå‡½æ•°ï¼Œç„¶å<font color=lightSeaGreen>åœ¨æœ¬åœ°æ¨¡å—ä¸­æŒ‰ç…§è¯¸å¦‚ `import('app1/add')` çš„æ–¹å¼å¯¼å…¥å³å¯</font>ï¼Œè¿™æ ·å°±å¾ˆå¥½åœ°å®ç°äº†æ¨¡å—æŒ‰éœ€åŠ è½½ã€‚

4. **ç¬¬ä¸‰æ–¹ä¾èµ–å…±äº«**ã€‚<font color=lightSeaGreen>é€šè¿‡æ¨¡å—è”é‚¦ä¸­çš„å…±äº«ä¾èµ–æœºåˆ¶ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°åœ¨æ¨¡å—é—´å…¬ç”¨ä¾èµ–ä»£ç </font>ï¼Œä»è€Œé¿å…ä»¥å¾€çš„ â€œexternal + CDN å¼•å…¥â€ æ–¹æ¡ˆçš„å„ç§é—®é¢˜ã€‚

ä»ä»¥ä¸Šçš„åˆ†æä½ å¯ä»¥çœ‹åˆ°ï¼Œæ¨¡å—è”é‚¦è¿‘ä¹å®Œç¾åœ°è§£å†³äº†ä»¥å¾€æ¨¡å—å…±äº«çš„é—®é¢˜ï¼Œç”šè‡³èƒ½å¤Ÿå®ç°åº”ç”¨çº§åˆ«çš„å…±äº«ï¼Œè¿›è€Œè¾¾åˆ°å¾®å‰ç«¯çš„æ•ˆæœã€‚

> ğŸ’¡ è¡¥å……
>
> ![Snipaste_2024-03-17_21-44-33](https://s2.loli.net/2024/03/17/vbtwzNl8ILyV7qi.png)

##### æ¨¡å—è”é‚¦ å®ç°åŸç†

<font color=dodgerBlue>å®ç°æ¨¡å—è”é‚¦æœ‰ä¸‰å¤§ä¸»è¦çš„è¦ç´ ï¼š</font>

1. `Host` æ¨¡å—ï¼šå³æœ¬åœ°æ¨¡å—ï¼Œç”¨æ¥æ¶ˆè´¹è¿œç¨‹æ¨¡å—ã€‚
2. `Remote` æ¨¡å—ï¼šå³è¿œç¨‹æ¨¡å—ï¼Œç”¨æ¥ç”Ÿäº§ä¸€äº›æ¨¡å—ï¼Œå¹¶<font color=red>æš´éœ² â€œè¿è¡Œæ—¶å®¹å™¨â€ ä¾›æœ¬åœ°æ¨¡å—æ¶ˆè´¹</font>ã€‚
3. `Shared` ä¾èµ–ï¼šå³<font color=red>å…±äº«ä¾èµ–ï¼Œç”¨æ¥åœ¨æœ¬åœ°æ¨¡å—å’Œè¿œç¨‹æ¨¡å—ä¸­å®ç°ç¬¬ä¸‰æ–¹ä¾èµ–çš„å…±äº«</font>ã€‚





#### å†è°ˆ ESMï¼šé«˜é˜¶ç‰¹æ€§ & Pure ESM æ—¶ä»£

##### é«˜é˜¶ç‰¹æ€§

###### import map

åœ¨æµè§ˆå™¨ä¸­å¯ä»¥ä½¿ç”¨åŒ…å« `type="module"` å±æ€§çš„ `script` æ ‡ç­¾æ¥åŠ è½½ ES æ¨¡å—ï¼Œè€Œ<font color=dodgerBlue>æ¨¡å—è·¯å¾„ä¸»è¦åŒ…å«ä¸‰ç§</font>ï¼š

- ç»å¯¹è·¯å¾„ï¼Œå¦‚  `https://cdn.skypack.dev/react`
- ç›¸å¯¹è·¯å¾„ï¼Œå¦‚ `./module-a`
- bare import ï¼šå³ç›´æ¥å†™ä¸€ä¸ªç¬¬ä¸‰æ–¹åŒ…åï¼Œå¦‚ `react`ã€`lodash`

<font color=red>å‰ä¸¤ç§æ¨¡å—è·¯å¾„æµè§ˆå™¨æ˜¯åŸç”Ÿæ”¯æŒçš„</font>ï¼Œè€Œ<font color=dodgerBlue>å¯¹äº `bare import`</font>ï¼Œ<font color=red>åœ¨ Node.js èƒ½ç›´æ¥æ‰§è¡Œ</font>ï¼Œ<font color=red>å› ä¸º Node.js çš„è·¯å¾„è§£æç®—æ³•ä¼šä»é¡¹ç›®çš„ `node_modules` æ‰¾åˆ°ç¬¬ä¸‰æ–¹åŒ…çš„æ¨¡å—è·¯å¾„</font>ï¼Œä½†æ˜¯<font color=red>**æ”¾åœ¨æµè§ˆå™¨ä¸­æ— æ³•ç›´æ¥æ‰§è¡Œ**</font>ã€‚è€Œè¿™ç§å†™æ³•åœ¨æ—¥å¸¸å¼€å‘çš„è¿‡ç¨‹åˆæä¸ºå¸¸è§ï¼Œé™¤äº†å°† bare import æ‰‹åŠ¨æ›¿æ¢ä¸ºä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œè¿˜æœ‰å…¶å®ƒçš„è§£å†³æ–¹æ¡ˆå—ï¼Ÿ

ç­”æ¡ˆæ˜¯æœ‰çš„ã€‚ç°ä»£æµè§ˆå™¨å†…ç½®çš„ `import map` å°±æ˜¯ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥ä½¿ç”¨è¿™ä¸ªç‰¹æ€§ï¼š

```html
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
</head>

<body>
  <div id="root"></div>
  <script type="importmap">
  {
    "imports": {
      "react": "https://cdn.skypack.dev/react"
    }
  }
  </script>

  <script type="module">
    import React from 'react';
    console.log(React)
  </script>
</body>

</html>
```

åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œè¿™ä¸ª HTMLï¼Œå¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œå°±å¯ä»¥çœ‹åˆ°æµè§ˆå™¨å·²ç»ä»ç½‘ç»œä¸­è·å–äº† react çš„å†…å®¹ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š

<img src="https://s2.loli.net/2024/03/13/IjqTWPVBfvtMdQs.png" alt="image-20240313235859282" style="zoom:50%;" />

> âš ï¸ æ³¨æ„ï¼š<font color=red>`importmap` å¯èƒ½å­˜åœ¨æµè§ˆå™¨å…¼å®¹æ€§é—®é¢˜</font>ï¼Œæ‰€ä»¥<font color=red>å¦‚æœæµè§ˆå™¨ä¸­å‡ºç°æŠ¥é”™ä¹Ÿå±äºæ­£å¸¸æƒ…å†µ</font>ï¼Œä¸‹é¢ä¼šä»‹ç»è§£å†³æ–¹æ¡ˆã€‚

åœ¨æ”¯æŒ `import map` çš„æµè§ˆå™¨ä¸­ï¼Œ<font color=lightSeaGreen>åœ¨é‡åˆ° `type="importmap"` çš„ `script` æ ‡ç­¾æ—¶ï¼Œæµè§ˆå™¨ä¼šè®°å½•ä¸‹ç¬¬ä¸‰æ–¹åŒ…çš„è·¯å¾„æ˜ å°„è¡¨</font>ï¼Œ<font color=red>åœ¨é‡åˆ° `bare import` æ—¶ä¼šæ ¹æ®è¿™å¼ è¡¨æ‹‰å–è¿œç¨‹çš„ä¾èµ–ä»£ç </font>ã€‚å¦‚ä¸Šè¿°ä¾‹å­ä¸­ï¼Œä½¿ç”¨ `skypack` è¿™ä¸ªç¬¬ä¸‰æ–¹çš„ ESM CDN æœåŠ¡ï¼Œé€šè¿‡ `https://cdn.skypack.dev/react` è¿™ä¸ªåœ°å€å¯ä»¥æ‹¿åˆ° React çš„ ESM æ ¼å¼äº§ç‰©ã€‚

> ğŸ‘€ æ³¨æ„ï¼Œç”±äºæ•™ç¨‹æ˜¯ Vite2 æœ«æœŸçš„å°æµ‹ï¼Œæ‰€ä»¥ä¸‹é¢å…³äº `import map` çš„å…¼å®¹æ€§å’Œç°åœ¨ (2024/3/14) ç›¸æ¯”ï¼Œå·²ç»æœ‰å¾ˆå¤§ä¸åŒï¼Œä»å½“æ—¶çš„ 68.69% åˆ°äº†ç°åœ¨çš„ 91.2% ï¼Œå…¼å®¹æ€§å¥½äº†ä¸å°‘ï¼›ä¸è¿‡ä¾ç„¶è¿˜æ˜¯è¦è€ƒè™‘å…¼å®¹æ€§ï¼Œå°¤å…¶æ˜¯ Safari 16.4 æ‰æ”¯æŒ `import map`

`import map` ç‰¹æ€§è™½ç„¶ç®€æ´æ–¹ä¾¿ï¼Œä½†æµè§ˆå™¨çš„å…¼å®¹æ€§å´æ˜¯ä¸ªå¤§é—®é¢˜ï¼Œåœ¨ CanIUse ä¸Šçš„å…¼å®¹æ€§æ•°æ®å¦‚ä¸‹ï¼š

![image-20240314003351408](https://s2.loli.net/2024/03/14/IBaWg5jSOVLHAQo.png)

å¦å¤–ï¼Œ`type="module"` å…¼å®¹äº† 95% ä»¥ä¸Šçš„æµè§ˆå™¨

> ğŸ‘€ ç°åœ¨ ( 2024/3/14 ) CanIUse çš„ç™¾åˆ†æ¯”ä¾ç„¶æ˜¯ 95.68%ï¼Œæ²¡å¤ªå¤§å˜åŒ–

ç¤¾åŒºå·²ç»æœ‰äº†å¯¹åº”çš„ Polyfill è§£å†³æ–¹æ¡ˆï¼š[es-module-shims](https://github.com/guybedford/es-module-shims)ï¼Œå®Œæ•´åœ°å®ç°äº†åŒ…å« `import map` åœ¨å†…çš„å„å¤§ ESM ç‰¹æ€§ï¼Œè¿˜åŒ…æ‹¬:

1. dynamic import ï¼šå³åŠ¨æ€å¯¼å…¥ï¼Œéƒ¨åˆ†è€ç‰ˆæœ¬çš„ Firefox å’Œ Edge ä¸æ”¯æŒã€‚

2. `import.meta` å’Œ `import.meta.url`ã€‚å½“å‰æ¨¡å—çš„å…ƒä¿¡æ¯ï¼Œç±»ä¼¼ Node.js ä¸­çš„ `__dirname`ã€`__filename`ã€‚

3. `modulepreload` ï¼šä»¥å‰åœ¨ `link` æ ‡ç­¾ä¸­åŠ ä¸Š `rel="preload"` æ¥è¿›è¡Œèµ„æºé¢„åŠ è½½ï¼Œå³åœ¨æµè§ˆå™¨è§£æ HTML ä¹‹å‰å°±å¼€å§‹åŠ è½½èµ„æºï¼Œç°åœ¨å¯¹äº ESM ä¹Ÿæœ‰å¯¹åº”çš„ `modulepreload` æ¥æ”¯æŒè¿™ä¸ªè¡Œä¸ºã€‚

4. `JSON Modules` å’Œ `CSS Modules`ï¼Œå³é€šè¿‡å¦‚ä¸‹æ–¹å¼æ¥å¼•å…¥ `json` æˆ–è€… `css` ï¼š

   ```html
   <script type="module">
     // è·å– json å¯¹è±¡
     import json from 'https://site.com/data.json' assert { type: 'json' };
     // è·å– CSS Modules å¯¹è±¡
     import sheet from 'https://site.com/sheet.css' assert { type: 'css' };
   </script>
   ```

å€¼å¾—ä¸€æçš„æ˜¯ï¼Œ`es-module-shims` åŸºäº wasm å®ç°ï¼Œæ€§èƒ½å¹¶ä¸å·®ï¼Œç›¸æ¯”æµè§ˆå™¨åŸç”Ÿçš„è¡Œä¸ºæ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½ä¸‹é™ï¼š

<img src="https://s2.loli.net/2024/03/14/ndGUI2R8DCaHFPK.png" style="zoom:45%;" />

##### Node.js åŒ…å¯¼å…¥å¯¼å‡ºç­–ç•¥

åœ¨ Node.js ä¸­ï¼ˆ `>=12.20` ç‰ˆæœ¬ï¼‰ä¸€èˆ¬æœ‰å¦‚ä¸‹å‡ ç§æ–¹å¼å¯ä»¥ä½¿ç”¨åŸç”Ÿ ES Module ï¼š

- æ–‡ä»¶ä»¥ `.mjs` ç»“å°¾
- `package.json` ä¸­å£°æ˜ `type: "module"`ã€‚

é‚£ä¹ˆï¼ŒNode.js åœ¨å¤„ç† ES Module å¯¼å…¥å¯¼å‡ºæ—¶ï¼Œå¦‚æœæ˜¯å¤„ç† npm åŒ…çº§åˆ«çš„æƒ…å†µï¼Œå…¶ä¸­çš„ç»†èŠ‚æ¯”è¾ƒå¤æ‚ã€‚

é¦–å…ˆï¼Œ<font color=dodgerBlue>å¦‚ä½•å¯¼å‡ºä¸€ä¸ªåŒ…ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥é€‰æ‹©</font>ï¼š `main` å’Œ `exports` å±æ€§ã€‚è¿™ä¸¤ä¸ªå±æ€§å‡æ¥è‡ªäº `package.json`ï¼Œå¹¶ä¸”æ ¹æ® Node å®˜æ–¹çš„ resolve ç®—æ³•ï¼ˆ[æŸ¥çœ‹è¯¦æƒ…](http://nodejs.cn/api/esm.html#resolver-algorithm-specification)ï¼‰ï¼Œ`exports` çš„ä¼˜å…ˆçº§æ¯” `main` æ›´é«˜ï¼Œä¹Ÿå°±æ˜¯è¯´å¦‚æœåŒæ—¶è®¾ç½®äº†è¿™ä¸¤ä¸ªå±æ€§ï¼Œ`exports` ä¼šä¼˜å…ˆç”Ÿæ•ˆã€‚

`main` çš„ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œè®¾ç½®åŒ…çš„å…¥å£æ–‡ä»¶è·¯å¾„å³å¯ï¼Œå¦‚ï¼š

```json
"main": "./dist/index.js"
```

###### `exports` å¯¼å…¥

éœ€è¦é‡ç‚¹æ¢³ç†çš„æ˜¯ <font color=dodgerBlue>**`exports` å±æ€§ï¼Œå®ƒåŒ…å«äº†å¤šç§å¯¼å‡ºå½¢å¼**</font>ï¼šâ€œé»˜è®¤å¯¼å‡ºâ€ã€â€œå­è·¯å¾„å¯¼å‡ºâ€ å’Œ â€œæ¡ä»¶å¯¼å‡ºâ€ï¼Œè¿™äº›å¯¼å‡ºå½¢å¼å¦‚ä»¥ä¸‹çš„ä»£ç æ‰€ç¤ºï¼š

```json
// package.json
{
  "name": "package-a",
  "type": "module",
  "exports": {
    // é»˜è®¤å¯¼å‡ºï¼Œä½¿ç”¨æ–¹å¼: import a from 'package-a'
    ".": "./dist/index.js",
    // å­è·¯å¾„å¯¼å‡ºï¼Œä½¿ç”¨æ–¹å¼: import d from 'package-a/dist'
    "./dist": "./dist/index.js",
    "./dist/*": "./dist/*", // è¿™é‡Œå¯ä»¥ä½¿ç”¨ `*` å¯¼å‡ºç›®å½•ä¸‹æ‰€æœ‰çš„æ–‡ä»¶
    // æ¡ä»¶å¯¼å‡ºï¼ŒåŒºåˆ† ESM å’Œ CommonJS å¼•å…¥çš„æƒ…å†µ
    "./main":Â {
Â Â Â Â   "import":Â "./main.js",
Â Â Â Â   "require":Â "./main.cjs"
    },
  }
}
```

å…¶ä¸­ï¼Œæ¡ä»¶å¯¼å‡ºå¯ä»¥åŒ…æ‹¬å¦‚ä¸‹å¸¸è§çš„å±æ€§ï¼š

- `node` ï¼šåœ¨ Node.js ç¯å¢ƒä¸‹é€‚ç”¨ï¼Œå¯ä»¥å®šä¹‰ä¸ºåµŒå¥—æ¡ä»¶å¯¼å‡ºï¼Œå¦‚ï¼š

  ```json
  {
    "exports":Â {
      {
        ".": {
         "node": {
           "import":Â "./main.js",
           "require":Â "./main.cjs"
          }     
        }
      }
    },
  }
  ```

- `import` ï¼šç”¨äº import æ–¹å¼å¯¼å…¥çš„æƒ…å†µï¼Œå¦‚ `import("package-a")`;

- `require` ï¼šç”¨äº require æ–¹å¼å¯¼å…¥çš„æƒ…å†µï¼Œå¦‚ `require("package-a")`;

- `default` ï¼šå…œåº•æ–¹æ¡ˆï¼Œå¦‚æœå‰é¢çš„æ¡ä»¶éƒ½æ²¡å‘½ä¸­ï¼Œåˆ™ä½¿ç”¨ default å¯¼å‡ºçš„è·¯å¾„ã€‚

å¦å¤–ï¼Œæ¡ä»¶å¯¼å‡ºè¿˜åŒ…å« `types`ã€`browser`ã€`develoment`ã€`production` ç­‰å±æ€§ï¼Œå¯ä»¥å‚è€ƒ Node.js çš„ [è¯¦æƒ…æ–‡æ¡£](https://nodejs.org/api/packages.html#conditional-exports)ï¼Œè¿™é‡Œç•¥ã€‚

###### `imports` å¯¼å‡º

å†çœ‹ â€œå¯¼å…¥â€ï¼Œä¹Ÿå°±æ˜¯ `package.json` ä¸­çš„ `imports` å­—æ®µï¼Œä¸€èˆ¬æ˜¯è¿™æ ·å£°æ˜çš„ï¼š

```json
{
  "imports": {
    // key ä¸€èˆ¬ä»¥ # å¼€å¤´
    // ä¹Ÿå¯ä»¥ç›´æ¥èµ‹å€¼ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²: "#dep": "lodash-es"
    "#dep": {
      "node": "lodash-es",
      "default": "./dep-polyfill.js"
    },
  },
  "dependencies": {
    "lodash-es": "^4.17.21"
  }
}
```

è¿™æ ·ä½ å¯ä»¥åœ¨è‡ªå·±çš„åŒ…ä¸­ä½¿ç”¨ä¸‹é¢çš„ import è¯­å¥ï¼š

```js
// index.js
import { cloneDeep } from "#dep";

const obj = { a: 1 };
console.log(cloneDeep(obj)); // { a: 1 }
```

Node.js åœ¨æ‰§è¡Œçš„æ—¶å€™ä¼šå°† `#dep` å®šä½åˆ° `lodash-es` è¿™ä¸ªç¬¬ä¸‰æ–¹åŒ…ï¼Œå½“ç„¶ï¼Œä¹Ÿå¯ä»¥å°†å…¶å®šä½åˆ°æŸä¸ªå†…éƒ¨æ–‡ä»¶ã€‚è¿™æ ·ç›¸å½“äºå®ç°äº† â€œè·¯å¾„åˆ«åâ€ çš„åŠŸèƒ½ï¼Œä¸è¿‡ä¸æ„å»ºå·¥å…·ä¸­çš„ `alias` åŠŸèƒ½ä¸åŒçš„æ˜¯ï¼Œ<font color=red>`imports` ä¸­å£°æ˜çš„åˆ«åå¿…é¡»å…¨é‡åŒ¹é…ï¼Œå¦åˆ™ Node.js ä¼šç›´æ¥æŠ›é”™</font>ã€‚



### Vite å®è·µè¡¥å……

##### å¸¦æœ‰æŸ¥è¯¢åç¼€çš„å¯¼å…¥

åœ¨çœ‹ Vite æ–‡æ¡£æ—¶ï¼Œå¯¹ [Vite doc - åŠŸèƒ½ # é™æ€èµ„æºå¤„ç†](https://cn.vitejs.dev/guide/features#static-assets) ä»¥åŠæ›´è¯¦ç»†çš„ [Vite doc - é™æ€èµ„æºå¤„ç†](https://cn.vitejs.dev/guide/assets) ä¸­çš„ â€œ[å¸¦æœ‰æŸ¥è¯¢åç¼€çš„å¯¼å…¥](https://cn.vitejs.dev/guide/features#import-with-query-suffixes)â€ å¹¶æ²¡æœ‰æ”¾åœ¨å¿ƒä¸Šï¼Œæ„Ÿè§‰å’Œ webpack ä¸­ resource query ç±»ä¼¼çš„ä¸œè¥¿ï¼ˆè™½ç„¶å¾ˆå¤§ç¨‹åº¦ä¸Šï¼Œä¸ªäººæ„Ÿè§‰æ˜¯ Vite æ–‡æ¡£å†™å¾—ç›¸å½“æµ…ï¼‰ã€‚

ç›´åˆ°ï¼Œçœ‹åˆ° [è¯»å–æ–‡ä»¶åŸå§‹å†…å®¹ã€æ¸¡ä¸€æ•™è‚²ã€‘](https://www.bilibili.com/video/BV1WMWHenEVW) å‘ç°é€šè¿‡å¯¹ä¸€ä¸ª base64 æ ¼å¼ä¿å­˜çš„å›¾ç‰‡æ–‡ä»¶ï¼Œåœ¨å¼•å…¥æ—¶è·¯å¾„åŠ ä¸Š `?raw` ï¼Œä¾¿å¯ä»¥æ›¿ä»£ `webpack.config.js` ä¸­å®šä¹‰ `module.rules.loader` ä¸­é…ç½® `raw-loader` çš„æ•ˆæœï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªå›¾ç‰‡çš„å¯¼å‡ºç»“æœ



#### æ„å»ºç›¸å…³

##### Vite æ„å»ºäº§ç‰©çš„ç›®å½•ç»“æ„æ§åˆ¶

åœ¨ rollup ä¸­ï¼Œå¯ä»¥é€šè¿‡ `output.entryFileNames` è®¾ç½®æ„å»ºäº§ç‰©çš„å…¥å£æ–‡ä»¶åœ°å€ä¸æ–‡ä»¶åï¼Œé€šè¿‡ `output.chunkFileNames` è®¾ç½® chunk çš„åœ°å€ä¸æ–‡ä»¶åï¼Œé€šè¿‡ `output.assetFileNames` è®¾ç½®æ‰€æœ‰é™æ€æ–‡ä»¶ï¼ˆæ‰€æœ‰é js æ–‡ä»¶ï¼‰çš„åœ°å€ä¸æ–‡ä»¶åã€‚ä¸Šè¿°ä¸‰ä¸ªå±æ€§ä¸º `string | ((chunkInfo: ChunkInfo) => string)`ï¼Œå³ï¼šæ—¢å¯ä»¥æ˜¯å„ç§å ä½ç¬¦ ( placeholder ) ä»¥åŠå­—ç¬¦å½¢æˆçš„å­—ç¬¦ä¸² stringï¼Œä¹Ÿå¯ä»¥æ˜¯è¿”å› string çš„å‡½æ•°ã€‚

é»˜è®¤æƒ…å†µä¸‹ï¼ŒVite æ„å»ºäº§ç‰©çš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼›å½“ç„¶ï¼Œè¿™æ˜¯å·¥ç¨‹ç®€å•çš„æƒ…å†µã€‚

<img src="https://s2.loli.net/2024/05/11/5DpajkRzSi61MYb.png" alt="image-20240511001054437" style="zoom:50%;" />

å¯è§ Vite å°†å›¾ç‰‡ã€æ ·å¼æ–‡ä»¶ã€js ç­‰ç»Ÿç»Ÿæ”¾å…¥äº† `assets/` æ–‡ä»¶å¤¹ä¸­ï¼Œå¹¶æ²¡æœ‰ç»™å®ƒä»¬å…·ä½“å½’ç±»æ”¾å…¥å¯¹åº”çš„æ–‡ä»¶å¤¹ã€‚

å¦‚æœæƒ³è¦å®ç°å½’ç±»ï¼Œæ¯”å¦‚ï¼šæŠŠ js æ–‡ä»¶æ”¾å…¥ `js/` æ–‡ä»¶å¤¹ï¼Œcss æ–‡ä»¶æ”¾å…¥ `css/` æ–‡ä»¶å¤¹ï¼Œå›¾ç‰‡æ–‡ä»¶æ”¾å…¥ `imgs/` æ–‡ä»¶å¤¹ï¼Œå¯ä»¥åšåœ¨ `build.rollupOptions` ä¸‹åšå¦‚ä¸‹é…ç½®ï¼š

```ts
// vite.config.ts
export default defineConfig({
  // ...
  build: {
    rollupOptions: {
      output: {
        entryFileNames: 'js/[name]-[hash].js',
        chunkFileNames: 'js/[name]-[hash].js',
        // assetFileNames: '[ext]/[name]-[hash].[ext]'
        // æ›´è¿›ä¸€æ­¥
        assetFileNames(assetInfo) {
          const { name } = assetInfo
          const lowerCaseName = name.toLowerCase()
          if (lowerCaseName.endsWith('.css')) {
            return 'css/[name]-[hash].css'
          }
          const imgExts = ['.png', '.jpg', '.jpeg', '.webp', '.svg', '.gif', '.ico']
          if (imgExts.some(ext => lowerCaseName.endWith(ext))) {
            return 'imgs/[name]-[hash].[ext]'
          }
          return 'assets/[name]-[hash].[ext]'
        }
      }
    }
  }
})
```

> ğŸ’¡ è¡¥å……
>
> ç±»ä¼¼çš„ï¼Œä¸Šè¿°å†…å®¹ä¹Ÿå¯ä»¥åœ¨ webpack ä¸­æ‰¾åˆ°ç±»ä¼¼çš„é…ç½®ï¼Œå…·ä½“å¯è§ [webpack doc - configuration - output](https://webpack.js.org/configuration/output)

å­¦ä¹ è‡ªï¼š[viteæ‰“åŒ…ç»“æ„æ§åˆ¶ã€æ¸¡ä¸€æ•™è‚²ã€‘](https://www.bilibili.com/video/BV1mH4y1G7BD)

##### Vite æ„å»ºç§»é™¤é¡¹ç›®ä¸­çš„ console

åœ¨ Vite ä¸­å†…ç½®äº†ç§»é™¤ console è®¾ç½®çš„æ–¹æ³•ï¼Œåœ¨ `vite.config.js` ä¸­é…ç½®å³å¯ã€‚

```js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  build: {
    minify: 'terser',
    terserOptions: {
      compress: {
        //ç”Ÿäº§ç¯å¢ƒæ—¶ç§»é™¤console
        drop_console: true,
        drop_debugger: true,
      },
    },
  },
})
```

ä¹Ÿå¯ä»¥ä½¿ç”¨ esbuild è‡ªå¸¦çš„æ–¹æ³•ï¼Œç›¸å…³æ–‡æ¡£è§ [esbuild doc - api # drop](https://esbuild.github.io/api/#drop) ï¼Œ`vite.config.js` é…ç½®å¦‚ä¸‹ï¼š

```js
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'

export default defineConfig({
  plugins: [vue()],
  esbuild:{
    pure: ['console.log'],  
    drop: ['debugger'],
  },
})
```

å¦å¤–ï¼Œåœ¨ Vue CLI çš„é¡¹ç›®ä¸­ï¼Œåªèƒ½ä½¿ç”¨ `babel-plugin-transform-remove-console` æ’ä»¶ã€‚

å­¦ä¹ è‡ªï¼š[viteç§»é™¤é¡¹ç›®ä¸­çš„console](https://juejin.cn/post/6993225840117055496)

##### Vite Chunk åˆ†åŒ…

åœ¨ Vite ä¸­å¯ä»¥ä½¿ç”¨ [`build.rollupOptions.output.manualChunks`](https://cn.rollupjs.org/configuration-options/#output-manualchunks)Â æ¥è‡ªå®šä¹‰ chunk åˆ†å‰²ç­–ç•¥ã€‚å¦å¤–ï¼Œçœ‹äº†ä¸‹æ–‡æ¡£ï¼Œå®ƒçš„ç±»å‹ä¸º `{ [chunkAlias: string]: string[] } | ((id: string, {getModuleInfo, getModuleIds}) => string | void)` ï¼Œç›¸è¾ƒ webpack ä¸­ [`optimization.splitChunks`](https://webpack.js.org/plugins/split-chunks-plugin) çš„å„ç§é…ç½®ï¼Œè¦ç®€å•å¾ˆå¤šã€‚



## webpack

#### resource query

å§‹ç»ˆæ„Ÿè§‰å¯¹ resource query æ¦‚å¿µæœ‰ç‚¹ä¸äº†è§£ï¼Œä¸ä»…ä»…æ˜¯åˆšå¼€å§‹åœ¨ webpack ä¸­äº†è§£ï¼Œåœ¨ Vite ä¸­ä¹Ÿæœ‰ç±»ä¼¼çš„å†™æ³•ï¼ˆæŸ¥çœ‹ Vite ä¸­è‹±æ–‡æ–‡æ¡£ï¼Œä½†æ˜¯å¯¹äº â€œresource queryâ€ ä¸€ç‚¹éƒ½æœä¸åˆ°ï¼‰ï¼›å†è€…ï¼ŒGoogle æœç´¢ â€œresource queryâ€ å‰å‡ æ¡ä¸æ˜¯å…³äº AWSã€Azure ç­‰äº‘æœåŠ¡çš„ï¼Œå°±æ˜¯ Resource Query Language çš„ï¼Œäºæ˜¯é—®äº† GPT ï¼š

<img src="https://s2.loli.net/2024/08/28/TK6OD1szb3hAeg9.png" alt="image-20240828101253028" style="zoom:50%;" />

<img src="https://s2.loli.net/2024/08/28/qFn7e8UXpT9k4hO.png" alt="image-20240828101331976" style="zoom:50%;" />

äºæ˜¯æœ‰ç‚¹æ˜ç™½äº†ã€‚




## å…¶ä»–

#### unplugin-auto-import çš„ä½¿ç”¨

##### ä»¥ vite ä¸ºä¾‹çš„é…ç½®

```ts
// vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import AutoImport from 'unplugin-auto-import/vite' // ğŸ’¡ é™¤äº† vite è¿˜æœ‰ webpack å’Œ rollup ç­‰ç­‰ï¼Œè¯¦è§æ–‡æ¡£

export default defineConfig({
  plugins: [vue(), AutoImport({
    imports: ['vue', 'vue-router'], // éœ€è¦å¯¼å…¥å“ªäº›åŒ…ä¸­çš„æ¨¡å—
    dirs: ['./src/api'], // éœ€è¦å¯¼å…¥çš„æœ¬åœ°æ¨¡å—
    dts: './src/auto-import.d.ts', // å¦‚æœæ˜¯ ts å¼€å‘ï¼Œåªæœ‰ä¸Šé¢çš„é…ç½®ï¼Œåœ¨å¼€å‘æ—¶ä¼šå‘ç°ç±»å‹å£°æ˜ä¸¢å¤±ï¼ˆå¦‚æœæ˜¯ js ä¸ä¼šå­˜åœ¨è¿™ç§é—®é¢˜ï¼ï¼‰ï¼›æ‰€ä»¥éœ€è¦æ’ä»¶æ¥è‡ªåŠ¨ç”Ÿæˆç±»å‹å®šä¹‰ï¼Œåœ¨å¯åŠ¨é¡¹ç›®ä¹‹åï¼Œå°†ä¼šåˆ›å»ºå¯¹åº”çš„æ–‡ä»¶ï¼Œå°† "imports" å’Œ "dirs" ä¸­æ¨¡å—çš„ç±»å‹å®šä¹‰å†™å…¥å…¶ä¸­ã€‚è¿™é‡Œå°±æ˜¯åœ¨è¯´æ˜ç”Ÿæˆç±»å‹å®šä¹‰æ–‡ä»¶çš„åœ°å€ï¼Œå¯ä»¥æŒ‰ç…§è‡ªå·±æƒ³æ³•å®šä¹‰ã€‚
  })]
})
```

æŒ‰ç…§å¦‚ä¸Šé…ç½®ï¼Œå¦‚ä¸‹å¼•å…¥ï¼ˆä»¥åŠç±»ä¼¼çš„ä¸œè¥¿ï¼‰å°†æ²¡æœ‰å¿…è¦å†å†™äº†

```ts
import { ref, reactive } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { foo } from './src/api'
```

å¦å¤–ï¼Œçœ‹äº†ä¸‹å®˜æ–¹ repo çš„ readme [GitHub - unplugin-auto-import](https://github.com/unplugin/unplugin-auto-import) æ„Ÿè§‰ï¼Œç›¸å½“æ˜“æ‡‚
