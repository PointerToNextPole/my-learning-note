# å‰ç«¯å·¥ç¨‹åŒ–ç¬”è®°



## pnpm

#### pnpm env \<cmd>

ç®¡ç† Node.js ç¯å¢ƒã€‚ğŸ’¡ ç±»ä¼¼äº nvm å’Œ n ç­‰åŒ…ç®¡ç†å·¥å…·

##### å‘½ä»¤è¡Œ

å®‰è£…å¹¶ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„ Node.jsã€‚

###### å®‰è£… LTS ç‰ˆæœ¬çš„ Node.js

```bash
pnpm env use --global lts
pnpm env use --global argon
```

###### å®‰è£… v16 çš„Node.js

```bash
pnpm env use --global 16
```

###### å®‰è£… Node.js çš„é¢„å‘è¡Œç‰ˆæœ¬

```bash
pnpm env use --global nightly
pnpm env use --global rc
pnpm env use --global 16.0.0-rc.0
pnpm env use --global rc/14
```

###### å®‰è£…æœ€æ–°ç‰ˆæœ¬çš„ Node.js

```bash
pnpm env use --global latest
```

##### é…ç½®é¡¹

- `--global` , `-g`ï¼šæ­¤æ›´æ”¹å°†å…¨å±€ç”Ÿæ•ˆã€‚

æ‘˜è‡ªï¼š[pnpm doc - pnpm env \<cmd>](https://pnpm.io/zh/cli/env)



#### Workspace

pnpm has <font color=dodgerBlue>built-in support for monorepositories</font>ï¼ˆğŸ‘€ å³ monorepo ï¼‰ï¼ŒYou can <font color=red>create a workspace to unite multiple projects inside a single repository</font>.

<font color=red>A workspace **must** have a [`pnpm-workspace.yaml`](https://pnpm.io/pnpm-workspace_yaml) file in its root</font>. A workspace also <font color=LightSeaGreen>**may** have an [`.npmrc`](https://pnpm.io/npmrc) in its root</font>.

##### Workspace protocol ( `workspace:`)

<font color=dodgerBlue>By default</font>, <font color=red>pnpm will link packages from the workspace</font> <font color=LightSeaGreen>if the available packages match the declared ranges</font>. For instance, <font color=red>`foo@1.0.0` is linked into `bar`Â **if `bar` has `"foo": "^1.0.0"` in its dependencies**</font> and <font color=fuchsia>`foo@1.0.0` is in the workspace</font>. However, if `bar` has `"foo": "2.0.0"` in dependencies and <font color=dodgerBlue>**`foo@2.0.0` is not in the workspace**</font>, `foo@2.0.0` will be installed from the registryï¼ˆğŸ‘€ æ³¨æ„ä¸ä¸‹é¢ workspace çš„è¡Œä¸ºå¯¹æ¯”ï¼‰. This behavior introduces some uncertaintyï¼ˆğŸŒ è¯¥è¡Œä¸ºå°†ä¼šå¼•å…¥ä¸ç¡®å®šæ€§ï¼‰.

Luckily, <font color=red>**pnpm supports the `workspace:` protocol**</font>. <font color=dodgerBlue>When this protocol is used</font>, <font color=fuchsia>pnpm will **refuse to resolve to anything other than a local workspace package**</font>. So, <font color=dodgerBlue>**if you set `"foo": "workspace:2.0.0"`**</font> , <font color=fuchsia>**this time installation will fail** because `"foo@2.0.0"` isn't present in the workspace</font>.

This protocol is especially useful when the [link-workspace-packages](https://pnpm.io/npmrc#link-workspace-packages) option is set to `false` . <font color=red>In that case, pnpm will only link packages from the workspace **if the `workspace:` protocol is used**</font>.

###### Referencing workspace packages through aliases

<font color=dodgerBlue>Let's say you have a package in the workspace named `foo`</font> . <font color=dodgerBlue>**Usually**</font>, <font color=red>you would reference it as `"foo": "workspace:*"`</font> .

If you want to use a different alias, the following syntax will work too: `"bar": "workspace:foo@*"` .

<font color=fuchsia>Before publish, **aliases are converted to regular aliased dependencies**</font>. The <font color=LightSeaGreen>above example will become: `"bar": "npm:foo@1.0.0"`</font> .

###### Referencing workspace packages through their relative path

In a workspace with 2 packages:

```text
+ packages
    + foo
    + bar
```

`bar` may have `foo` in its dependencies declared as `"foo": "workspace:../foo"` . Before publishing, these specs are converted to regular version specs supported by all package managers.

###### Publishing workspace packages

When a workspace package is packed into an archive (whether it's through `pnpm pack` or one of the publish commands like `pnpm publish` ), <font color=dodgerBlue>we **dynamically replace** any `workspace:` dependency by</font>:

- The corresponding version in the target workspace (if you use `workspace:*` , `workspace:~` , or `workspace:^` )
- The associated semver range (for any other range type)

So for example, if we have `foo` , `bar` , `qar` , `zoo` in the workspace and they all are at version `1.5.0` , the following:

```json
{
    "dependencies": {
        "foo": "workspace:*",
        "bar": "workspace:~",
        "qar": "workspace:^",
        "zoo": "workspace:^1.5.0"
    }
}
```

<font color=dodgerBlue>Will be transformed into:</font>

```json
{
    "dependencies": {
        "foo": "1.5.0",
        "bar": "~1.5.0",
        "qar": "^1.5.0",
        "zoo": "^1.5.0"
    }
}
```

This feature allows you to depend on your local workspace packages while <font color=fuchsia>still being able to publish the resulting packages to the remote registry without needing intermediary publish steps</font> - <font color=red>your consumers will be able to use your published workspaces as any other package</font>, still benefitting from the guarantees semver offers.

æ‘˜è‡ªï¼š[pnpm doc - Workspace](https://pnpm.io/workspaces#workspace-protocol-workspace)



## Babel

##### ä¸€äº›èµ„æ–™

- [Babel å®˜ç½‘](https://babel.dev)
- [babel-handbook](https://github.com/jamiebuilds/babel-handbook)

- [ç¥è¯´è¦æœ‰å…‰ - Babel æ’ä»¶é€šå…³ç§˜ç± ](https://juejin.cn/book/6946117847848321055/section) è¿™ä¹Ÿæ˜¯è¿™é‡Œ Babel ç¬”è®°çš„ä¸»è¦æ‘˜æŠ„



### ã€ŠBabel æ’ä»¶é€šå…³ç§˜ç±ã€‹ç¬”è®°



#### Babel ä»‹ç»

babel æ˜¯ JS çš„è½¬è¯‘å™¨ (  JavaScript Transpiler ) ğŸ‘€ è¯¦è§ [[#ç¼–è¯‘å™¨å’Œè½¬è¯‘å™¨]]

##### å‘½åæ¼”åŒ–

babel æœ€å¼€å§‹å« 6to5ï¼Œé¡¾åæ€ä¹‰æ˜¯ es6 è½¬ es5ï¼Œä½†æ˜¯åæ¥éšç€ es æ ‡å‡†çš„æ¼”è¿›ï¼Œæœ‰äº† es7ã€es8 ç­‰ï¼Œ 6to5 çš„åå­—å·²ç»ä¸åˆé€‚äº†ï¼Œæ‰€ä»¥æ”¹åä¸ºäº† babelã€‚

##### Babel çš„ä¸‰ç§ç”¨é€”

###### è½¬è¯‘ ES Nextã€TypeScriptã€Flow ç­‰åˆ°ç›®æ ‡ç¯å¢ƒæ”¯æŒçš„ js

è¿™ä¸ªæ˜¯<font color=red>æœ€å¸¸ç”¨çš„åŠŸèƒ½</font>ï¼Œç”¨æ¥æŠŠä»£ç ä¸­çš„ ES Next çš„æ–°çš„è¯­æ³•ã€TypeScript å’Œ Flow çš„è¯­æ³•è½¬æˆåŸºäºç›®æ ‡ç¯å¢ƒæ”¯æŒçš„è¯­æ³•çš„å®ç°ã€‚å¹¶ä¸”è¿˜å¯ä»¥æŠŠç›®æ ‡ç¯å¢ƒä¸æ”¯æŒçš„ api è¿›è¡Œ polyfillã€‚

> ğŸ’¡ è¿˜æœ‰ jsx çš„ç¼–è¯‘

<font color=red>babel7 æä¾›äº† @babel/preset-env çš„åŒ…</font>ï¼Œå¯ä»¥<font color=red>æŒ‡å®šç›®æ ‡ env æ¥æŒ‰éœ€è½¬æ¢ï¼Œè½¬æ¢æ›´åŠ çš„ç²¾å‡†ï¼Œäº§ç‰©æ›´å°</font>ã€‚

###### ä¸€äº›ç‰¹å®šç”¨é€”çš„ä»£ç è½¬æ¢

babel æ˜¯ä¸€ä¸ªè½¬è¯‘å™¨ï¼Œæš´éœ²äº†å¾ˆå¤š apiï¼Œç”¨è¿™äº› api å¯ä»¥å®Œæˆ<font color=red>ä»£ç åˆ° AST çš„è§£æã€è½¬æ¢ã€ä»¥åŠç›®æ ‡ä»£ç çš„ç”Ÿæˆ</font>ã€‚

<font color=dodgerBlue>å¼€å‘è€…å¯ä»¥ç”¨å®ƒæ¥å®Œæˆä¸€äº›ç‰¹å®šç”¨é€”çš„è½¬æ¢</font>ï¼Œæ¯”å¦‚<font color=red>å‡½æ•°æ’æ¡©</font>ï¼ˆ<font color=red>å‡½æ•°ä¸­è‡ªåŠ¨æ’å…¥ä¸€äº›ä»£ç </font>ï¼Œä¾‹å¦‚<font color=red>åŸ‹ç‚¹ä»£ç </font>ï¼‰ã€<font color=red>è‡ªåŠ¨å›½é™…åŒ–</font>ç­‰ã€‚<font color=LightSeaGreen>æµè¡Œçš„å°ç¨‹åºè½¬è¯‘å·¥å…· taroï¼Œå°±æ˜¯åŸºäº babel çš„ api æ¥å®ç°çš„</font>ã€‚

###### ä»£ç çš„é™æ€åˆ†æ

<font color=red>å¯¹ä»£ç è¿›è¡Œ parse ä¹‹åï¼Œä¼šç”Ÿæˆ ASTï¼Œé€šè¿‡ AST èƒ½å¤Ÿç†è§£ä»£ç ç»“æ„</font>ï¼Œé™¤äº†è½¬æ¢ AST å†æ‰“å°æˆç›®æ ‡ä»£ç ä¹‹å¤–ï¼Œä¹ŸåŒæ ·<font color=red>å¯ä»¥**ç”¨äºåˆ†æä»£ç çš„ä¿¡æ¯ï¼Œè¿›è¡Œä¸€äº›é™æ€æ£€æŸ¥**</font>ã€‚

- <font color=red>linter å·¥å…·</font>å°±æ˜¯åˆ†æ AST çš„ç»“æ„ï¼Œå¯¹ä»£ç è§„èŒƒè¿›è¡Œæ£€æŸ¥ã€‚
- <font color=LightSeaGreen>api æ–‡æ¡£è‡ªåŠ¨ç”Ÿæˆå·¥å…·</font>ï¼Œå¯ä»¥æå–æºç ä¸­çš„æ³¨é‡Šï¼Œç„¶åç”Ÿæˆæ–‡æ¡£ã€‚
- <font color=red>type checker</font> ä¼šæ ¹æ®ä» AST ä¸­æå–çš„æˆ–è€…æ¨å¯¼çš„ç±»å‹ä¿¡æ¯ï¼Œå¯¹ AST è¿›è¡Œç±»å‹æ˜¯å¦ä¸€è‡´çš„æ£€æŸ¥ï¼Œä»è€Œå‡å°‘è¿è¡Œæ—¶å› ç±»å‹å¯¼è‡´çš„é”™è¯¯ã€‚ğŸ‘€ æ¯”å¦‚ tsc
- <font color=red>å‹ç¼©æ··æ·†å·¥å…·</font>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯åˆ†æä»£ç ç»“æ„ï¼Œè¿›è¡Œåˆ é™¤æ­»ä»£ç ã€å˜é‡åæ··æ·†ã€å¸¸é‡æŠ˜å ç­‰å„ç§ç¼–è¯‘ä¼˜åŒ–ï¼Œç”Ÿæˆä½“ç§¯æ›´å°ã€æ€§èƒ½æ›´ä¼˜çš„ä»£ç ã€‚
- JS è§£é‡Šå™¨ï¼Œé™¤äº†å¯¹ AST è¿›è¡Œå„ç§ä¿¡æ¯çš„æå–å’Œæ£€æŸ¥ä»¥å¤–ï¼Œæˆ‘ä»¬<font color=red>è¿˜å¯ä»¥ç›´æ¥è§£é‡Šæ‰§è¡Œ AST</font>ã€‚



#### Babel çš„ç¼–è¯‘æµç¨‹

##### ç¼–è¯‘å™¨å’Œè½¬è¯‘å™¨

ç¼–è¯‘çš„å®šä¹‰å°±æ˜¯ä»ä¸€ç§ç¼–ç¨‹è¯­è¨€è½¬æˆå¦ä¸€ç§ç¼–ç¨‹è¯­è¨€ã€‚ä¸»è¦æŒ‡çš„æ˜¯é«˜çº§è¯­è¨€åˆ°ä½çº§è¯­è¨€ã€‚

<font color=LightSeaGreen>ä¸€èˆ¬ç¼–è¯‘å™¨ Compiler æ˜¯æŒ‡é«˜çº§è¯­è¨€åˆ°ä½çº§è¯­è¨€çš„è½¬æ¢å·¥å…·</font>ã€‚è€Œ<font color=fuchsia>ä» **é«˜çº§è¯­è¨€** åˆ° **é«˜çº§è¯­è¨€** çš„ **è½¬æ¢å·¥å…·**ï¼Œè¢«å«åš <font size=4>**è½¬æ¢ç¼–è¯‘å™¨**</font>ï¼Œç®€ç§° **è½¬è¯‘å™¨** ( Transpiler )</font>ã€‚Babel å°±æ˜¯ä¸€ä¸ª JavaScript Transpilerã€‚

##### Babel çš„ç¼–è¯‘æµç¨‹

<font color=fuchsia>Babel æ˜¯ **source to source çš„è½¬æ¢**</font>ï¼Œæ•´ä½“ç¼–è¯‘æµç¨‹åˆ†ä¸ºä¸‰æ­¥ï¼š

- **parse**ï¼šé€šè¿‡ <font color=red>parser æŠŠæºç è½¬æˆæŠ½è±¡è¯­æ³•æ ‘ ( AST )</font>
- **transform**ï¼š<font color=red>éå† ASTï¼Œè°ƒç”¨å„ç§ transform æ’ä»¶å¯¹ AST è¿›è¡Œå¢åˆ æ”¹</font>
- **generate**ï¼šæŠŠ<font color=red>è½¬æ¢åçš„ AST æ‰“å°</font>ï¼ˆğŸ‘€ ç”Ÿï¼Ÿï¼‰<font color=red>æˆç›®æ ‡ä»£ç </font>ï¼Œå¹¶ <font color=fuchsia size=4>**ç”Ÿæˆ sourcemap**</font>

![img](https://s2.loli.net/2023/01/03/79luiCsc6EPqxfA.png)

##### ä¸ºä»€ä¹ˆ babel çš„ç¼–è¯‘æµç¨‹ä¼šåˆ† parseã€transformã€generate è¿™ 3 æ­¥

æºç æ˜¯ä¸€ä¸²æŒ‰ç…§è¯­æ³•æ ¼å¼æ¥ç»„ç»‡çš„å­—ç¬¦ä¸²ï¼Œ<font color=LightSeaGreen>äººèƒ½å¤Ÿè®¤è¯†ï¼Œä½†æ˜¯è®¡ç®—æœºå¹¶ä¸è®¤è¯†</font>ï¼›<font color=red>æƒ³è®©è®¡ç®—æœºè®¤è¯†å°±è¦è½¬æˆä¸€ç§æ•°æ®ç»“æ„ï¼Œé€šè¿‡ä¸åŒçš„å¯¹è±¡æ¥ä¿å­˜ä¸åŒçš„æ•°æ®ï¼Œå¹¶ä¸”æŒ‰ç…§ä¾èµ–å…³ç³»ç»„ç»‡èµ·æ¥</font>ï¼›è¿™ç§æ•°æ®ç»“æ„å°±æ˜¯æŠ½è±¡è¯­æ³•æ ‘ ( abstract syntax tree )ã€‚

ä¹‹æ‰€ä»¥å«â€œæŠ½è±¡â€è¯­æ³•æ ‘æ˜¯å› ä¸º<font color=red>æ•°æ®ç»“æ„ä¸­çœç•¥æ‰äº†ä¸€äº›æ— å…·ä½“æ„ä¹‰çš„åˆ†éš”ç¬¦æ¯”å¦‚ `;` `{` `}`ç­‰</font> 

> ğŸ’¡ å‚è€ƒ [ç¼–ç¨‹è¯­è¨€çš„å‘å±•è¶‹åŠ¿ï¼šä»æ²¡æœ‰åˆ†å·ï¼Œåˆ°DSL](https://mp.weixin.qq.com/s/_SOlzlLG6ua8kXxnPltX0g) ä¸­æ‰€è¯´ï¼š
>
> > åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œåˆ†å·æ˜¯ç»™æœºå™¨çœ‹çš„ï¼Œè€Œä¸æ˜¯ç»™äººçœ‹çš„ã€‚**å†™åˆ†å·ï¼Œæœ¬è´¨æ˜¯æˆ‘ä»¬äººç±»åœ¨è¿å°±ç¼–è¯‘å™¨**ï¼Œæ¯•ç«Ÿï¼Œæœºå™¨æ˜¯å¾ˆå‚»çš„ã€‚
>
> ç±»ä¼¼çš„ï¼Œ`{}` æ‹¬å·ä¹Ÿæ˜¯ã€‚

æœ‰äº† ASTï¼Œè®¡ç®—æœºå°±èƒ½ç†è§£æºç å­—ç¬¦ä¸²çš„æ„æ€ï¼Œè€Œç†è§£æ˜¯èƒ½å¤Ÿè½¬æ¢çš„å‰æï¼Œæ‰€ä»¥ç¼–è¯‘çš„ç¬¬ä¸€æ­¥éœ€è¦æŠŠæºç  parse æˆ ASTã€‚

è½¬æˆ AST ä¹‹åå°±å¯ä»¥é€šè¿‡ä¿®æ”¹ AST çš„æ–¹å¼æ¥ä¿®æ”¹ä»£ç ï¼Œ<font color=red>è¿™ä¸€æ­¥ä¼šéå† AST å¹¶è¿›è¡Œå„ç§å¢åˆ æ”¹</font>ï¼Œ<font color=LightSeaGreen>è¿™ä¸€æ­¥ä¹Ÿæ˜¯ babel æœ€æ ¸å¿ƒçš„éƒ¨åˆ†</font>ã€‚

ç»è¿‡è½¬æ¢ä»¥åçš„ AST å°±æ˜¯ç¬¦åˆè¦æ±‚çš„ä»£ç ï¼Œå°±å¯ä»¥å†è½¬å›å­—ç¬¦ä¸²ï¼Œ<font color=red>è½¬å›å­—ç¬¦ä¸²çš„è¿‡ç¨‹ä¸­æŠŠä¹‹å‰åˆ æ‰çš„ä¸€äº›åˆ†éš”ç¬¦å†åŠ å›æ¥</font>ã€‚

<font color=dodgerBlue>**ç®€å•æ€»ç»“**</font>ï¼š**ä¸ºäº†è®©è®¡ç®—æœºç†è§£ä»£ç éœ€è¦å…ˆå¯¹æºç å­—ç¬¦ä¸²è¿›è¡Œ parseï¼Œç”Ÿæˆ ASTï¼ŒæŠŠå¯¹ä»£ç çš„ä¿®æ”¹è½¬ä¸ºå¯¹ AST çš„å¢åˆ æ”¹ï¼Œè½¬æ¢å®Œ AST ä¹‹åå†æ‰“å°æˆç›®æ ‡ä»£ç å­—ç¬¦ä¸²ã€‚**

##### parseã€transformã€generate ä¸‰æ­¥åšäº†ä»€ä¹ˆ

###### parse

parse é˜¶æ®µçš„ç›®çš„æ˜¯æŠŠæºç å­—ç¬¦ä¸²è½¬æ¢æˆæœºå™¨èƒ½å¤Ÿç†è§£çš„ ASTï¼Œè¿™ä¸ªè¿‡ç¨‹<font color=fuchsia>åˆ†ä¸º **è¯æ³•åˆ†æ**ã€**è¯­æ³•åˆ†æ**</font>ã€‚

æ¯”å¦‚ `let name = 'guang';` è¿™æ ·ä¸€æ®µæºç ï¼Œæˆ‘ä»¬è¦<font color=red>å…ˆæŠŠå®ƒåˆ†æˆä¸€ä¸ªä¸ªä¸èƒ½ç»†åˆ†çš„å•è¯</font> ( token )ï¼Œä¹Ÿå°±æ˜¯ `let` , `name` , `=` , `'guang'` ï¼Œ<font color=fuchsia>è¿™ä¸ªè¿‡ç¨‹æ˜¯ **è¯æ³•åˆ†æ**</font>ï¼ŒæŒ‰ç…§å•è¯çš„æ„æˆè§„åˆ™æ¥æ‹†åˆ†å­—ç¬¦ä¸²æˆå•è¯ã€‚

ä¹‹åè¦<font color=fuchsia>æŠŠ token è¿›è¡Œé€’å½’çš„ç»„è£…ï¼Œç”Ÿæˆ AST</font>ï¼Œ<font color=fuchsia>è¿™ä¸ªè¿‡ç¨‹æ˜¯ **è¯­æ³•åˆ†æ**</font>ï¼›æŒ‰ç…§ä¸åŒçš„è¯­æ³•ç»“æ„ï¼Œæ¥æŠŠä¸€ç»„å•è¯ç»„åˆæˆå¯¹è±¡ï¼Œæ¯”å¦‚<font color=red>å£°æ˜è¯­å¥ã€èµ‹å€¼è¡¨è¾¾å¼ç­‰éƒ½æœ‰å¯¹åº”çš„ AST èŠ‚ç‚¹</font>ã€‚

<img src="https://s2.loli.net/2023/01/03/2r3SovJbGRWmuAx.png" alt="img" style="zoom:35%;" />

###### transform

transform é˜¶æ®µæ˜¯å¯¹ parse ç”Ÿæˆçš„ AST çš„å¤„ç†ï¼Œä¼š<font color=red>è¿›è¡Œ AST çš„éå†</font>ï¼Œ<font color=red>éå†çš„è¿‡ç¨‹ä¸­å¤„ç†åˆ°ä¸åŒçš„ AST èŠ‚ç‚¹ä¼š</font> <font color=fuchsia>è°ƒç”¨æ³¨å†Œçš„ **ç›¸åº”çš„ visitor å‡½æ•°**</font>ï¼Œ<font color=red>visitor å‡½æ•°é‡Œå¯ä»¥å¯¹ AST èŠ‚ç‚¹è¿›è¡Œå¢åˆ æ”¹ï¼Œè¿”å›æ–°çš„ AST</font>ï¼ˆå¯ä»¥æŒ‡å®šæ˜¯å¦ç»§ç»­éå†æ–°ç”Ÿæˆçš„ ASTï¼‰ã€‚è¿™æ ·éå†å®Œä¸€é AST ä¹‹åå°±å®Œæˆäº†å¯¹ä»£ç çš„ä¿®æ”¹ã€‚

<img src="https://s2.loli.net/2023/01/03/FkptO2ITlQL1vnA.png" alt="img" style="zoom:40%;" />

###### generate

generate é˜¶æ®µä¼šæŠŠ AST æ‰“å°æˆç›®æ ‡ä»£ç å­—ç¬¦ä¸²ï¼Œå¹¶ä¸”ä¼šç”Ÿæˆ sourcemapã€‚<font color=fuchsia>ä¸åŒçš„ AST å¯¹åº”çš„ä¸åŒç»“æ„çš„å­—ç¬¦ä¸²</font>ï¼Œæ¯”å¦‚ <font color=red>`IfStatement` å°±å¯ä»¥æ‰“å°æˆ `if (test) {}` æ ¼å¼çš„ä»£ç </font>ã€‚è¿™æ ·ä» AST æ ¹èŠ‚ç‚¹è¿›è¡Œé€’å½’çš„å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°±å¯ä»¥ç”Ÿæˆç›®æ ‡ä»£ç çš„å­—ç¬¦ä¸²ã€‚

<img src="https://s2.loli.net/2023/01/03/F2IV9cSkPGs4NfC.png" alt="img" style="zoom:35%;" />

sourcemap è®°å½•äº†æºç åˆ°ç›®æ ‡ä»£ç çš„è½¬æ¢å…³ç³»ï¼Œé€šè¿‡å®ƒæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°ç›®æ ‡ä»£ç ä¸­æ¯ä¸€ä¸ªèŠ‚ç‚¹å¯¹åº”çš„æºç ä½ç½®ï¼Œç”¨äºè°ƒè¯•çš„æ—¶å€™æŠŠç¼–è¯‘åçš„ä»£ç æ˜ å°„å›æºç ï¼Œæˆ–è€…çº¿ä¸ŠæŠ¥é”™çš„æ—¶å€™æŠŠæŠ¥é”™ä½ç½®æ˜ å°„åˆ°æºç ã€‚



#### Babel çš„ AST

AST æ˜¯å¯¹æºç çš„æŠ½è±¡ï¼Œ<font color=red>å­—é¢é‡ã€æ ‡è¯†ç¬¦ã€è¡¨è¾¾å¼ã€è¯­å¥ã€æ¨¡å—è¯­æ³•ã€class è¯­æ³•éƒ½æœ‰å„è‡ªçš„ AST</font>ã€‚

##### Literal å­—é¢é‡

`let name = 'guang'` ä¸­ï¼Œ`'guang'` å°±æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²å­—é¢é‡ StringLiteralï¼Œç›¸åº”çš„è¿˜æœ‰æ•°å­—å­—é¢é‡ NumericLiteral ï¼Œå¸ƒå°”å­—é¢é‡ BooleanLiteral ï¼Œå­—ç¬¦ä¸²å­—é¢é‡ StringLiteralï¼Œæ­£åˆ™è¡¨è¾¾å¼å­—é¢é‡ RegExpLiteral ç­‰ã€‚

ä¸‹é¢è¿™äº›å­—é¢é‡éƒ½æœ‰å¯¹åº”çš„ Literal èŠ‚ç‚¹ï¼š

<img src="https://s2.loli.net/2023/01/23/GBczVNK6COvZX4l.png" alt="" style="zoom: 33%;" />

ä»£ç ä¸­çš„å­—é¢é‡å¾ˆå¤šï¼Œbabel å°±æ˜¯é€šè¿‡ xxLiteral æ¥æŠ½è±¡è¿™éƒ¨åˆ†å†…å®¹çš„ã€‚

##### Identifier

Identifer æ˜¯æ ‡è¯†ç¬¦çš„æ„æ€ï¼Œå˜é‡åã€å±æ€§åã€å‚æ•°åç­‰å„ç§å£°æ˜å’Œå¼•ç”¨çš„åå­—ï¼Œéƒ½æ˜¯ Identiferã€‚





## PostCSS

#### å³°åå‰ç«¯çš„ã€Š13 åˆ†é’ŸæŒæ¡ PostCSSã€‹ç¬”è®°

PostCSS æ˜¯ä¸“é—¨ç”¨äºå¤„ç† CSS çš„å·¥å…·ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„æ’ä»¶æ¥ä¿®æ”¹æœ€ç»ˆæ ·å¼ï¼šå¯ä»¥è®©å¼€å‘è€…ä½¿ç”¨æœ€æ–°çš„ CSS ç‰¹æ€§ï¼ˆå“ªæ€•ææ¡ˆå¤„äº stage 0ï¼Œé…ç½®ç¤ºä¾‹ä¸‹é¢æœ‰ï¼‰æé«˜å¼€å‘æ•ˆç‡ï¼ˆé€šè¿‡ä½¿ç”¨ [PostCSS-Preset-env](https://github.com/csstools/postcss-preset-env) ã€‚ä¸è¿‡åŸåº“å·²ç» archivedï¼Œå¹¶å…¥äº† [postcss-plugins](https://github.com/csstools/postcss-plugins) ï¼‰ï¼›ä¹Ÿå¯ä»¥è½¬è¯‘ CSSï¼Œå…¼å®¹å¤§å¤šæ•°æµè§ˆå™¨ï¼ˆç±»ä¼¼äº Babel ï¼‰ï¼›PostCSS é€šè¿‡æ’ä»¶ï¼Œæ”¯æŒ Sass ä¹‹ç±» CSS é¢„å¤„ç†å·¥å…·ã€‚

ä½¿ç”¨ autoprefixer å¯ä»¥æŸ¥çœ‹å“ªäº› CSS å±æ€§ã€å€¼ã€é€‰æ‹©å™¨ã€@rules æ˜¯éœ€è¦åŠ ä¸Šæµè§ˆå™¨å‰ç¼€çš„ï¼Œä½¿ç”¨ `npx autoprefixer --info` å³å¯è¾“å‡ºå†…å®¹ï¼Œè¾“å‡ºå†…å®¹ç•¥ã€‚

ä½¿ç”¨ PostCSS å‘½ä»¤è¡Œå·¥å…· PostCSS-Cli å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œçš„æ–¹å¼è¿è¡Œ PostCSSï¼š

```sh
npx postcss input.css -o output.css -u yourPostCssPlugin
```

é€šç”¨çš„è¯­æ³•è§ [PostCSS CLI - README](https://github.com/postcss/postcss-cli) ã€‚ä¸è¿‡è¿™æ ·è¿‡äºéº»çƒ¦ï¼Œå¯ä»¥é€šè¿‡ é…ç½®æ–‡ä»¶ï¼ˆé…ç½® postcss.config.js æ–‡ä»¶ï¼‰ çš„æ–¹æ³•ï¼Œè®¾ç½® `yourPostCssPlugin` ï¼›ä½¿å¾—å³ä½¿åœ¨ä¸ä½¿ç”¨ webpack ä¹‹ç±»å·¥å…·çš„æƒ…å†µä¸‹ï¼Œè‡³å°‘ä¸éœ€è¦è¾“å…¥ `-u yourPostCssPlugin` ã€‚ä½¿ç”¨ npm script ç”šè‡³å¯ä»¥çœå»å‰é¢ï¼ˆå›ºå®šï¼‰çš„ä»£ç 

```js
// postcss.config.js
const postcssPresetEnv = require('postcss-preset-env')

module.exports = {
  plugins: [
    require('stylelint'),
    require('autoprefixer'),
    postcssPresetEnv({
      stage: 0 // å¯ä»¥ä½¿ç”¨ææ¡ˆåœ¨ stage 0 çš„æ–°ç‰¹æ€§
    }),
    require('postcss-pxtorem')
  ]
}
```

CSS ä¹Ÿæœ‰è‡ªå·±çš„ lint å·¥å…·  [stylelint](https://github.com/stylelint/stylelint) ä»¥åŠ å®ƒåŸºæœ¬çš„è§„åˆ™ [stylelint-config-standard](https://github.com/stylelint/stylelint-config-standard) ï¼›ä½¿ç”¨ stylelint åˆ›å»º `.stylelintrc.json` é…ç½®æ–‡ä»¶ï¼Œå¹¶åœ¨ postcss.config.js é…ç½®æ–‡ä»¶ä¸­æ³¨å†Œï¼ˆæ³¨å†Œè§ä¸Šé¢ï¼‰ï¼š

```json
// .stylelintrc.json
{
  "extends": "stylelint-config-standard"
}
```

åœ¨å¼€å‘æ—¶éœ€è¦å°† px è½¬æ¢ä¸º remï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ’ä»¶ [postcss-pxtorem](https://github.com/cuth/postcss-pxtorem) ç±»ä¼¼çš„æœ‰ [px2rem](https://github.com/songsiqi/px2rem)ï¼Œä¸è¿‡å‰è€… Star æ›´å¤š

å­¦ä¹ è‡ªï¼š[13 åˆ†é’ŸæŒæ¡ PostCSS](bilibili.com/video/BV1Pd4y1S7Mp)

ç›¸å…³çš„ï¼Œåœ¨ [[Vue3 + TS å­¦ä¹ ç¬”è®°#PostCSS å·¥å…·]] ä¸­ä¹Ÿæœ‰ PostCSS çš„ç¬”è®°

### Tecvanã€Šé›¶åŸºç¡€ç†è§£ PostCSS çš„ä¸»æµç¨‹ã€‹ç¬”è®°

å®˜ç½‘è¯´ï¼šâ€œPostCSSï¼Œä¸€ä¸ªä½¿ç”¨ JavaScript æ¥å¤„ç† CSS çš„æ¡†æ¶â€ ( A tool for transforming CSS with JavaScript )ã€‚è¿™å¥è¯é«˜åº¦æ¦‚æ‹¬äº† PostCSS çš„ä½œç”¨ï¼Œä½†æ˜¯å¤ªæŠ½è±¡äº†ã€‚æŒ‰æˆ‘ç†è§£ï¼ŒPostCSS ä¸»è¦åšäº†ä¸‰ä»¶äº‹ï¼š

1. **parse**ï¼š<font color=red>æŠŠ CSS æ–‡ä»¶çš„å­—ç¬¦ä¸²è§£ææˆæŠ½è±¡è¯­æ³•æ ‘ ( Abstract Syntax Tree ) çš„æ¡†æ¶</font>ï¼Œ<font color=fuchsia>è§£æè¿‡ç¨‹ä¸­ä¼šæ£€æŸ¥ CSS è¯­æ³•æ˜¯å¦æ­£ç¡®ï¼Œä¸æ­£ç¡®ä¼šç»™å‡ºé”™è¯¯æç¤º</font>ã€‚
2. **runPlugin**ï¼š<font color=fuchsia>**æ‰§è¡Œæ’ä»¶å‡½æ•°**</font>ã€‚<font color=fuchsia>**PostCSS æœ¬èº«ä¸å¤„ç†ä»»ä½•å…·ä½“ä»»åŠ¡**ï¼Œå®ƒæä¾›äº†ä»¥ç‰¹å®šå±æ€§æˆ–è€…è§„åˆ™å‘½åçš„äº‹ä»¶</font>ã€‚æœ‰ç‰¹å®šåŠŸèƒ½çš„æ’ä»¶ï¼ˆå¦‚ autoprefixerã€CSS Modules ï¼‰ä¼šæ³¨å†Œäº‹ä»¶ç›‘å¬å™¨ã€‚PostCSS ä¼šåœ¨è¿™ä¸ªé˜¶æ®µï¼Œé‡æ–°æ‰«æ ASTï¼Œæ‰§è¡Œæ³¨å†Œçš„ç›‘å¬å™¨å‡½æ•°ã€‚
3. **generate**ï¼š<font color=fuchsia>æ’ä»¶å¯¹ AST å¤„ç†åï¼ŒPostCSS æŠŠå¤„ç†è¿‡çš„ AST å¯¹è±¡è½¬æˆ CSS string</font>ã€‚

![å›¾ç‰‡](https://s2.loli.net/2022/08/11/RDNvjWZ72KdySeh.png)

<font color=red>**ã€Œå¦‚æœæ²¡æœ‰æ’ä»¶ã€**ï¼Œé‚£ä¹ˆåˆå§‹ä¼ å…¥çš„ CSS string å’Œ generate ç”Ÿæˆçš„ CSS string æ˜¯ä¸€æ ·çš„</font>ã€‚ç”±æ­¤å¯è§ï¼Œ<font color=fuchsia>PostCSS æœ¬èº«å¹¶ä¸å¤„ç†ä»»ä½•å…·ä½“çš„ä»»åŠ¡ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¸ºå…¶é™„åŠ å„ç§æ’ä»¶ä¹‹åï¼Œå®ƒæ‰å…·æœ‰å®ç”¨æ€§</font>ã€‚

ä¸‹é¢åˆ†åˆ«è¯¦ç»†åˆ†æä¸‰ä¸ªé˜¶æ®µåšçš„äº‹ã€‚

#### ç¬¬ä¸€é˜¶æ®µï¼šparse

<font color=dodgerBlue>CSS è§„åˆ™é›† ( rule-set ) ç”±é€‰æ‹©å™¨å’Œå£°æ˜å—ç»„æˆ</font>ï¼š

![å›¾ç‰‡](https://s2.loli.net/2022/08/12/Z9Dtvd1efCRGJhP.png)

- **é€‰æ‹©å™¨** æŒ‡å‘æ‚¨éœ€è¦è®¾ç½®æ ·å¼çš„ HTML å…ƒç´ 
- <font color=red>**å£°æ˜å—** åŒ…å«ä¸€æ¡æˆ–å¤šæ¡ç”¨åˆ†å·åˆ†éš”çš„å£°æ˜</font>
- æ¯æ¡ **å£°æ˜** éƒ½åŒ…å«ä¸€ä¸ª CSS å±æ€§åç§°å’Œä¸€ä¸ªå€¼ï¼Œä»¥å†’å·åˆ†éš”
- å¤šæ¡ **CSS å£°æ˜** ç”¨åˆ†å·åˆ†éš”ï¼Œå£°æ˜å—ç”¨èŠ±æ‹¬å·æ‹¬èµ·æ¥

##### äº”ç±»å¯¹è±¡

<font color=fuchsia>AST ç”¨ **äº”ç±»å¯¹è±¡** æè¿° CSS è¯­æ³•</font>ã€‚<font color=dodgerBlue>è¿™é‡Œä¸¾ä¸ªå…·ä½“çš„ä¾‹å­ï¼Œå†æ‰“å°å‡ºå¯¹åº”çš„ AST ç»“æœï¼Œ**å¯¹ç…§äº†è§£ AST äº”ç±»å¯¹è±¡å’Œ CSS è¯­æ³•çš„å¯¹åº”å…³ç³»**</font>ã€‚

`app.css` æ–‡ä»¶ä¸­å†™å¦‚ä¸‹å†…å®¹ï¼š

```css
@import url('./app-02.css');

.container {
  color: red;
}
```

##### Declaration å¯¹è±¡

<font color=fuchsia>Declaration å¯¹è±¡ç”¨æ¥ **æè¿° CSS ä¸­çš„æ¯ä¸€æ¡å£°æ˜è¯­å¥**</font>

- **type**ï¼š<font color=red>æ ‡è®°å½“å‰å¯¹è±¡çš„ç±»å‹</font>
- **parent**ï¼š<font color=red>è®°å½•çˆ¶å¯¹è±¡çš„å®ä¾‹</font>
- **prop**ï¼šè®°å½•å£°æ˜ä¸­çš„å±æ€§å
- **value**ï¼šè®°å½•å£°æ˜ä¸­çš„å€¼
- **raws**ï¼š<font color=red>å­—æ®µè®°å½•å£°æ˜å‰çš„å­—ç¬¦ä¸²ã€å£°æ˜å±æ€§å’Œå€¼ä¹‹é—´çš„ç¬¦å·çš„å­—ç¬¦ä¸²</font>
- å…¶ä½™å­—æ®µï¼ˆæ¯”å¦‚ `source` åŠå…¶å­å­—æ®µã€`Symbol(prop)` ï¼‰è§£é‡Šè§ä»£ç ä¸­çš„æ³¨é‡Š

ä¸Šè¾¹ CSS æ–‡ä»¶ä¸­çš„ `color: red;` ä¼šè¢«æè¿°æˆå¦‚ä¸‹å¯¹è±¡ï¼š

```json
{
  parent: Rule,    // å¤–å±‚çš„é€‰æ‹©å™¨è¢«è½¬è¯‘æˆ Rule å¯¹è±¡ï¼Œæ˜¯å½“å‰å£°æ˜å¯¹è±¡çš„ parent
  prop: "color",   // prop å­—æ®µè®°å½•å£°æ˜çš„å±æ€§
  raws: {          // raws å­—æ®µè®°å½•å£°æ˜å‰ã€åçš„å­—ç¬¦ä¸²ï¼Œå£°æ˜å±æ€§å’Œå€¼ä¹‹é—´çš„å­—ç¬¦ä¸²ï¼Œä»¥åŠå‰è¾¹è¯­å¥æ˜¯å¦åˆ†å·ç»“æŸã€‚
    before: '\n ', // raws.before å­—æ®µè®°å½•å£°æ˜å‰çš„å­—ç¬¦ä¸²
    between: ': ', // raws.between å­—æ®µè®°å½•å£°æ˜å±æ€§å’Œå€¼ä¹‹é—´çš„å­—ç¬¦ä¸²
  },
  source: { // source å­—æ®µè®°å½•å£°æ˜è¯­å¥çš„å¼€å§‹ã€ç»“æŸä½ç½®ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: { offset: 45, column: 3, line: 4 },
    end: { offset: 55, column: 13, line: 4 },
    input: Input {
      css: '@import url('./app-02.css');\n\n.container {\n  color: red;\n}',
      file: '/Users/admin/temp/postcss/app.css',
      hasBOM: false,
      Symbol(fromOffsetCache): [0, 29, 30, 43, 57]
    }
  },
  Symbol('isClean'): false,  // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true, // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype å±æ€§
  type: 'decl',      // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ decl
  value: "red"       // value å­—æ®µè®°å½•å£°æ˜çš„å€¼
}
```

##### Rule å¯¹è±¡

<font color=fuchsia>Rule å¯¹è±¡æ˜¯ **æè¿°é€‰æ‹©å™¨** çš„</font>

- **type**ï¼šè®°å½•å¯¹è±¡çš„ç±»å‹
- **parent**ï¼šè®°å½•çˆ¶å¯¹è±¡çš„å®ä¾‹
- **nodes**ï¼š<font color=red>è®°å½•å­å¯¹è±¡çš„å®ä¾‹</font>
- **selector**ï¼š<font color=red>è®°å½•é€‰æ‹©å™¨çš„å­—ç¬¦ä¸²</font>
- **raws**ï¼š<font color=red>è®°å½•é€‰æ‹©å™¨å‰çš„å­—ç¬¦ä¸²ã€é€‰æ‹©å™¨å’Œå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²ã€æœ€åä¸€ä¸ªå£°æ˜å’Œç»“æŸå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²</font>
- å…¶ä½™å­—æ®µè§£é‡Šè§ä»£ç ä¸­çš„æ³¨é‡Š

ä¸Šè¾¹ `app.css` æ–‡ä»¶ä¸­ `.container` ç»è¿‡ postcss è½¬è¯‘åçš„å¯¹è±¡æ˜¯ï¼ˆæ¯ä¸ªå­—æ®µçš„å«ä¹‰å’ŒåŠŸèƒ½å·²ç»ä»¥æ³¨é‡Šçš„å½¢å¼è¿›è¡Œäº†è§£é‡Šï¼‰ï¼š

```json
{
  nodes: [Declaration],  // nodes è®°å½•åŒ…å«å…³ç³»ï¼ŒRule å¯¹è±¡åŒ…å« Declaration å¯¹è±¡
  parent: Root,          // æ ¹å¯¹è±¡æ˜¯ Root å¯¹è±¡ï¼Œæ˜¯å½“å‰å£°æ˜å¯¹è±¡çš„ parent
  raws: {                // raws å­—æ®µè®°å½•å¦‚ä¸‹
    before: '\n\n',      // raws.before å­—æ®µè®°å½•é€‰æ‹©å™¨å‰çš„å­—ç¬¦ä¸²
    between: ' ',        // raws.between å­—æ®µè®°å½•é€‰æ‹©å™¨å’Œå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²
    semicolon: true,     // raws.semicolon å­—æ®µè®°å½•å‰ç½®å£°æ˜è¯­å¥æ˜¯æ­£å¸¸åˆ†å·ç»“æŸ
    after: '\n'          // raws.after å­—æ®µè®°å½•æœ€åä¸€ä¸ªå£°æ˜å’Œç»“æŸå¤§æ‹¬å·ä¹‹é—´çš„å­—ç¬¦ä¸²
  },
  selector:'.container', // selector è®°å½• selector
  source: {              // source å­—æ®µè®°å½•é€‰æ‹©å™¨è¯­å¥çš„å¼€å§‹ã€ç»“æŸä½ç½®ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: { offset: 30, column: 1, line: 3 },
    input: Input {
      css: '@import url('./app-02.css');\n\n.container {\n  color: red;\n}',
      file: '/Users/admin/temp/postcss/app.css',
      hasBOM: false,
      Symbol(fromOffsetCache): [0, 29, 30, 43, 57]
    },
    end: { offset: 57, column: 1, line: 5 }
  },
  Symbol('isClean'): false, // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true,       // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype
  type: 'rule'              // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ rule
}
```

##### AtRule å¯¹è±¡

<font color=fuchsia>CSS ä¸­é™¤äº†é€‰æ‹©å™¨ï¼Œè¿˜æœ‰ä¸€ç±»è¯­æ³•æ˜¯ `@` å¼€å¤´çš„</font>ï¼Œä¾‹å¦‚ `@import`ã€`@keyframes`ã€`@font-face`ï¼ŒPostCSS æŠŠè¿™ç±»è¯­æ³•è§£ææˆ AtRule å¯¹è±¡ã€‚ğŸ‘€ æ³¨ï¼šå®ƒæœ¬èº«çš„åå­—ä¹Ÿå« `@rules`

- **type**ï¼šè®°å½•å½“å‰å¯¹è±¡çš„ç±»å‹
- **parent**ï¼šè®°å½•å½“å‰å¯¹è±¡çš„çˆ¶å¯¹è±¡
- **name**ï¼šè®°å½• <font color=red>`@` ç´§è·Ÿç€çš„å•è¯</font>
- **params**ï¼šè®°å½• name å¯¹åº”çš„å€¼

ä¾‹å¦‚ `@import url("./app-02.css");` å°†è¢«è§£ææˆå¦‚ä¸‹å¯¹è±¡ï¼š

```json
{
  name: "import",                // name è®°å½• @ ç´§è·Ÿç€çš„å•è¯
  params: "url('./app-02.css')", // params è®°å½• name å¯¹åº”çš„å€¼
  parent: Root,                  // parent è®°å½•çˆ¶å¯¹è±¡
  raws: {                        // raws å­—æ®µè®°å½•å¦‚ä¸‹
    before: '',                  // raws.before è®°å½• @è¯­å¥å‰çš„ç©ºå­—ç¬¦ä¸²
    between: '',                 // raws.between è®°å½• name å’Œ { ä¹‹é—´çš„ç©ºå­—ç¬¦ä¸²
    afterName: '',               // raws.afterName è®°å½• name å’Œ @ è¯­å¥ä¹‹é—´çš„ç©ºå­—ç¬¦ä¸²
    after: '',                   // raws.after è®°å½•å¤§æ‹¬å·å’Œä¸Šä¸€ä¸ª rule ä¹‹é—´çš„ç©ºå­—ç¬¦ä¸²
    semicolon: false             // raws.semicolon ä¸Šä¸€ä¸ªè§„åˆ™æ˜¯å¦æ˜¯åˆ†å·ç»“æŸ
  },
  source: {                      // source å­—æ®µè®°å½•@è¯­å¥çš„å¼€å§‹ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: { offset: 0, column: 1, line: 1 },
    end: { offset: 27, column: 28, line: 1 },
    input: Input {
      css: '@import url('./app-02.css');\n\n.container {\n  color: red;\n}',
      file: '/Users/admin/temp/postcss/app.css',
      hasBOM: false,
      Symbol(fromOffsetCache): [0, 29, 30, 43, 57]
    }
  },
  Symbol('isClean'): false,  // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true,        // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype
  type: 'atrule'          // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ atrule
}
```

##### Comment å¯¹è±¡

<font color=fuchsia>CSS æ–‡ä»¶ä¸­çš„æ³¨é‡Šè¢«è§£ææˆ Comment å¯¹è±¡</font>ã€‚text å­—æ®µè®°å½•æ³¨é‡Šå†…å®¹ã€‚`/* ä½ å¥½ */  `è¢«è§£ææˆï¼š

```json
{
  parent: Root,    // parent è®°å½•çˆ¶å¯¹è±¡
  raws: {          // raws å­—æ®µè®°å½•å¦‚ä¸‹
    before: '',    // raws.before è®°å½•æ³¨é‡Šè¯­å¥å‰çš„ç©ºå­—ç¬¦ä¸²
    left: ' ',     // raws.left è®°å½•æ³¨é‡Šè¯­å¥å·¦ä¾§çš„ç©ºå­—ç¬¦ä¸²
    right: ' '     // raws.right è®°å½•æ³¨é‡Šè¯­å¥å³ä¾§çš„ç©ºå­—ç¬¦ä¸²
  },
  source: {        // source å­—æ®µè®°å½•æ³¨é‡Šè¯­å¥çš„å¼€å§‹ã€ç»“æŸä½ç½®ï¼Œä»¥åŠå½“å‰æ–‡ä»¶çš„ä¿¡æ¯
    start: {â€¦}, 
    input: Input, 
    end: {â€¦}
  },
  Symbol('isClean'): false, // Symbol(isClean) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ falseï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡å…³è”çš„ plugin æ˜¯å¦æ‰§è¡Œã€‚plugin ä¼šåœ¨åç»­è§£é‡Š
  Symbol('my'): true,       // Symbol(my) å­—æ®µé»˜è®¤å€¼éƒ½æ˜¯ trueï¼Œç”¨äºè®°å½•å½“å‰å¯¹è±¡æ˜¯å¦æ˜¯å¯¹åº”å¯¹è±¡çš„å®ä¾‹ï¼Œå¦‚æœä¸æ˜¯ï¼Œå¯ä»¥æ ¹æ®ç±»å‹æŠŠå¯¹è±¡çš„å±æ€§è®¾ç½®ä¸ºæ™®é€šå¯¹è±¡çš„ prototype
  text: 'ä½ å¥½',              // text è®°å½•æ³¨é‡Šå†…å®¹
  type: 'comment'           // type è®°å½•å¯¹è±¡ç±»å‹ï¼Œæ˜¯ä¸ªæšä¸¾å€¼ï¼Œå£°æ˜è¯­å¥çš„ type å›ºå®šæ˜¯ comment
}
```

##### å›¾è§£äº”ç±»å¯¹è±¡ä¹‹é—´çš„ç»§æ‰¿å…³ç³»

ä»ä¸Šä¸€æ®µå¯ä»¥çŸ¥é“ï¼Œ<mark>CSS è¢«è§£ææˆ Declarationã€Ruleã€Rootã€AtRuleã€Comment å¯¹è±¡</mark>ã€‚<font color=fuchsia>**è¿™äº›å¯¹è±¡æœ‰å¾ˆå¤š å…¬å…±æ–¹æ³•ï¼ŒPostCSS ç”¨äº†é¢å‘å¯¹è±¡çš„ç»§æ‰¿æ€æƒ³ï¼ŒæŠŠå…¬å…±æ–¹æ³•å’Œå…¬å…±å±æ€§æå–åˆ°äº†çˆ¶ç±»ä¸­**</font>ã€‚

<font color=fuchsia>**Rootã€Ruleã€AtRule** éƒ½æ˜¯å¯ä»¥æœ‰å­èŠ‚ç‚¹çš„</font>ï¼Œéƒ½æœ‰ nodes å±æ€§ï¼Œ<font color=fuchsia>**ä»–ä»¬ä¸‰ä¸ªç»§æ‰¿è‡ª Container ç±»**</font>ï¼Œå¯¹ nodes çš„æ“ä½œæ–¹æ³•éƒ½å†™åœ¨ Container ç±»ä¸­ã€‚

<font color=fuchsia>**Containerã€Declarationã€Comment** **ç»§æ‰¿è‡ª Node ç±»**</font>ï¼Œæ‰€æœ‰å¯¹è±¡éƒ½æœ‰ `Symbol('isClean')` ã€`Symbol('my')`ã€rawsã€sourceã€type å±æ€§ï¼Œéƒ½æœ‰ `toString()`ã€`error()` ç­‰æ–¹æ³•ï¼Œè¿™äº›å±æ€§å’Œæ–¹æ³•éƒ½å®šä¹‰åœ¨ Node ç±»ä¸­ã€‚

**Containerã€Node** æ˜¯ç”¨æ¥æå–å…¬å…±å±æ€§å’Œæ–¹æ³•ï¼Œä¸ä¼šç”Ÿæˆä»–ä»¬çš„å®ä¾‹ã€‚

<font color=dodgerBlue>äº”ä¸ªç±»ä¹‹é—´çš„ç»§æ‰¿å…³ç³»å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</font>

![Image](https://s2.loli.net/2022/08/12/c6po81SKtVYMnXv.png)

å›¾ä¸­æ²¡æœ‰ç©·ä¸¾ç±»çš„æ–¹æ³•ï¼Œå…¨éƒ¨çš„æ–¹æ³• å¯ä»¥çœ‹ç›´æ¥çœ‹æºç æ–‡ä»¶: https://github.com/postcss/postcss/tree/main/lib

#### ç¬¬äºŒé˜¶æ®µï¼šrunPlugin

<mark>PostCSS æœ¬èº«å¹¶ä¸å¤„ç†ä»»ä½•å…·ä½“çš„ä»»åŠ¡ï¼Œåªæœ‰å½“æˆ‘ä»¬ä¸ºå…¶é™„åŠ å„ç§æ’ä»¶ä¹‹åï¼Œå®ƒæ‰å…·æœ‰å®ç”¨æ€§</mark>ã€‚

<font color=fuchsia>PostCSS åœ¨æŠŠ CSS string è§£ææˆ AST å¯¹è±¡åï¼Œä¼šæ‰«æä¸€è¾¹ AST å¯¹è±¡</font>ï¼Œ<font color=fuchsia>**æ¯ä¸€ç§ AST çš„å¯¹è±¡éƒ½å¯ä»¥æœ‰å¯¹åº”çš„ç›‘å¬å™¨**</font>ã€‚<font color=red>åœ¨éå†åˆ°æŸç±»å‹çš„å¯¹è±¡æ—¶ï¼Œå¦‚æœæœ‰å¯¹è±¡çš„ç›‘å¬å™¨ï¼Œå°±ä¼šæ‰§è¡Œå…¶ç›‘å¬å™¨ã€‚

##### ç¬¬ä¸€ç±»ç›‘å¬å™¨

PostCSS æä¾›çš„**ã€Œä»¥ç‰¹å®šå±æ€§æˆ–è€…è§„åˆ™å‘½åã€**çš„äº‹ä»¶ç›‘å¬å™¨ï¼Œå¦‚ä¸‹ï¼š

> CHILDREN ä»£è¡¨å­èŠ‚ç‚¹çš„äº‹ä»¶ç›‘å¬å™¨ã€‚

```js
// root
['Root', CHILDREN, 'RootExit']

// AtRule
['AtRule', 'AtRule-import', CHILDREN, 'AtRuleExit', 'AtRuleExit-import']

// Rule
['Rule', CHILDREN, 'RuleExit']

// Declaration
['Declaration', 'Declaration-color', 'DeclarationExit', 'DeclarationExit-color']

// Comment
['Comment', 'CommentExit']
```

PostCSS ä»¥ <font color=fuchsia size=4>**æ·±åº¦ä¼˜å…ˆ** çš„æ–¹å¼éå† AST æ ‘</font>ã€‚

- <mark style="background: lightpink">**éå†åˆ° Root æ ¹å¯¹è±¡**ï¼Œ**ç¬¬ä¸€æ­¥** ä¼šæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ Root äº‹ä»¶ç›‘å¬å™¨ï¼Œ**ç¬¬äºŒæ­¥** æ£€æŸ¥ Root æ˜¯å¦æœ‰å­å¯¹è±¡ï¼Œå¦‚æœæœ‰ï¼Œåˆ™éå†å­å¯¹è±¡ï¼Œæ‰§è¡Œå­å¯¹è±¡å¯¹åº”çš„äº‹ä»¶ç›‘å¬å™¨ï¼›å¦‚æœæ²¡æœ‰å­å¯¹è±¡ï¼Œåˆ™ç›´æ¥è¿›å…¥ç¬¬ä¸‰æ­¥ï¼›**ç¬¬ä¸‰æ­¥** ä¼šæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ RootExit äº‹ä»¶ç›‘å¬å™¨</mark> ï¼ˆğŸ‘€ æ³¨ï¼šè¿™å°±æ˜¯ DFS çš„æ­¥éª¤ï¼‰ã€‚

  <font color=red>æ’ä»¶æ³¨å†Œçš„ Rootã€RootExit äº‹ä»¶çš„ç›‘å¬å™¨ **åªèƒ½æ˜¯å‡½æ•°**</font>ã€‚å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å½“å‰è®¿é—®çš„ AST çš„ Root å¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯ postcss çš„ Result å¯¹è±¡å’Œä¸€äº›å…¶ä»–å±æ€§ï¼Œé€šè¿‡ Result å¯¹è±¡å¯ä»¥è·å– css stringã€opts ç­‰ä¿¡æ¯ã€‚

  ```js
  {
    Root: (rootNode, helps) => {},
    RootExit: (rootNode, helps) => {}
  }
  ```

- **éå†åˆ° Rule å¯¹è±¡**ï¼Œåˆ™<mark style="background: lightpink">å’Œè®¿é—® Root æ ¹å¯¹è±¡æ˜¯ä¸€æ ·çš„é€»è¾‘</mark>ï¼Œå…ˆæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ Rule äº‹ä»¶ç›‘å¬å™¨ï¼Œå†éå†å­å¯¹è±¡ï¼Œæœ€åæ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ RuleExit äº‹ä»¶ç›‘å¬å™¨ã€‚<font color=red>æ’ä»¶æ³¨å†Œçš„ Ruleã€RuleExit äº‹ä»¶çš„ç›‘å¬å™¨ **åªèƒ½æ˜¯å‡½æ•°**</font>ã€‚

  ```js
  {
    Rule: (ruleNode, helps) => {},
    RuleExit: (ruleNode, helps) => {}
  }
  ```

- **éå†åˆ° AtRule å¯¹è±¡**ã€‚<font color=red>æ’ä»¶æ³¨å†Œçš„ AtRule çš„äº‹ä»¶ç›‘å¬å™¨ **å¯ä»¥æ˜¯å‡½æ•°**ï¼Œ**ä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡**</font>ã€‚å¯¹è±¡ç±»å‹çš„ç›‘å¬å™¨ï¼Œå¯¹è±¡å±æ€§çš„ key æ˜¯ AtRule å¯¹è±¡çš„ name å€¼ï¼Œvalue æ˜¯å‡½æ•°ã€‚<mark style="background: lightpink">AtRuleExit æ˜¯ä¸€æ ·çš„é€»è¾‘</mark>ã€‚<font color=fuchsia>äº‹ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š`['AtRule', 'AtRule-import', CHILDREN, 'AtRuleExit', 'AtRuleExit-import']` </font>ã€‚CHILDREN ä»£è¡¨å­èŠ‚ç‚¹çš„äº‹ä»¶ã€‚

  ```js
   // å‡½æ•°
  { 
    AtRule: (atRuleNode, helps) => {}
  }
  
  // å¯¹è±¡
  {
    AtRule: {
      import: (atRuleNode, helps) => {},
      keyframes: (atRuleNode, helps) => {}
    }
  }
  ```

- **éå†åˆ° Declaration å¯¹è±¡**ã€‚<font color=red>æ’ä»¶æ³¨å†Œçš„ Declaration çš„äº‹ä»¶ç›‘å¬å™¨ **å¯ä»¥æ˜¯å‡½æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯¹è±¡**</font>ï¼Œå¯¹è±¡å±æ€§çš„ key æ˜¯ Declaration å¯¹è±¡çš„ prop å€¼ï¼Œvalue æ˜¯å‡½æ•°ã€‚<mark style="background: lightpink">DeclarationExitExit æ˜¯ä¸€æ ·çš„é€»è¾‘</mark>ã€‚<font color=fuchsia>äº‹ä»¶çš„æ‰§è¡Œé¡ºåºæ˜¯ï¼š`['Declaration', 'Declaration-color', 'DeclarationExit', 'DeclarationExit-color']`</font> ã€‚**Declaration æ²¡æœ‰å­å¯¹è±¡ï¼Œåªéœ€è¦æ‰§è¡Œå½“å‰å¯¹è±¡çš„äº‹ä»¶ï¼Œä¸éœ€è¦æ·±åº¦æ‰§è¡Œå­å¯¹è±¡çš„äº‹ä»¶**ã€‚

  ```js
  // å‡½æ•°
  {
    Declaration: (declarationNode, helps) => {}
  }
  
  // å¯¹è±¡
  {
    Declaration: {
      color: (declarationNode, helps) => {},
      border: (declarationNode, helps) => {}
    }
  }
  ```

- **éå†åˆ° Comment å¯¹è±¡**ã€‚ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ Comment äº‹ä»¶ç›‘å¬å™¨ï¼Œå†æ‰§è¡Œæ‰€æœ‰æ’ä»¶æ³¨å†Œçš„ CommentExit äº‹ä»¶ç›‘å¬å™¨ã€‚

##### ç¬¬äºŒç±»ç›‘å¬å™¨

<font color=dodgerBlue>é™¤ä»¥ç‰¹å®šå±æ€§æˆ–è€…è§„åˆ™å‘½åçš„äº‹ä»¶ç›‘å¬å™¨ï¼Œ**PostCSS è¿˜æœ‰ä»¥ä¸‹å››ä¸ª**</font>ï¼ˆğŸ‘€ æ³¨ï¼šä¸‰ä¸ªæ–¹æ³•ï¼Œä¸€ä¸ªæ’ä»¶åç§°ï¼‰ï¼š

```js
{
  postcssPlugin: string,
  prepare: (result) => {},
  Once: (root, helps) => {},
  OnceExit: (root, helps) => {},
}
```

PostCSS æ’ä»¶äº‹ä»¶çš„æ•´ä½“æ‰§è¡Œæ˜¯ï¼š`[prepare, Once, ...ä¸€ç±»äº‹ä»¶, OnceExit]`ï¼Œ<font color=red>**postcssPlugin æ˜¯æ’ä»¶åç§°**</font>ï¼Œä¸æ˜¯äº‹ä»¶ç›‘å¬å™¨ã€‚

- **postcssPlugin**ï¼šå­—ç¬¦ä¸²ç±»å‹ï¼Œ<font color=red>æ’ä»¶çš„åå­—ï¼Œåœ¨æ’ä»¶æ‰§è¡ŒæŠ¥é”™ï¼Œæç¤ºç”¨æˆ·æ˜¯å“ªä¸ªæ’ä»¶æŠ¥é”™äº†</font>ã€‚

- **prepare**ï¼šå‡½æ•°ç±»å‹ï¼Œ<font color=red>prepare æ˜¯æœ€å…ˆæ‰§è¡Œçš„ï¼Œåœ¨æ‰€æœ‰äº‹ä»¶æ‰§è¡Œå‰æ‰§è¡Œçš„</font>ï¼Œæ’ä»¶å¤šä¸ªç›‘å¬å™¨é—´å…±äº«æ•°æ®æ—¶ä½¿ç”¨ã€‚prepare çš„å…¥å‚æ˜¯ Result å¯¹è±¡ï¼Œè¿”å›å€¼æ˜¯ç›‘å¬å™¨å¯¹è±¡ï¼Œé€šè¿‡ Result å¯¹è±¡å¯ä»¥è·å– css stringã€opts ç­‰ä¿¡æ¯ã€‚

  ```js
  {
    postcssPlugin: "PLUGIN NAME",
    prepare(result) {
      const variables = {};
      return {
        Declaration(node) {
          if (node.variable) {
            variables[node.prop] = node.value;
          }
        },
        OnceExit() {
          console.log(variables);
        },
      };
    },
  };
  ```

- **Once**ï¼šå‡½æ•°ç±»å‹ï¼Œ<font color=red>åœ¨ prepare åï¼Œä¸€ç±»äº‹ä»¶å‰æ‰§è¡Œ</font>ï¼ŒOnce <font color=red>åªä¼šæ‰§è¡Œä¸€æ¬¡</font>ã€‚

  ```js
  {
     Once: (root, helps) => {}
  }
  ```

- **OnceExit**ï¼šå‡½æ•°ç±»å‹ï¼Œ<font color=red>åœ¨ä¸€ç±»äº‹ä»¶åæ‰§è¡Œ</font>ï¼ŒOnceExit <font color=red>åªä¼šæ‰§è¡Œä¸€æ¬¡</font>ã€‚

**æ’ä»¶æœ‰å“ªäº›ï¼Ÿ**

[postcss Github - docs - PostCSS plugins](https://github.com/postcss/postcss/blob/main/docs/plugins.md) åˆ—å‡ºäº†å¤§é‡çš„ postcss pluginï¼Œå°±ç›¸å½“äº postcss awesome

#### ç¬¬ä¸‰é˜¶æ®µï¼šgenerate

generate çš„è¿‡ç¨‹<font color=fuchsia>ä¾æ—§æ˜¯ä»¥æ·±åº¦ä¼˜å…ˆçš„æ–¹å¼éå† AST å¯¹è±¡ï¼Œ**é’ˆå¯¹ä¸åŒçš„å®ä¾‹å¯¹è±¡è¿›è¡Œå­—ç¬¦ä¸²çš„æ‹¼æ¥**</font>ã€‚ç®—æ³•å¯¹åº”æºç ä¸­ä½ç½®æ˜¯ï¼š`postcss/lib/stringifier.js` ä¸­çš„ `stringify ` æ–¹æ³•ï¼Œä»£ç é‡ä¸å¤§ï¼Œå¯è‡ªè¡ŒæŸ¥çœ‹ã€‚

æ‘˜è‡ªï¼š[é›¶åŸºç¡€ç†è§£ PostCSS çš„ä¸»æµç¨‹](https://mp.weixin.qq.com/s/Bkss0lzPT-TI6GyGxMyn3Q)



## npm & package.json



#### æŒ‡å®šé¡¹ç›®è¿è¡Œçš„ç³»ç»Ÿç¯å¢ƒ

> ğŸ‘€ ç›¸å…³å†…å®¹å¯ä»¥å‚è€ƒ [npm doc - version 8 - package.json](https://docs.npmjs.com/cli/v8/configuring-npm/package-json)

##### æŒ‡å®š é¡¹ç›®è¿è¡Œçš„ Node ç‰ˆæœ¬

å¦‚ä½•æŒ‡å®šé¡¹ç›®è¿è¡Œçš„ Node ç‰ˆæœ¬ï¼Œå¯ä»¥åœ¨ package.json ä¸­é…ç½® `engines` é€‰é¡¹ï¼›å¦‚ä¸‹ç¤ºä¾‹ï¼š

```json
{
  "engines": {
    "node": ">=0.10.3 <15"
  }
}
```

##### æŒ‡å®š é¡¹ç›®è¿è¡Œçš„ OS å’Œ CPU ç‰ˆæœ¬

```json
{
  "os": [
    "darwin",
    "linux"
  ],
  "cpu": [
    "x64",
    "ia32"
  ]
}
```

æ‘˜è‡ªï¼š[npm doc - version 8 - package.json](https://docs.npmjs.com/cli/v8/configuring-npm/package-json)



##### ä¿®æ”¹ node_modules ä¾èµ–ä»£ç 

æƒ³è¦ä¿®æ”¹ node_modules ä¸­ä¾èµ–éƒ¨åˆ†çš„ä»£ç ï¼ˆæ¯”å¦‚è¯´ï¼šå­˜åœ¨ bugï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ [patch-package](https://github.com/ds300/patch-package) ï¼Œè¿™ä¸ªå¯ä»¥è¯´æ˜¯å½“å‰çš„ æœ€ä½³å®è·µã€‚

> **About**
>
> Fix broken node modules instantly ğŸƒğŸ½â€â™€ï¸ğŸ’¨



### corepack

##### ç®€è¦ä»‹ç»

As per [Node.js](https://nodejs.org/api/corepack.html) documentation, the corepack <font color=red>identifies the package manager</font> and <font color=red>installs in the background if needed without any user interaction</font>.

æ‘˜è‡ªï¼š[How to Configure a React App with TypeScript, TailwindCSS, Yarn and Storybook](https://blog.bitsrc.io/how-to-configure-a-react-app-with-typescript-tailwindcss-yarn-and-storybook-a271df5d9884)

##### What's Corepack

Corepack <font color=red>makes sure you are using the correct version for package manager</font> when you run corresponding commands. <font color=red>Projects might have `packageManager` field in their `package.json`</font> .

Under projects with configuration as shown on the rightï¼ˆ ğŸ‘€ ç°åœ¨æ˜¯ below äº† ï¼‰, <font color=red>corepack will install `v7.1.5` of `pnpm` (if you don't have it already)</font> and use it to run your commands. <font color=fuchsia>This makes sure everyone working on this project have the same behavior for the dependencies and the lockfile</font>.

```json
// package.json
{
  "packageManager": "pnpm@7.1.5"
}
```

æ‘˜è‡ªï¼š[GitHub - antfu/contribute](https://github.com/antfu/contribute)

#### Node Doc Intro

> ğŸ’¡ Added in: v16.9.0, v14.19.0

##### ç®€ä»‹

*[Corepack](https://github.com/nodejs/corepack)* is an <font color=red>experimental tool</font> to help with managing versions of your package managers. It <font color=fuchsia>exposes **binary proxies**</font>ï¼ˆğŸ‘€ æœ¬è´¨ä¸Šæ˜¯ åŒ…ç®¡ç†å·¥å…·çš„ äºŒè¿›åˆ¶**ä»£ç†** ï¼‰<font color=fuchsia>for each supported package manager</font>ï¼ˆ ğŸ‘€ ç›®å‰æ˜¯ pnpm å’Œ yarn ï¼‰ that, when called, will identify whatever package manager is configured for the current project, <font color=fuchsia>transparently install it if needed</font>, and finally <font color=fuchsia>run it without requiring explicit user interactions</font>.

<font color=dodgerBlue>This feature simplifies two core workflows:</font>

- <font color=LightSeaGreen>It eases new contributor onboarding</font>ï¼ˆåŠ å…¥ï¼‰, since they won't have to follow system-specific installation processes anymore just to have the package manager you want them to.
- It allows you to <font color=LightSeaGreen>ensure that everyone in your team will **use exactly the package manager version** you intend them to</font>, without them having to manually synchronize it each time you need to make an update.

##### Workflows

###### Enabling the feature

<font color=dodgerBlue>Due to its experimental status</font>, Corepack currently needs to be explicitly enabled to have any effect. To do that, <font color=red>run `corepack enable`</font> , which <font color=red>will set up the symlinks in your environment next to the `node` binary</font> (and overwrite the existing symlinks if necessary).

From this point forward, any call to the *supported binaries*ï¼ˆğŸ‘€ å³ supported package manager ï¼‰ will work without further setup. Should you experience a problem, <font color=red>run `corepack disable` to remove the proxies from your system</font> (and consider opening an issue on the [Corepack repository](https://github.com/nodejs/corepack) to let us know).

###### Configuring a package

The <font color=fuchsia>Corepack proxies will find the closest `package.json` file in your current directory hierarchy</font> to <font color=fuchsia>extract its `"packageManager"` property</font>.

If the value corresponds to a *supported package manager*, Corepack will make sure that all calls to the relevant binaries are run against the requested version, downloading it on demand if needed, and aborting if it cannot be successfully retrieved.

###### Upgrading the global versions

When running outside of an existing project (for example when running `yarn init` ) , <font color=red>Corepack will **by default** use predefined versions roughly corresponding to the latest stable releases from each tool</font>. <font color=fuchsia>Those versions can be overridden by running the `corepack prepare` command</font> along with the package manager version you wish to set:

```bash
corepack prepare yarn@x.y.z --activate
```

Alternately, a tag or range may be used:

```bash
corepack prepare pnpm@latest --activate
corepack prepare yarn@stable --activate
```

æ‘˜è‡ªï¼š[Node Doc - Corepack](https://nodejs.org/api/corepack.html)
